from header_common import *
from header_operations import *
from module_constants import *
from header_parties import *
from header_skills import *

####################################################################################################################
# scripts is a list of script records.
# Each script record contns the following two fields:
# 1) Script id: The prefix "script_" will be inserted when referencing scripts.
# 2) Operation block: This must be a valid operation block. See header_operations.py for reference. 
####################################################################################################################

scripts = [

#script_party_calculate_regular_strength
("party_calculate_regular_strength",[
(store_script_param_1, ":party"),
(assign, 2, reg0),
(party_get_num_companion_stacks, ":local1", ":party"),
(try_for_range, ":local2", 0, ":local1"),
    (party_stack_get_troop_id, ":local3", ":party", ":local2"),
    (store_character_level, ":local4", ":local3"),
    (val_add, ":local4", 5),
    (neg|troop_is_hero, ":local3"),
    (party_stack_get_size, ":local5", ":party", ":local2"),
    (party_stack_get_num_wounded, ":local6", ":party", ":local2"),
    (val_sub, ":local5", ":local6"),
    (val_mul, ":local4", ":local5"),
    (val_add, reg0, ":local4"),
(try_end),
]), 

#script_party_calculate_strength
("party_calculate_strength",[
(store_script_param_1, ":party"),
(assign, reg0, 0),
(party_get_num_companion_stacks, ":local1", ":party"),
(try_for_range, ":local2", 0, ":local1"),
    (party_stack_get_troop_id, ":local3", ":party", ":local2"),
    (store_character_level, ":local4", ":local3"),
    (val_add, ":local4", 5),
    (try_begin),
        (neg|troop_is_hero, ":local3"),
        (party_stack_get_size, ":local5", ":party", ":local2"),
        (party_stack_get_num_wounded, ":local6", ":party", ":local2"),
        (val_sub, ":local5", ":local6"),
        (val_mul, ":local4", ":local5"),
    (try_end),
    (val_add, reg0, ":local4"),
(try_end),
]), 

#script_party_calculate_loot
("party_calculate_loot",[
(store_script_param_1, ":party"),
(store_script_param_2, ":local1"),
(call_script, "script_calculate_party_shares", ":local1", 0),
(assign, ":local2", reg0),
(assign, ":local3", reg1),
(store_add, ":local4", ":local2", ":local3"),
(assign, ":local4", 10),
(assign, ":local5", 100),
(val_mul, ":local5", 10),
(val_div, ":local5", ":local4"),
(party_get_num_companion_stacks, ":local6", ":party"),
(try_for_range, ":local7", 0, ":local6"),
    (party_stack_get_troop_id, ":local8", ":party", ":local7"),
    (neg|troop_is_hero, ":local8"),
    (party_stack_get_size, ":local9", ":party", ":local7"),
    (try_for_range, ":local10", 0, ":local9"),
        (troop_loot_troop, "trp_temp_troop", ":local8", ":local5"),
    (try_end),
(try_end),
(assign, ":local11", 0),
(troop_get_inventory_capacity, ":local12", "trp_temp_troop"),
(try_for_range, ":local13", 0, ":local12"),
    (troop_get_inventory_slot, ":local14", "trp_temp_troop", ":local13"),
    (ge, ":local14", 0),
    (val_add, ":local11", 1),
(try_end),
(assign, reg0, ":local11"),
]), 

#script_calculate_party_shares
("calculate_party_shares",[
(store_script_param_1, ":party"),
(assign, ":local1", 10),
(party_get_num_companion_stacks, ":local2", "p_main_party"),
(try_for_range, ":local3", 1, ":local2"),
    (party_stack_get_troop_id, ":local4", "p_main_party", ":local3"),
    (try_begin),
        (neg|troop_is_hero, ":local4"),
        (party_stack_get_size, ":local5", "p_main_party", ":local3"),
        (val_add, ":local1", ":local5"),
        (else_try),
        (val_add, ":local1", 10),
    (try_end),
(try_end),
(assign, ":local6", 0),
(try_begin),
    (gt, ":party", 0),
    (assign, ":local6", 10),
    (party_get_num_companion_stacks, ":local2", ":party"),
    (try_for_range, ":local3", 1, ":local2"),
        (party_stack_get_troop_id, ":local4", ":party", ":local3"),
        (try_begin),
            (neg|troop_is_hero, ":local4"),
            (party_stack_get_size, ":local5", ":party", ":local3"),
            (val_add, ":local6", ":local5"),
            (else_try),
            (val_add, ":local6", 10),
        (try_end),
    (try_end),
(try_end),
(assign, reg0, ":local1"),
(assign, reg1, ":local6"),
]), 

#script_party_give_xp_and_gold
("party_give_xp_and_gold",[
(store_script_param_1, ":party"),
(store_script_param_2, ":local1"),
(call_script, "script_calculate_party_shares", ":local1", 0),
(assign, ":local2", reg0),
(assign, ":local3", reg1),
(store_add, ":local4", ":local2", ":local3"),
(assign, ":local5", 0),
(party_get_num_companion_stacks, ":local6", ":party"),
(try_for_range, ":local7", 0, ":local6"),
    (party_stack_get_troop_id, ":local8", ":party", ":local7"),
    (neg|troop_is_hero, ":local8"),
    (party_stack_get_size, ":local9", ":party", ":local7"),
    (store_character_level, ":local10", ":local8"),
    (store_add, ":local11", ":local10", 10),
    (val_mul, ":local11", ":local11"),
    (val_div, ":local11", 10),
    (store_mul, ":local12", ":local11", ":local9"),
    (val_add, ":local5", ":local12"),
(try_end),
(store_mul, ":local13", ":local5", ":local2"),
(val_div, ":local13", ":local4"),
(store_random_in_range, ":local14", 0, 100),
(val_mul, ":local13", ":local14"),
(val_div, ":local13", 100),
(party_add_xp, "p_main_party", ":local13"),
(store_mul, ":local15", ":local5", 10),
(val_div, ":local15", ":local4"),
(store_random_in_range, ":local14", 0, 100),
(val_mul, ":local15", ":local14"),
(val_div, ":local15", 100),
(val_div, ":local15", 5),
(party_get_num_companion_stacks, ":local6", "p_main_party"),
(try_for_range, ":local7", 0, ":local6"),
    (party_stack_get_troop_id, ":local8", "p_main_party", ":local7"),
    (try_begin),
        (troop_is_hero, ":local8"),
        (troop_add_gold, ":local8", ":local15"),
    (try_end),
(try_end),
]), 

#script_setup_troop_meeting
("setup_troop_meeting",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(modify_visitors_at_site, "scn_conversation_scene"),
(reset_visitors),
(set_visitor, 0, "trp_player", 0),
(set_visitor, 17, ":local0", ":local1"),
(set_jump_mission, "mst_conversation_encounter"),
(jump_to_scene, "scn_conversation_scene", 0),
(change_screen_map_conversation),
]), 

#script_setup_party_meeting
("setup_party_meeting",[
(store_script_param_1, ":local0"),
(modify_visitors_at_site, "scn_conversation_scene"),
(reset_visitors),
(set_visitor, 0, "trp_player", 0),
(party_stack_get_troop_id, ":local1", ":local0", 0),
(party_stack_get_troop_dna, ":local2", ":local0", 0),
(set_visitor, 17, ":local1", ":local2"),
(set_jump_mission, "mst_conversation_encounter"),
(jump_to_scene, "scn_conversation_scene", 0),
(change_screen_map_conversation),
]), 

#script_party_remove_all_companions
("party_remove_all_companions",[
(store_script_param_1, ":local0"),
(party_get_num_companion_stacks, ":local1", ":local0"),
    (try_for_range_backwards, ":local2", 0, ":local1"),
    (party_stack_get_troop_id, ":local3", ":local0", ":local2"),
    (this_or_next|neg|troop_is_hero, ":local3"),
    (eq, "$g_move_heroes", 1),
    (party_stack_get_size, ":local4", ":local0", ":local2"),
    (party_remove_members, ":local0", ":local3", ":local4"),
(try_end),
]), 

#script_party_remove_all_prisoners
("party_remove_all_prisoners",[
(store_script_param_1, ":local0"),
(party_get_num_prisoner_stacks, ":local1", ":local0"),
    (try_for_range_backwards, ":local2", 0, ":local1"),
    (party_prisoner_stack_get_troop_id, ":local3", ":local0", ":local2"),
    (this_or_next|neg|troop_is_hero, ":local3"),
    (eq, "$g_move_heroes", 1),
    (party_prisoner_stack_get_size, ":local4", ":local0", ":local2"),
    (party_remove_prisoners, ":local0", ":local3", ":local4"),
(try_end),
]), 

#script_party_add_party_companions
("party_add_party_companions",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(party_get_num_companion_stacks, ":local2", ":local1"),
    (try_for_range, ":local3", 0, ":local2"),
    (party_stack_get_troop_id, ":local4", ":local1", ":local3"),
    (this_or_next|neg|troop_is_hero, ":local4"),
    (eq, "$g_move_heroes", 1),
    (party_stack_get_size, ":local5", ":local1", ":local3"),
    (party_add_members, ":local0", ":local4", ":local5"),
(try_end),
]), 

#script_party_add_party_prisoners
("party_add_party_prisoners",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(party_get_num_prisoner_stacks, ":local2", ":local1"),
    (try_for_range, ":local3", 0, ":local2"),
    (party_prisoner_stack_get_troop_id, ":local4", ":local1", ":local3"),
    (this_or_next|neg|troop_is_hero, ":local4"),
    (eq, "$g_move_heroes", 1),
    (party_prisoner_stack_get_size, ":local5", ":local1", ":local3"),
    (party_add_members, ":local0", ":local4", ":local5"),
(try_end),
]), 

#script_party_prisoners_add_party_companions
("party_prisoners_add_party_companions",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(party_get_num_companion_stacks, ":local2", ":local1"),
    (try_for_range, ":local3", 0, ":local2"),
    (party_stack_get_troop_id, ":local4", ":local1", ":local3"),
    (this_or_next|neg|troop_is_hero, ":local4"),
    (eq, "$g_move_heroes", 1),
    (neg|is_between, ":local4", "trp_lothlorien_scout", "trp_dunedain_youth"),
    (neg|is_between, ":local4", "trp_orc_snaga_of_isengard", "trp_end_orc_uruk_troll"),
        (try_begin),
        (neg|eq, "$map_hero_present_in_battle", 1),
        (is_between, ":local4", "trp_map_heroes_begin", "trp_map_heroes_end"),
        (call_script, "script_capture_host_leaders", ":local4", 0),
    (try_end),
    (this_or_next|neg|is_between, ":local4", "trp_map_heroes_begin", "trp_map_heroes_end"),
    (eq, "$map_hero_present_in_battle", 1),
    (party_stack_get_size, ":local5", ":local1", ":local3"),
    (party_add_prisoners, ":local0", ":local4", ":local5"),
(try_end),
]), 

#script_party_prisoners_add_party_prisoners
("party_prisoners_add_party_prisoners",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(party_get_num_prisoner_stacks, ":local2", ":local1"),
    (try_for_range, ":local3", 0, ":local2"),
    (party_prisoner_stack_get_troop_id, ":local4", ":local1", ":local3"),
    (this_or_next|neg|troop_is_hero, ":local4"),
    (eq, "$g_move_heroes", 1),
    (party_prisoner_stack_get_size, ":local5", ":local1", ":local3"),
    (party_add_prisoners, ":local0", ":local4", ":local5"),
(try_end),
]), 

#script_party_add_party
("party_add_party",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(call_script, "script_party_add_party_companions", ":local0", ":local1"),
(call_script, "script_party_prisoners_add_party_prisoners", ":local0", ":local1"),
]), 

#script_party_copy
("party_copy",[
(assign, "$map_hero_present_in_battle", 1),
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(party_clear, ":local0"),
(call_script, "script_party_add_party", ":local0", ":local1"),
]), 

#script_clear_party_group
("clear_party_group",[
(store_script_param_1, ":local0"),
(party_clear, ":local0"),
(party_get_num_attached_parties, ":local1", ":local0"),
(try_for_range, ":local2", 0, ":local1"),
    (party_get_attached_party, ":local3", ":local0", ":local2"),
    (call_script, "script_clear_party_group", ":local3", 0),
(try_end),
]), 

#script_get_nonempty_party_in_group
("get_nonempty_party_in_group",[
(store_script_param_1, ":local0"),
(party_get_num_companions, ":local1", ":local0"),
(try_begin),
    (gt, ":local1", 0),
    (assign, reg0, ":local0"),
  (else_try),
    (assign, reg0, -1),
    (party_get_num_attached_parties, ":local2", ":local0"),
    (try_for_range, ":local3", 0, ":local2"),
        (neg|ge, reg0, 0),
        (party_get_attached_party, ":local4", ":local0", ":local3"),
        (call_script, "script_get_nonempty_party_in_group", ":local4", 0),
    (try_end),
(try_end),
]), 

#script_collect_prisoners_from_empty_parties
("collect_prisoners_from_empty_parties",[
(store_script_param_1, ":local0"),
(store_script_param_1, ":local1"),
(party_get_num_companions, ":local2", ":local0"),
(try_begin),
    (eq, ":local2", 0),
    (party_get_num_prisoner_stacks, ":local3", ":local0"),
    (try_for_range, ":local4", 0, ":local3"),
        (party_prisoner_stack_get_troop_id, ":local5", ":local0", ":local4"),
        (troop_is_hero, ":local5"),
        (party_add_members, ":local1", ":local5", 1),
    (try_end),
(try_end),
(party_get_num_attached_parties, ":local6", ":local0"),
(try_for_range, ":local7", 0, ":local6"),
    (party_get_attached_party, ":local8", ":local0", ":local7"),
    (call_script, "script_collect_prisoners_from_empty_parties", ":local8", ":local1"),
(try_end),
]), 

#script_print_casualties_to_s0
("print_casualties_to_s0",[
(store_script_param_1, ":local0"),
(party_get_num_companion_stacks, ":local1", ":local0"),
(store_sub, ":local2", ":local1", 1),
(str_store_string, 62, "str_none"),
(try_for_range, ":local3", 0, ":local1"),
    (party_stack_get_troop_id, ":local4", ":local0", ":local3"),
    (party_stack_get_size, ":local5", ":local0", ":local3"),
    (party_stack_get_num_wounded, ":local6", ":local0", ":local3"),
    (store_sub, ":local7", ":local5", ":local6"),
    (str_store_troop_name_by_count, 61, ":local4", ":local5"),
    (try_begin),
        (troop_is_hero, ":local4"),
        (str_store_string_reg, 63, 61),
        (else_try),
        (assign, reg60, ":local5"),
        (str_store_string, 63, "str_reg60_s61"),
    (try_end),
    (assign, reg60, ":local6"),
    (str_store_string, 50, "str_reg60_wounded"),
    (assign, reg60, ":local7"),
    (str_store_string, 51, "str_reg60_killed"),
    (try_begin),
        (eq, ":local6", 0),
        (str_store_string, 58, "str_parenthesis_killed"),
        (else_try),
        (eq, ":local7", 0),
        (str_store_string, 58, "str_parenthesis_wounded"),
        (else_try),
        (str_store_string, 58, "str_parenthesis_s50_comma_s51"),
    (try_end),
    (str_store_string_reg, 50, 63),
    (str_store_string_reg, 51, 58),
    (str_store_string, 51, "str_s50_s51"),
    (try_begin),
        (eq, ":local3", 0),
        (str_store_string_reg, 62, 51),
        (else_try),
        (eq, ":local3", ":local2"),
        (str_store_string_reg, 50, 62),
        (str_store_string, 62, "str_s50_comma_s51"),
        (else_try),
        (str_store_string_reg, 50, 62),
        (str_store_string, 62, "str_s50_comma_s51"),
    (try_end),
(try_end),
(try_begin),
    (eq, ":local1", 0),
    (str_store_string, 62, "str_none"),
(try_end),
(str_store_string_reg, 0, 62),
]), 

#script_print_party_to_s0
("print_party_to_s0",[
(store_script_param_1, ":local0"),
(party_get_num_companion_stacks, ":local1", ":local0"),
(str_store_string, 50, "str_none"),
(try_for_range, ":local2", 0, ":local1"),
    (party_stack_get_troop_id, ":local3", ":local0", ":local2"),
    (party_stack_get_size, ":local4", ":local0", ":local2"),
    (str_store_troop_name_by_count, 61, ":local3", ":local4"),
    (try_begin),
        (troop_is_hero, ":local3"),
        (str_store_string_reg, 51, 61),
        (else_try),
        (assign, reg60, ":local4"),
        (str_store_string, 63, "str_reg60_s61"),
    (try_end),
    (try_begin),
        (eq, ":local2", 0),
        (str_store_string_reg, 50, 51),
        (else_try),
        (str_store_string, 50, "str_s50_comma_s51"),
    (try_end),
(try_end),
(str_store_string_reg, 0, 50),
]), 

#script_party_count_fit_regulars
("party_count_fit_regulars",[
(store_script_param_1, ":local0"),
(party_get_num_companion_stacks, ":local1", ":local0"),
(assign, reg0, 0),
(try_for_range, ":local2", 0, ":local1"),
    (party_stack_get_troop_id, ":local3", ":local0", ":local2"),
    (neg|troop_is_hero, ":local3"),
    (party_stack_get_size, ":local4", ":local0", ":local2"),
    (party_stack_get_num_wounded, ":local5", ":local0", ":local2"),
    (val_sub, ":local4", ":local5"),
    (val_add, reg0, ":local4"),
(try_end),
]), 

#script_party_count_fit_for_battle
("party_count_fit_for_battle",[
(store_script_param_1, ":local0"),
(party_get_num_companion_stacks, ":local1", ":local0"),
(assign, reg0, 0),
(try_for_range, ":local2", 0, ":local1"),
    (party_stack_get_troop_id, ":local3", ":local0", ":local2"),
    (assign, ":local4", 0),
    (try_begin),
        (troop_is_hero, ":local3"),
        (store_troop_health, ":local5", ":local3", 0),
        (ge, ":local5", 20),
        (assign, ":local4", 1),
        (else_try),
        (party_stack_get_size, ":local4", ":local0", ":local2"),
        (party_stack_get_num_wounded, ":local6", ":local0", ":local2"),
        (val_sub, ":local4", ":local6"),
    (try_end),
    (val_add, reg0, ":local4"),
(try_end),
]), 

#script_get_stack_with_rank
("get_stack_with_rank",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(party_get_num_companion_stacks, ":local2", ":local0"),
(assign, reg0, -1),
(assign, ":local3", 0),
(try_for_range, ":local4", 0, ":local2"),
    (eq, reg0, -1),
    (party_stack_get_troop_id, ":local5", ":local0", ":local4"),
    (neg|troop_is_hero, ":local5"),
    (party_stack_get_size, ":local6", ":local0", ":local4"),
    (party_stack_get_num_wounded, ":local7", ":local0", ":local4"),
    (val_sub, ":local6", ":local7"),
    (val_add, ":local3", ":local6"),
    (try_begin),
        (neg|ge, ":local1", ":local3"),
        (assign, reg0, ":local4"),
    (try_end),
(try_end),
]), 

#script_inflict_casualties_to_party
("inflict_casualties_to_party",[
(party_clear, "p_temp_casualties"),
(store_script_param_1, ":local0"),
(call_script, "script_party_count_fit_regulars", ":local0", 0),
(assign, ":local1", reg0),
(store_script_param_2, ":local2"),
(try_for_range, ":local3", 0, ":local2"),
    (gt, ":local1", 0),
    (store_random_in_range, ":local4", 0, ":local1"),
    (call_script, "script_get_stack_with_rank", ":local0", ":local4"),
    (assign, ":local5", reg0),
    (party_stack_get_troop_id, ":local6", ":local0", ":local5"),
    (store_character_level, ":local7", ":local6"),
    (val_add, ":local7", 5),
    (try_begin),
        (this_or_next|is_between, ":local6", "trp_map_heroes_begin", "trp_map_heroes_end"),
        (is_between, ":local6", "trp_cave_troll", "trp_end_orc_uruk_troll"),
        (val_mul, ":local7", 2),
    (try_end),
    (assign, ":local8", 10000),
    (val_div, ":local8", ":local7"),
    (try_begin),
        (store_random_in_range, ":local9", 0, 10000),
        (neg|ge, ":local9", ":local8"),
        (store_random_in_range, ":local10", 0, 2),
        (try_begin),
            (neg|ge, ":local10", 1),
            (party_add_members, "p_temp_casualties", ":local6", 1),
            (party_wound_members, "p_temp_casualties", ":local6", 1),
            (party_wound_members, ":local0", ":local6", 1),
            (else_try),
            (party_add_members, "p_temp_casualties", ":local6", 1),
            (try_begin),
                (is_between, ":local6", "trp_map_heroes_begin", "trp_map_heroes_end"),
                (call_script, "script_hero_leader_killed_abstractly", ":local6", 0),
            (try_end),
        (try_end),
        (val_sub, ":local1", 1),
    (try_end),
(try_end),
]), 

#script_move_members_with_ratio
("move_members_with_ratio",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(party_get_num_prisoner_stacks, ":local2", ":local0"),
    (try_for_range_backwards, ":local3", 0, ":local2"),
    (party_prisoner_stack_get_troop_id, ":local4", ":local0", ":local3"),
    (neg|is_between, ":local4", "trp_map_heroes_begin", "trp_map_heroes_end"),
    (party_prisoner_stack_get_size, ":local5", ":local0", ":local3"),
    (store_mul, ":local6", ":local5", "$pin_number"),
    (val_div, ":local6", 1000),
    (val_add, ":local6", 1),
    (party_remove_prisoners, ":local0", ":local4", ":local6"),
    (assign, ":local7", reg0),
    (party_add_prisoners, ":local1", ":local4", ":local7"),
(try_end),
(party_get_num_companion_stacks, ":local2", ":local0"),
    (try_for_range_backwards, ":local3", 0, ":local2"),
    (party_stack_get_troop_id, ":local4", ":local0", ":local3"),
    (neg|is_between, ":local4", "trp_map_heroes_begin", "trp_map_heroes_end"),
    (party_stack_get_size, ":local5", ":local0", ":local3"),
    (store_mul, ":local6", ":local5", "$pin_number"),
    (val_div, ":local6", 1000),
    (val_add, ":local6", 1),
    (party_remove_members, ":local0", ":local4", ":local6"),
    (assign, ":local7", reg0),
    (party_add_members, ":local1", ":local4", ":local7"),
(try_end),
]), 

#script_reassign_faction_of_town
("reassign_faction_of_town",[
(store_script_param_1, ":local0"),
(party_get_slot, ":local1", ":local0", 6),
(ge, ":local1", 1),
(party_set_faction, ":local0", ":local1"),
]), 

#script_count_parties_of_faction_and_party_type
("count_parties_of_faction_and_party_type",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(assign, reg0, 0),
(try_for_parties, ":party"),
    (party_is_active, ":party"),
    (party_get_slot, ":local3", ":party", 0),
    (eq, ":local3", ":local1"),
    (store_faction_of_party, ":local4", ":party"),
    (eq, ":local4", ":local0"),
    (val_add, reg0, 1),
(try_end),
]), 

#script_select_random_town
("select_random_town",[
(assign, ":local0", "p_castle_1"),
(val_sub, ":local0", "p_town_1"),
(assign|shuffle_range, ":local1", ":local0", 0),
(val_add, ":local1", "p_town_1"),
(assign, "$pout_town", ":local1"),
]), 

#script_select_random_spawn_point
("select_random_spawn_point",[
(assign, reg20, "p_spawn_points_end"),
(val_sub, reg20, "p_zendar"),
(assign|shuffle_range, reg21, reg20, 0),
(val_add, reg21, "p_zendar"),
(assign, "$pout_town", reg21),
]), 

#script_select_faction_town
("select_faction_town",[
(assign, reg24, 0),
    (try_for_range, reg25, "p_town_1", "p_castle_1"),
    (store_faction_of_party, reg23, reg25),
    (eq, reg23, "$pin_faction"),
    (val_add, reg24, 1),
(try_end),
(gt, reg24, 0),
(assign|shuffle_range, reg26, reg24, 0),
(assign, reg24, 0),
    (try_for_range, reg25, "p_town_1", "p_castle_1"),
    (store_faction_of_party, reg23, reg25),
    (eq, reg23, "$pin_faction"),
        (try_begin),
        (eq, reg24, reg26),
        (assign, "$pout_town", reg25),
    (try_end),
    (val_add, reg24, 1),
(try_end),
]), 

#script_select_faction_spawn_point
("select_faction_spawn_point",[
(assign, reg24, 0),
    (try_for_range, reg25, "p_zendar", "p_spawn_points_end"),
    (store_faction_of_party, reg23, reg25),
    (eq, reg23, "$pin_faction"),
    (val_add, reg24, 1),
(try_end),
(gt, reg24, 0),
(assign|shuffle_range, reg26, reg24, 0),
(assign, reg24, 0),
    (try_for_range, reg25, "p_zendar", "p_spawn_points_end"),
    (store_faction_of_party, reg23, reg25),
    (eq, reg23, "$pin_faction"),
        (try_begin),
        (eq, reg24, reg26),
        (assign, "$pout_town", reg25),
    (try_end),
    (val_add, reg24, 1),
(try_end),
]), 

#script_spawn_party_at_random_town
("spawn_party_at_random_town",[
(call_script, "script_select_random_spawn_point", 0, 0),
(set_spawn_radius, 1),
(spawn_around_party, "$pout_town", "$pin_party_template"),
(assign, "$pout_party", reg0),
]), 

#script_spawn_party_at_faction_town
("spawn_party_at_faction_town",[
(call_script, "script_select_faction_spawn_point", 0, 0),
(set_spawn_radius, 1),
(spawn_around_party, "$pout_town", "$pin_party_template"),
(assign, "$pout_party", reg0),
]), 

#script_spawn_party_at_random_town_if_below_limit
("spawn_party_at_random_town_if_below_limit",[
(store_num_parties_of_template, reg22, "$pin_party_template"),
(neg|ge, reg22, "$pin_limit"),
(call_script, "script_select_random_spawn_point", 0, 0),
(set_spawn_radius, 1),
(spawn_around_party, "$pout_town", "$pin_party_template"),
(assign, "$pout_party", reg0),
]), 

#script_spawn_party_at_faction_town_if_below_limit
("spawn_party_at_faction_town_if_below_limit",[
(store_num_parties_of_template, reg22, "$pin_party_template"),
(neg|ge, reg22, "$pin_limit"),
(call_script, "script_select_faction_spawn_point", 0, 0),
(set_spawn_radius, 1),
(spawn_around_party, "$pout_town", "$pin_party_template"),
(assign, "$pout_party", reg0),
]), 

#script_shuffle_troop_slots
("shuffle_troop_slots",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
    (try_for_range, ":local2", ":local0", ":local1"),
    (store_random_in_range, ":local3", ":local0", ":local1"),
    (troop_get_slot, ":local4", "$pin_troop", ":local2"),
    (troop_get_slot, ":local5", "$pin_troop", ":local3"),
    (troop_set_slot, "$pin_troop", ":local2", ":local5"),
    (troop_set_slot, "$pin_troop", ":local3", ":local4"),
(try_end),
]), 

#script_get_town_max_siege_resistance
("get_town_max_siege_resistance",[
(assign, reg0, 3),
]), 

#script_change_town_faction
("change_town_faction",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(party_get_slot, ":local2", ":local0", 6),
(party_set_slot, ":local0", 6, ":local1"),
(party_set_faction, ":local0", ":local1"),
(assign, reg0, 3),
]), 

#script_get_closest_center_of_faction
("get_closest_center_of_faction",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(assign, ":local2", 9999999),
(assign, reg0, -1),
(try_for_range, ":local3", "p_town_1", "p_castle_8"),
    (store_faction_of_party, ":local4", ":local3"),
    (eq, ":local4", ":local1"),
    (store_distance_to_party_from_party, ":local5", ":local0", ":local3"),
    (neg|ge, ":local5", ":local2"),
    (assign, ":local2", ":local5"),
    (assign, reg0, ":local3"),
(try_end),
]), 

#script_party_wound_all_members
("party_wound_all_members",[
(store_script_param_1, ":local0"),
(party_get_num_companion_stacks, ":local1", ":local0"),
(try_for_range, ":local2", 0, ":local1"),
    (party_stack_get_troop_id, ":local3", ":local0", ":local2"),
    (neg|troop_is_hero, ":local3"),
    (party_stack_get_size, ":local4", ":local0", ":local2"),
    (party_wound_members, ":local0", ":local3", ":local4"),
(try_end),
]), 

#script_calculate_battle_advantage
("calculate_battle_advantage",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(call_script, "script_party_count_fit_for_battle", "p_main_party", 0),
(assign, ":local2", reg0),
(party_get_skill_level, ":local3", "p_main_party", 9),
(try_begin),
    (gt, ":local1", 0),
    (call_script, "script_party_count_fit_for_battle", ":local1", 0),
    (val_add, ":local2", reg0),
    (party_get_skill_level, ":local4", ":local1", 9),
    (val_max, ":local3", ":local4"),
(try_end),
(call_script, "script_party_count_fit_for_battle", ":local0", 0),
(assign, ":local5", reg0),
(party_get_skill_level, ":local6", ":local0", 9),
(val_add, ":local2", 1),
(val_add, ":local5", 1),
(try_begin),
    (ge, ":local2", ":local5"),
    (val_mul, ":local2", 100),
    (store_div, ":local7", ":local2", ":local5"),
    (store_sub, ":local8", ":local7", 100),
    (else_try),
    (val_mul, ":local5", 100),
    (store_div, ":local7", ":local5", ":local2"),
    (store_sub, ":local8", 100, ":local7"),
(try_end),
(val_mul, ":local3", 50),
(val_mul, ":local6", 50),
(val_add, ":local8", ":local3"),
(val_sub, ":local8", ":local6"),
(assign, ":local9", ":local8"),
(val_add, ":local9", 1000000),
(val_mod, ":local9", 100),
(try_begin),
    (ge, ":local9", 50),
    (assign, ":local9", 1),
    (else_try),
    (assign, ":local9", 0),
(try_end),
(try_begin),
    (neg|ge, ":local8", 0),
    (val_sub, ":local9", 1),
(try_end),
(val_div, ":local8", 100),
(val_add, ":local8", ":local9"),
(assign, reg0, ":local8"),
]), 

#script_check_enemies_nearby
("check_enemies_nearby",[
(get_player_agent_no, ":local0"),
(agent_is_alive, ":local0"),
(try_begin),
    (agent_is_defender, ":local0"),
    (assign, ":local1", 1),
    (else_try),
    (assign, ":local1", 0),
(try_end),
(agent_get_position, 1, ":local0"),
(assign, ":local2", 0),
(try_for_agents, ":local3"),
    (neg|eq, ":local3", ":local0"),
    (agent_is_alive, ":local3"),
    (agent_is_human, ":local3"),
    (try_begin),
        (agent_is_defender, ":local3"),
        (assign, ":local4", 1),
        (else_try),
        (assign, ":local4", 0),
    (try_end),
    (neg|eq, ":local1", ":local4"),
    (agent_get_position, 2, ":local3"),
    (get_distance_between_positions, ":local5", 1, 2),
    (neg|gt, ":local5", 1500),
    (assign, ":local2", 1),
(try_end),
(eq, ":local2", 0),
]), 

#script_check_for_nazgul
("check_for_nazgul",[
(assign, "$nazgul_search_done", 1),
    (try_begin),
    (eq, "$nazgul_present", 0),
    (party_get_template_id, ":local0", "$g_ally_party"),
    (this_or_next|eq, ":local0", "pt_host_of_mordor"),
    (this_or_next|eq, ":local0", "pt_host_of_minas_morgul"),
    (this_or_next|eq, ":local0", "pt_host_of_udun"),
    (this_or_next|eq, ":local0", "pt_host_of_gorgoroth"),
    (this_or_next|eq, ":local0", "pt_host_of_dol_guldur"),
    (eq, ":local0", "pt_host_of_barad_dur"),
    (assign, "$nazgul_present", 1),
(try_end),
(party_get_num_attached_parties, ":local1", "$g_ally_party"),
    (try_for_range, ":local2", 0, ":local1"),
    (party_get_attached_party, ":local3", "$g_ally_party", ":local2"),
    (party_get_template_id, ":local0", ":local3"),
    (this_or_next|eq, ":local0", "pt_host_of_mordor"),
    (this_or_next|eq, ":local0", "pt_host_of_minas_morgul"),
    (this_or_next|eq, ":local0", "pt_host_of_udun"),
    (this_or_next|eq, ":local0", "pt_host_of_gorgoroth"),
    (this_or_next|eq, ":local0", "pt_host_of_dol_guldur"),
    (eq, ":local0", "pt_host_of_barad_dur"),
    (assign, "$nazgul_present", 1),
(try_end),
    (try_begin),
    (eq, "$nazgul_present", 0),
    (party_get_template_id, ":local0", "$g_enemy_party"),
    (this_or_next|eq, ":local0", "pt_host_of_mordor"),
    (this_or_next|eq, ":local0", "pt_host_of_minas_morgul"),
    (this_or_next|eq, ":local0", "pt_host_of_udun"),
    (this_or_next|eq, ":local0", "pt_host_of_gorgoroth"),
    (this_or_next|eq, ":local0", "pt_host_of_dol_guldur"),
    (eq, ":local0", "pt_host_of_barad_dur"),
    (assign, "$nazgul_present", 2),
(try_end),
(party_get_num_attached_parties, ":local1", "$g_enemy_party"),
    (try_for_range, ":local2", 0, ":local1"),
    (party_get_attached_party, ":local3", "$g_enemy_party", ":local2"),
    (party_get_template_id, ":local0", ":local3"),
    (this_or_next|eq, ":local0", "pt_host_of_mordor"),
    (this_or_next|eq, ":local0", "pt_host_of_minas_morgul"),
    (this_or_next|eq, ":local0", "pt_host_of_udun"),
    (this_or_next|eq, ":local0", "pt_host_of_gorgoroth"),
    (this_or_next|eq, ":local0", "pt_host_of_dol_guldur"),
    (eq, ":local0", "pt_host_of_barad_dur"),
    (assign, "$nazgul_present", 2),
(try_end),
]), 

#script_nazgul_fear
("nazgul_fear",[
(get_player_agent_no, ":local0"),
    (try_for_agents, "$agent"),
        (try_begin),
        (eq, "$nazgul_present", 1),
        (neg|eq, "$agent", ":local0"),
        (agent_is_alive, "$agent"),
        (agent_is_human, "$agent"),
        (agent_is_ally|neg, "$agent"),
        (agent_get_slot, ":local1", "$agent", 3),
        (agent_get_slot, ":local2", "$agent", 1),
            (try_begin),
            (eq, ":local1", 0),
            (assign|shuffle_range, ":local3", 4, 0),
            (neg|gt, ":local3", 1),
                (try_begin),
                (neg|eq, ":local2", 0),
                (agent_clear_scripted_mode, "$agent"),
                (agent_set_slot, "$agent", 1, 0),
            (try_end),
                (try_begin),
                (eq, ":local1", 0),
                (call_script, "script_match_agent_to_horse", "$agent", 0),
                (eq, "$mounted_troop", 0),
                (assign|shuffle_range, ":local4", 2, 0),
                    (try_begin),
                    (eq, ":local4", 0),
                    (agent_set_animation, "$agent", 154),
                    (else_try),
                    (eq, ":local4", 1),
                    (agent_set_animation, "$agent", 180),
                (try_end),
            (try_end),
            (assign|shuffle_range, ":local5", 4, 0),
            (val_add, ":local5", 21),
            (entry_point_get_position, 20, ":local5"),
            (agent_set_scripted_destination, "$agent", 20),
            (agent_set_slot, "$agent", 2, 1),
            (agent_set_slot, "$agent", 3, ":local5"),
            (else_try),
            (neg|eq, ":local1", 0),
            (agent_get_position, 2, "$agent"),
            (entry_point_get_position, 1, ":local1"),
            (get_distance_between_positions, ":local6", 2, 1),
            (neg|ge, ":local6", 2000),
            (assign|shuffle_range, ":local5", 4, 0),
            (val_add, ":local5", 21),
            (entry_point_get_position, 20, ":local5"),
            (agent_set_scripted_destination, "$agent", 20),
            (agent_set_slot, "$agent", 2, 1),
            (agent_set_slot, "$agent", 3, ":local5"),
        (try_end),
        (else_try),
        (eq, "$nazgul_present", 2),
        (neg|eq, "$agent", ":local0"),
        (agent_is_alive, "$agent"),
        (agent_is_human, "$agent"),
        (agent_is_ally, "$agent"),
        (agent_get_slot, ":local1", "$agent", 3),
        (agent_get_slot, ":local2", "$agent", 1),
            (try_begin),
            (eq, ":local1", 0),
            (assign|shuffle_range, ":local3", 4, 0),
            (neg|gt, ":local3", 1),
                (try_begin),
                (neg|eq, ":local2", 0),
                (agent_clear_scripted_mode, "$agent"),
                (agent_set_slot, "$agent", 1, 0),
            (try_end),
                (try_begin),
                (eq, ":local1", 0),
                (call_script, "script_match_agent_to_horse", "$agent", 0),
                (eq, "$mounted_troop", 0),
                (assign|shuffle_range, ":local4", 2, 0),
                    (try_begin),
                    (eq, ":local4", 0),
                    (agent_set_animation, "$agent", 154),
                    (else_try),
                    (eq, ":local4", 1),
                    (agent_set_animation, "$agent", 180),
                (try_end),
            (try_end),
            (assign|shuffle_range, ":local5", 4, 0),
            (val_add, ":local5", 21),
            (entry_point_get_position, 20, ":local5"),
            (agent_set_scripted_destination, "$agent", 20),
            (agent_set_slot, "$agent", 2, 1),
            (agent_set_slot, "$agent", 3, ":local5"),
            (else_try),
            (neg|eq, ":local1", 0),
            (agent_get_position, 2, "$agent"),
            (entry_point_get_position, 1, ":local1"),
            (get_distance_between_positions, ":local6", 2, 1),
            (neg|ge, ":local6", 2000),
            (assign|shuffle_range, ":local5", 4, 0),
            (val_add, ":local5", 21),
            (entry_point_get_position, 20, ":local5"),
            (agent_set_scripted_destination, "$agent", 20),
            (agent_set_slot, "$agent", 2, 1),
            (agent_set_slot, "$agent", 3, ":local5"),
        (try_end),
    (try_end),
(try_end),
]), 

#script_clear_nazgul_effects
("clear_nazgul_effects",[
    (try_for_agents, "$agent"),
    (agent_get_slot, ":local0", "$agent", 2),
    (eq, ":local0", 1),
    (agent_set_slot, "$agent", 2, 0),
    (agent_set_slot, "$agent", 3, 0),
    (agent_clear_scripted_mode, "$agent"),
(try_end),
(assign, "$nazgul_effects", 0),
(assign, "$nazgul_present", 0),
]), 

#script_nazgul_damage
("nazgul_damage",[
(try_for_agents, ":agent"),
    (agent_get_slot, ":local0", ":agent", 2),
    (eq, ":local0", ":agent"),
    (store_agent_hit_points, ":local1", ":agent", 0),
    (gt, ":local1", 10),
    (store_random_in_range, ":local2", 70, 90),
    (agent_set_hit_points, ":agent", ":local2", 0),
(try_end),
]), 

#script_normalize_troop_morale
("normalize_troop_morale",[
    (try_begin),
    (eq, reg1, "fac_gondor"),
    (assign, "$troop_range_begin", "trp_gondor_youth"),
    (assign, "$troop_range_end", "trp_rohan_youth"),
    (else_try),
    (eq, reg1, "fac_rohan"),
    (assign, "$troop_range_begin", "trp_rohan_youth"),
    (assign, "$troop_range_end", "trp_harad_youth"),
    (else_try),
    (eq, reg1, "fac_lothlorien"),
    (assign, "$troop_range_begin", "trp_lothlorien_scout"),
    (assign, "$troop_range_end", "trp_greenwood_scout"),
    (else_try),
    (eq, reg1, "fac_imladris"),
    (assign, "$troop_range_begin", "trp_rivendell_scout"),
    (assign, "$troop_range_end", "trp_gondor_youth"),
    (else_try),
    (eq, reg1, "fac_woodelves"),
    (assign, "$troop_range_begin", "trp_greenwood_scout"),
    (assign, "$troop_range_end", "trp_rivendell_scout"),
    (else_try),
    (eq, reg1, "fac_mordor"),
    (assign, "$troop_range_begin", "trp_orc_snaga_of_mordor"),
    (assign, "$troop_range_end", "trp_wolf_rider_of_moria"),
    (assign, "$second_troop_range_begin", "trp_uruk_snaga_of_mordor"),
    (assign, "$second_troop_range_end", "trp_uruk_hai_scout"),
    (else_try),
    (eq, reg1, "fac_isengard"),
    (assign, "$troop_range_begin", "trp_orc_snaga_of_isengard"),
    (assign, "$troop_range_end", "trp_orc_snaga_of_mordor"),
    (assign, "$second_troop_range_begin", "trp_uruk_hai_scout"),
    (assign, "$second_troop_range_end", "trp_cave_troll"),
    (else_try),
    (eq, reg1, "fac_haradrim"),
    (assign, "$troop_range_begin", "trp_harad_youth"),
    (assign, "$troop_range_end", "trp_dunnish_youth"),
    (else_try),
    (eq, reg1, "fac_dunlanders"),
    (assign, "$troop_range_begin", "trp_dunnish_youth"),
    (assign, "$troop_range_end", "trp_easterling_youth"),
    (else_try),
    (eq, reg1, "fac_easterlings"),
    (assign, "$troop_range_begin", "trp_easterling_youth"),
    (assign, "$troop_range_end", "trp_corsair_youth"),
    (else_try),
    (eq, reg1, "fac_corsairs"),
    (assign, "$troop_range_begin", "trp_corsair_youth"),
    (assign, "$troop_range_end", "trp_orc_snaga_of_isengard"),
    (else_try),
    (eq, reg1, "fac_moria"),
    (assign, "$troop_range_begin", "trp_wolf_rider_of_moria"),
    (assign, "$troop_range_end", "trp_mountain_goblin"),
(try_end),
    (try_begin),
    (eq, reg3, 6),
    (assign, reg8, -15),
    (else_try),
    (eq, reg3, 5),
    (assign, reg8, -10),
    (else_try),
    (eq, reg3, 4),
    (assign, reg8, -5),
    (else_try),
    (eq, reg3, 3),
    (assign, reg8, 0),
    (else_try),
    (eq, reg3, 2),
    (assign, reg8, 5),
    (else_try),
    (eq, reg3, 1),
    (assign, reg8, 10),
    (else_try),
    (eq, reg3, 0),
    (assign, reg8, 15),
(try_end),
    (try_for_range, reg7, "$troop_range_begin", "$troop_range_end"),
    (neg|eq, reg3, 3),
    (troop_raise_proficiency_linear, reg7, 0, reg8),
    (troop_raise_proficiency_linear, reg7, 1, reg8),
    (troop_raise_proficiency_linear, reg7, 2, reg8),
    (troop_raise_proficiency_linear, reg7, 3, reg8),
    (troop_raise_proficiency_linear, reg7, 4, reg8),
    (troop_raise_proficiency_linear, reg7, 5, reg8),
(try_end),
    (try_for_range, reg7, "$second_troop_range_begin", "$second_troop_range_end"),
    (eq, reg1, "fac_mordor"),
    (neg|eq, reg3, 3),
    (troop_raise_proficiency_linear, reg7, 0, reg8),
    (troop_raise_proficiency_linear, reg7, 1, reg8),
    (troop_raise_proficiency_linear, reg7, 2, reg8),
    (troop_raise_proficiency_linear, reg7, 3, reg8),
    (troop_raise_proficiency_linear, reg7, 4, reg8),
    (troop_raise_proficiency_linear, reg7, 5, reg8),
(try_end),
    (try_for_range, reg7, "$second_troop_range_begin", "$second_troop_range_end"),
    (eq, reg1, "fac_isengard"),
    (neg|eq, reg3, 3),
    (troop_raise_proficiency_linear, reg7, 0, reg8),
    (troop_raise_proficiency_linear, reg7, 1, reg8),
    (troop_raise_proficiency_linear, reg7, 2, reg8),
    (troop_raise_proficiency_linear, reg7, 3, reg8),
    (troop_raise_proficiency_linear, reg7, 4, reg8),
    (troop_raise_proficiency_linear, reg7, 5, reg8),
(try_end),
(faction_set_slot, reg1, 2, 3),
    (try_begin),
    (eq, reg1, "fac_easterlings"),
    (eq, "$easterlings_celebrate", 1),
    (assign, "$easterlings_celebrate", 0),
    (else_try),
    (eq, reg1, "fac_dunlanders"),
    (eq, "$dunlanders_celebrate", 1),
    (assign, "$dunlanders_celebrate", 0),
    (else_try),
    (eq, reg1, "fac_haradrim"),
    (eq, "$haradrim_celebrate", 1),
    (assign, "$haradrim_celebrate", 0),
(try_end),
]), 

#script_determine_troop_morale
("determine_troop_morale",[
    (try_for_range, reg1, "fac_gondor", "fac_dol_guldur"),
    (faction_get_slot, reg2, reg1, 1),
    (ge, reg2, 1),
    (faction_get_slot, reg3, reg1, 2),
        (try_begin),
        (neg|eq, reg3, 3),
        (call_script, "script_normalize_troop_morale", 0, 0),
        (assign, reg3, 3),
    (try_end),
        (try_begin),
        (eq, reg1, "fac_gondor"),
        (assign, reg5, "$gondor_status"),
        (else_try),
        (eq, reg1, "fac_rohan"),
        (assign, reg5, "$rohan_status"),
        (else_try),
        (eq, reg1, "fac_lothlorien"),
        (assign, reg5, "$lothlorien_status"),
        (else_try),
        (eq, reg1, "fac_imladris"),
        (assign, reg5, "$rivendell_status"),
        (else_try),
        (eq, reg1, "fac_woodelves"),
        (assign, reg5, "$woodelf_status"),
        (else_try),
        (eq, reg1, "fac_mordor"),
        (assign, reg5, "$mordor_status"),
        (else_try),
        (eq, reg1, "fac_isengard"),
        (assign, reg5, "$isengard_status"),
        (else_try),
        (eq, reg1, "fac_haradrim"),
        (assign, reg5, "$haradrim_status"),
        (else_try),
        (eq, reg1, "fac_dunlanders"),
        (assign, reg5, "$dunlander_status"),
        (else_try),
        (eq, reg1, "fac_easterlings"),
        (assign, reg5, "$easterling_status"),
        (else_try),
        (eq, reg1, "fac_corsairs"),
        (assign, reg5, "$corsair_status"),
        (else_try),
        (eq, reg1, "fac_moria"),
        (assign, reg5, "$moria_status"),
    (try_end),
    (assign|shuffle_range, reg4, 100, 0),
    (val_add, reg4, 1),
        (try_begin),
        (ge, reg5, 3),
        (eq, reg2, 1),
        (neg|gt, reg4, 60),
        (assign, reg3, 3),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 1),
        (gt, reg4, 60),
        (neg|gt, reg4, 80),
        (assign, reg3, 2),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 1),
        (gt, reg4, 80),
        (neg|gt, reg4, 90),
        (assign, reg3, 1),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 1),
        (gt, reg4, 90),
        (neg|gt, reg4, 100),
        (assign, reg3, 0),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 1),
        (neg|gt, reg4, 50),
        (assign, reg3, 3),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 1),
        (gt, reg4, 50),
        (neg|gt, reg4, 70),
        (assign, reg3, 2),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 1),
        (gt, reg4, 70),
        (neg|gt, reg4, 90),
        (assign, reg3, 1),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 1),
        (gt, reg4, 90),
        (neg|gt, reg4, 100),
        (assign, reg3, 0),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 1),
        (neg|gt, reg4, 40),
        (assign, reg3, 3),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 1),
        (gt, reg4, 40),
        (neg|gt, reg4, 60),
        (assign, reg3, 2),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 1),
        (gt, reg4, 60),
        (neg|gt, reg4, 80),
        (assign, reg3, 1),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 1),
        (gt, reg4, 80),
        (neg|gt, reg4, 100),
        (assign, reg3, 0),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 2),
        (neg|gt, reg4, 40),
        (assign, reg3, 3),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 2),
        (gt, reg4, 40),
        (neg|gt, reg4, 60),
        (assign, reg3, 4),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 2),
        (gt, reg4, 60),
        (neg|gt, reg4, 80),
        (assign, reg3, 5),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 2),
        (gt, reg4, 80),
        (neg|gt, reg4, 100),
        (assign, reg3, 6),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 2),
        (neg|gt, reg4, 50),
        (assign, reg3, 3),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 2),
        (gt, reg4, 50),
        (neg|gt, reg4, 70),
        (assign, reg3, 4),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 2),
        (gt, reg4, 70),
        (neg|gt, reg4, 90),
        (assign, reg3, 5),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 2),
        (gt, reg4, 90),
        (neg|gt, reg4, 100),
        (assign, reg3, 6),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 2),
        (neg|gt, reg4, 60),
        (assign, reg3, 3),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 2),
        (gt, reg4, 60),
        (neg|gt, reg4, 80),
        (assign, reg3, 4),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 2),
        (gt, reg4, 80),
        (neg|gt, reg4, 90),
        (assign, reg3, 5),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 2),
        (gt, reg4, 90),
        (neg|gt, reg4, 100),
        (assign, reg3, 6),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 3),
        (neg|gt, reg4, 5),
        (assign, reg3, 0),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 3),
        (gt, reg4, 5),
        (neg|gt, reg4, 10),
        (assign, reg3, 1),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 3),
        (gt, reg4, 10),
        (neg|gt, reg4, 20),
        (assign, reg3, 2),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 3),
        (gt, reg4, 20),
        (neg|gt, reg4, 60),
        (assign, reg3, 3),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 3),
        (gt, reg4, 60),
        (neg|gt, reg4, 75),
        (assign, reg3, 4),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 3),
        (gt, reg4, 75),
        (neg|gt, reg4, 90),
        (assign, reg3, 5),
        (else_try),
        (ge, reg5, 3),
        (eq, reg2, 3),
        (gt, reg4, 90),
        (neg|gt, reg4, 100),
        (assign, reg3, 6),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 3),
        (neg|gt, reg4, 10),
        (assign, reg3, 0),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 3),
        (gt, reg4, 10),
        (neg|gt, reg4, 20),
        (assign, reg3, 1),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 3),
        (gt, reg4, 20),
        (neg|gt, reg4, 30),
        (assign, reg3, 2),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 3),
        (gt, reg4, 30),
        (neg|gt, reg4, 70),
        (assign, reg3, 3),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 3),
        (gt, reg4, 70),
        (neg|gt, reg4, 80),
        (assign, reg3, 4),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 3),
        (gt, reg4, 80),
        (neg|gt, reg4, 90),
        (assign, reg3, 5),
        (else_try),
        (eq, reg5, 2),
        (eq, reg2, 3),
        (gt, reg4, 90),
        (neg|gt, reg4, 100),
        (assign, reg3, 6),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 3),
        (neg|gt, reg4, 10),
        (assign, reg3, 0),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 3),
        (gt, reg4, 10),
        (neg|gt, reg4, 25),
        (assign, reg3, 1),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 3),
        (gt, reg4, 25),
        (neg|gt, reg4, 40),
        (assign, reg3, 2),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 3),
        (gt, reg4, 40),
        (neg|gt, reg4, 80),
        (assign, reg3, 3),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 3),
        (gt, reg4, 80),
        (neg|gt, reg4, 90),
        (assign, reg3, 4),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 3),
        (gt, reg4, 90),
        (neg|gt, reg4, 95),
        (assign, reg3, 5),
        (else_try),
        (eq, reg5, 1),
        (eq, reg2, 3),
        (gt, reg4, 95),
        (neg|gt, reg4, 100),
        (assign, reg3, 6),
    (try_end),
    (faction_set_slot, reg1, 2, reg3),
    (faction_set_slot, reg1, 1, 0),
    (neg|eq, reg3, 3),
    (neg|eq, reg5, 0),
    (call_script, "script_modify_troop_morale", 0, 0),
(try_end),
]), 

#script_modify_troop_morale
("modify_troop_morale",[
    (try_begin),
    (eq, reg1, "fac_gondor"),
    (assign, reg5, "$gondor_status"),
    (assign, "$troop_range_begin", "trp_gondor_youth"),
    (assign, "$troop_range_end", "trp_rohan_youth"),
    (assign, reg10, "@The_men_of_Gondor_despair."),
    (else_try),
    (eq, reg1, "fac_lothlorien"),
    (assign, reg5, "$lothlorien_status"),
    (assign, "$troop_range_begin", "trp_lothlorien_scout"),
    (assign, "$troop_range_end", "trp_greenwood_scout"),
    (assign, reg10, "@The_elves_of_Lothlorien_despair."),
    (else_try),
    (eq, reg1, "fac_woodelves"),
    (assign, reg5, "$woodelf_status"),
    (assign, "$troop_range_begin", "trp_greenwood_scout"),
    (assign, "$troop_range_end", "trp_rivendell_scout"),
    (assign, reg10, "@The_elves_of_Mirkwood_despair."),
    (else_try),
    (eq, reg1, "fac_imladris"),
    (assign, reg5, "$rivendell_status"),
    (assign, "$troop_range_begin", "trp_rivendell_scout"),
    (assign, "$troop_range_end", "trp_gondor_youth"),
    (assign, reg10, "@The_elves_of_Rivendell_despair."),
    (else_try),
    (eq, reg1, "fac_rohan"),
    (assign, reg5, "$rohan_status"),
    (assign, "$troop_range_begin", "trp_rohan_youth"),
    (assign, "$troop_range_end", "trp_harad_youth"),
    (assign, reg10, "@The_men_of_Rohan_despair."),
    (else_try),
    (eq, reg1, "fac_haradrim"),
    (assign, reg5, "$haradrim_status"),
    (assign, "$troop_range_begin", "trp_harad_youth"),
    (assign, "$troop_range_end", "trp_dunnish_youth"),
    (assign, reg10, "@The_Haradrim_despair."),
    (else_try),
    (eq, reg1, "fac_dunlanders"),
    (assign, reg5, "$dunlander_status"),
    (assign, "$troop_range_begin", "trp_dunnish_youth"),
    (assign, "$troop_range_end", "trp_easterling_youth"),
    (assign, reg10, "@The_Dunlendings_despair."),
    (else_try),
    (eq, reg1, "fac_easterlings"),
    (assign, reg5, "$easterling_status"),
    (assign, "$troop_range_begin", "trp_easterling_youth"),
    (assign, "$troop_range_end", "trp_corsair_youth"),
    (assign, reg10, "@The_Easterlings_despair."),
    (else_try),
    (eq, reg1, "fac_corsairs"),
    (assign, reg5, "$corsair_status"),
    (assign, "$troop_range_begin", "trp_corsair_youth"),
    (assign, "$troop_range_end", "trp_orc_snaga_of_isengard"),
    (assign, reg10, "@The_Corsairs_despair."),
    (else_try),
    (eq, reg1, "fac_isengard"),
    (assign, reg5, "$isengard_status"),
    (assign, "$troop_range_begin", "trp_orc_snaga_of_isengard"),
    (assign, "$troop_range_end", "trp_orc_snaga_of_mordor"),
    (assign, "$second_troop_range_begin", "trp_uruk_hai_scout"),
    (assign, "$second_troop_range_end", "trp_cave_troll"),
    (assign, reg10, "@The_orcs_of_Isengard_frightened_and_uncertain."),
    (else_try),
    (eq, reg1, "fac_mordor"),
    (assign, reg5, "$mordor_status"),
    (assign, "$troop_range_begin", "trp_orc_snaga_of_mordor"),
    (assign, "$troop_range_end", "trp_wolf_rider_of_moria"),
    (assign, "$second_troop_range_begin", "trp_uruk_snaga_of_mordor"),
    (assign, "$second_troop_range_end", "trp_uruk_hai_scout"),
    (assign, reg10, "@The_orcs_of_Mordor_frightened_and_uncertain."),
    (else_try),
    (eq, reg1, "fac_moria"),
    (assign, reg5, "$moria_status"),
    (assign, "$troop_range_begin", "trp_wolf_rider_of_moria"),
    (assign, "$troop_range_end", "trp_mountain_goblin"),
    (assign, reg10, "@The_goblins_of_Moria_are_frightened_and_uncertain"),
(try_end),
    (try_begin),
    (eq, reg3, 6),
    (assign, reg8, 15),
    (else_try),
    (eq, reg3, 5),
    (assign, reg8, 10),
    (else_try),
    (eq, reg3, 4),
    (assign, reg8, 5),
    (else_try),
    (eq, reg3, 3),
    (assign, reg8, 0),
    (else_try),
    (eq, reg3, 2),
    (assign, reg8, -5),
    (else_try),
    (eq, reg3, 1),
    (assign, reg8, -10),
    (else_try),
    (eq, reg3, 0),
    (assign, reg8, -15),
(try_end),
    (try_for_range, reg7, "$troop_range_begin", "$troop_range_end"),
    (neg|eq, reg3, 3),
    (troop_raise_proficiency_linear, reg7, 0, reg8),
    (troop_raise_proficiency_linear, reg7, 1, reg8),
    (troop_raise_proficiency_linear, reg7, 2, reg8),
    (troop_raise_proficiency_linear, reg7, 3, reg8),
    (troop_raise_proficiency_linear, reg7, 4, reg8),
    (troop_raise_proficiency_linear, reg7, 5, reg8),
(try_end),
    (try_for_range, reg7, "$second_troop_range_begin", "$second_troop_range_end"),
    (eq, reg1, "fac_mordor"),
    (neg|eq, reg3, 3),
    (troop_raise_proficiency_linear, reg7, 0, reg8),
    (troop_raise_proficiency_linear, reg7, 1, reg8),
    (troop_raise_proficiency_linear, reg7, 2, reg8),
    (troop_raise_proficiency_linear, reg7, 3, reg8),
    (troop_raise_proficiency_linear, reg7, 4, reg8),
    (troop_raise_proficiency_linear, reg7, 5, reg8),
(try_end),
    (try_for_range, reg7, "$second_troop_range_begin", "$second_troop_range_end"),
    (eq, reg1, "fac_isengard"),
    (neg|eq, reg3, 3),
    (troop_raise_proficiency_linear, reg7, 0, reg8),
    (troop_raise_proficiency_linear, reg7, 1, reg8),
    (troop_raise_proficiency_linear, reg7, 2, reg8),
    (troop_raise_proficiency_linear, reg7, 3, reg8),
    (troop_raise_proficiency_linear, reg7, 4, reg8),
    (troop_raise_proficiency_linear, reg7, 5, reg8),
(try_end),
(store_add, "$faction_current_morale", reg10, reg3),
(str_store_string, 1, "$faction_current_morale"),
(display_message, "$faction_current_morale", 4294901760),
(store_add, "$faction_current_morale", "@(-15_weapon_skill_until_mood_passes.)", reg3),
(str_store_string, 1, "$faction_current_morale"),
(display_message, "$faction_current_morale", 0),
]), 

#script_reduce_missile_skill
("reduce_missile_skill",[
    (try_for_range, reg1, "trp_warrior_of_pinnath_gelin", "trp_lothlorien_scout"),
    (assign, reg2, -1),
    (val_mul, reg2, "$night_missile_penalty"),
    (troop_raise_proficiency_linear, reg1, 3, reg2),
    (troop_raise_proficiency_linear, reg1, 4, reg2),
    (troop_raise_proficiency_linear, reg1, 5, reg2),
(try_end),
    (try_for_range, reg1, "trp_lothlorien_scout", "trp_gondor_youth"),
    (assign, reg2, -1),
    (val_mul, reg2, "$missile_skill_difficulty_level"),
    (troop_raise_proficiency_linear, reg1, 3, reg2),
    (troop_raise_proficiency_linear, reg1, 4, reg2),
    (troop_raise_proficiency_linear, reg1, 5, reg2),
(try_end),
    (try_for_range, reg1, "trp_archer_of_gondor", "trp_guardsman_of_rohan"),
    (assign, reg2, -1),
    (val_mul, reg2, "$missile_skill_difficulty_level"),
    (troop_raise_proficiency_linear, reg1, 3, reg2),
    (troop_raise_proficiency_linear, reg1, 4, reg2),
    (troop_raise_proficiency_linear, reg1, 5, reg2),
(try_end),
    (try_for_range, reg1, "trp_harad_archer", "trp_dunnish_youth"),
    (assign, reg2, -1),
    (val_mul, reg2, "$missile_skill_difficulty_level"),
    (troop_raise_proficiency_linear, reg1, 3, reg2),
    (troop_raise_proficiency_linear, reg1, 4, reg2),
    (troop_raise_proficiency_linear, reg1, 5, reg2),
(try_end),
    (try_for_range, reg1, "trp_easterling_hurler", "trp_pikeman_of_umbar"),
    (assign, reg2, -1),
    (val_mul, reg2, "$missile_skill_difficulty_level"),
    (troop_raise_proficiency_linear, reg1, 3, reg2),
    (troop_raise_proficiency_linear, reg1, 4, reg2),
    (troop_raise_proficiency_linear, reg1, 5, reg2),
(try_end),
    (try_for_range, reg1, "trp_orc_snaga_of_mordor", "trp_uruk_slayer_of_mordor"),
    (assign, reg2, -1),
    (val_mul, reg2, "$missile_skill_difficulty_level"),
    (troop_raise_proficiency_linear, reg1, 3, reg2),
    (troop_raise_proficiency_linear, reg1, 4, reg2),
    (troop_raise_proficiency_linear, reg1, 5, reg2),
(try_end),
]), 

#script_remove_archer_melee_weapons
("remove_archer_melee_weapons",[
(try_for_range, ":troop", "trp_lothlorien_archer", "trp_lothlorien_infantry"),
    (troop_remove_item, ":troop", "itm_sword"),
    (troop_add_item, ":troop", "itm_dagger", 0),
(try_end),
(try_for_range, ":troop", "trp_archer_of_gondor", "trp_ranger_of_ithilien"),
    (troop_remove_item, ":troop", "itm_sword"),
    (troop_add_item, ":troop", "itm_dagger", 0),
(try_end),
(try_for_range, ":troop", "trp_orc_archer_of_mordor", "trp_wolf_rider_of_moria"),
    (troop_remove_item, ":troop", "itm_umbarian_short_sword"),
    (troop_remove_item, ":troop", "itm_orc_falchion"),
    (troop_add_item, ":troop", "itm_knife", 0),
(try_end),
(try_for_range, ":troop", "trp_uruk_hai_scout", "trp_fighting_uruk_hai_berserker"),
    (troop_remove_item, ":troop", "itm_orc_falchion"),
    (troop_add_item, ":troop", "itm_knife", 0),
(try_end),
(try_for_range, ":troop", "trp_militia_of_umbar", "trp_corsair_marauder"),
    (troop_remove_item, ":troop", "itm_umbarian_short_sword"),
    (troop_add_item, ":troop", "itm_dagger", 0),
(try_end),
(try_for_range, ":troop", "trp_blackroot_vale_archer", "trp_lothlorien_scout"),
    (troop_raise_proficiency_linear, ":troop", 3, -30),
(try_end),
(try_for_range, ":troop", "trp_harad_archer", "trp_dunnish_youth"),
    (troop_raise_proficiency_linear, ":troop", 3, -30),
(try_end),
(try_for_range, ":troop", "trp_greenwood_archer", "trp_greenwood_spearman"),
    (troop_raise_proficiency_linear, ":troop", 3, -30),
(try_end),
]), 

#script_reduce_npc_combat_skills
("reduce_npc_combat_skills",[
(try_for_range, ":troop", "trp_brigand_lord", "trp_end_orc_uruk_troll"),
    (store_skill_level, reg2, 19, ":troop"),
    (val_min, reg2, reg5),
    (val_mul, reg2, -1),
    (troop_raise_skill, ":troop", 19, reg2),
    (store_skill_level, reg2, 20, ":troop"),
    (val_min, reg2, reg5),
    (val_mul, reg2, -1),
    (troop_raise_skill, ":troop", 20, reg2),
(try_end),
]), 

#script_increase_npc_combat_skills
("increase_npc_combat_skills",[
(try_for_range, ":troop", "trp_brigand_lord", "trp_end_orc_uruk_troll"),
    (store_skill_level, reg2, 19, ":troop"),
    (assign, reg3, 10),
    (val_sub, reg3, reg2),
    (val_min, reg3, reg5),
    (troop_raise_skill, ":troop", 19, reg3),
    (store_skill_level, reg2, 20, ":troop"),
    (assign, reg3, 10),
    (val_sub, reg3, reg2),
    (val_min, reg3, reg5),
    (troop_raise_skill, ":troop", 20, reg3),
(try_end),
]), 

#script_reduce_npc_weapon_skills
("reduce_npc_weapon_skills",[
(try_for_range, ":troop", "trp_brigand_lord", "trp_end_orc_uruk_troll"),
    (val_mul, reg5, -1),
    (troop_raise_proficiency_linear, ":troop", 0, reg5),
    (troop_raise_proficiency_linear, ":troop", 1, reg5),
    (troop_raise_proficiency_linear, ":troop", 2, reg5),
    (troop_raise_proficiency_linear, ":troop", 3, reg5),
    (troop_raise_proficiency_linear, ":troop", 4, reg5),
    (troop_raise_proficiency_linear, ":troop", 5, reg5),
(try_end),
]), 

#script_increase_npc_weapon_skills
("increase_npc_weapon_skills",[
(try_for_range, ":troop", "trp_brigand_lord", "trp_end_orc_uruk_troll"),
    (troop_raise_proficiency_linear, ":troop", 0, reg5),
    (troop_raise_proficiency_linear, ":troop", 1, reg5),
    (troop_raise_proficiency_linear, ":troop", 2, reg5),
    (troop_raise_proficiency_linear, ":troop", 3, reg5),
    (troop_raise_proficiency_linear, ":troop", 4, reg5),
    (troop_raise_proficiency_linear, ":troop", 5, reg5),
(try_end),
]), 

#script_reduce_orc_combat_skills
("reduce_orc_combat_skills",[
(try_for_range, ":troop", "trp_orc_snaga_of_isengard", "trp_end_orc_uruk_troll"),
    (store_skill_level, reg2, 19, ":troop"),
    (val_min, reg2, reg5),
    (val_mul, reg2, -1),
    (troop_raise_skill, ":troop", 19, reg2),
    (store_skill_level, reg2, 20, ":troop"),
    (val_min, reg2, reg5),
    (val_mul, reg2, -1),
    (troop_raise_skill, ":troop", 20, reg2),
(try_end),
]), 

#script_increase_orc_combat_skills
("increase_orc_combat_skills",[
(try_for_range, ":troop", "trp_orc_snaga_of_isengard", "trp_end_orc_uruk_troll"),
    (store_skill_level, reg2, 19, ":troop"),
    (assign, reg3, 10),
    (val_sub, reg3, reg2),
    (val_min, reg3, reg5),
    (troop_raise_skill, ":troop", 19, reg3),
    (store_skill_level, reg2, 20, ":troop"),
    (assign, reg3, 10),
    (val_sub, reg3, reg2),
    (val_min, reg3, reg5),
    (troop_raise_skill, ":troop", 20, reg3),
(try_end),
]), 

#script_reduce_orc_weapon_skills
("reduce_orc_weapon_skills",[
(try_for_range, ":troop", "trp_orc_snaga_of_isengard", "trp_end_orc_uruk_troll"),
    (val_mul, reg5, -1),
    (troop_raise_proficiency_linear, ":troop", 0, reg5),
    (troop_raise_proficiency_linear, ":troop", 1, reg5),
    (troop_raise_proficiency_linear, ":troop", 2, reg5),
    (troop_raise_proficiency_linear, ":troop", 3, reg5),
    (troop_raise_proficiency_linear, ":troop", 4, reg5),
    (troop_raise_proficiency_linear, ":troop", 5, reg5),
(try_end),
]), 

#script_increase_orc_weapon_skills
("increase_orc_weapon_skills",[
(try_for_range, ":troop", "trp_orc_snaga_of_isengard", "trp_end_orc_uruk_troll"),
    (troop_raise_proficiency_linear, ":troop", 0, reg5),
    (troop_raise_proficiency_linear, ":troop", 1, reg5),
    (troop_raise_proficiency_linear, ":troop", 2, reg5),
    (troop_raise_proficiency_linear, ":troop", 3, reg5),
    (troop_raise_proficiency_linear, ":troop", 4, reg5),
    (troop_raise_proficiency_linear, ":troop", 5, reg5),
(try_end),
]), 

#script_flush_fallen_prisoners
("flush_fallen_prisoners",[
(try_begin),
    (eq, reg20, "fac_rohan"),
    (assign, reg13, "pt_mordor_caravan"),
    (assign, reg14, "pt_ithilien_rangers"),
  (else_try),
    (eq, reg20, "fac_lorien"),
    (assign, reg13, "pt_mordor_caravan"),
    (assign, reg14, "pt_ithilien_rangers"),
  (else_try),
    (eq, reg20, "fac_dunland"),
    (assign, reg13, "pt_brigand_company"),
    (assign, reg14, "pt_gondor_remnant"),
  (else_try),
    (eq, reg20, "fac_umbar"),
    (assign, reg13, "pt_brigand_company"),
    (assign, reg14, "pt_gondor_remnant"),
  (else_try),
    (eq, reg20, "fac_easterling"),
    (assign, reg13, "pt_brigand_company"),
    (assign, reg14, "pt_gondor_remnant"),
  (else_try),
    (eq, reg20, "fac_moria"),
    (assign, reg13, "pt_brigand_company"),
    (assign, reg14, "pt_gondor_remnant"),
(try_end),
(try_for_range, reg0, reg13, reg14),
    (store_num_parties_of_template, reg15, reg0),
    (val_add, reg15, 1),
(try_for_range, reg16, 1, reg15),
        (store_random_party_of_template, reg1, reg0),
        (gt, reg1, 0),
        (party_get_num_prisoners, reg2, reg1),
        (ge, reg2, 1),
    (try_for_range, reg3, "trp_brigand_lord", "trp_end_orc_uruk_troll"),
            (store_troop_count_prisoners, reg4, reg3, reg1),
            (ge, reg4, 1),
            (store_troop_faction, reg10, reg3),
            (eq, reg10, reg20),
            (party_remove_prisoners, reg1, reg3, reg4),
        (try_end),
    (try_end),
(try_end),
]), 

#script_flush_imprisoned_heroes
("flush_imprisoned_heroes",[
(store_script_param_1, ":local0"),
(try_for_range, ":local1", companions_begin, companions_end),
    (troop_get_slot, ":local2", ":local1", 0),
    (neg|eq, ":local2", 5),
    (is_between, ":local2", 6, 10),
    (try_begin),
        (eq, ":local0", "fac_rohan"),
        (eq, ":local2", 6),
        (troop_set_slot, ":local1", 0, 5),
        (call_script, "script_flush_imprisoned_heroes_b", ":local1", 0),
        (str_store_troop_name, 1, ":local1"),
        (str_store_faction_name, 2, ":local0"),
        (display_message, "@{s1}_was_killed_in_the_fall_of_{s2}!", 0),
      (else_try),
        (eq, ":local0", "fac_lorien"),
        (eq, ":local2", 7),
        (troop_set_slot, ":local1", 0, 5),
        (call_script, "script_flush_imprisoned_heroes_b", ":local1", 0),
        (str_store_troop_name, 1, ":local1"),
        (str_store_faction_name, 2, ":local0"),
        (display_message, "@{s1}_was_killed_in_the_fall_of_{s2}!", 0),
      (else_try),
        (eq, ":local0", "fac_isengard"),
        (eq, ":local2", 8),
        (troop_set_slot, ":local1", 0, 5),
        (call_script, "script_flush_imprisoned_heroes_b", ":local1", 0),
        (str_store_troop_name, 1, ":local1"),
        (str_store_faction_name, 2, ":local0"),
        (display_message, "@{s1}_was_killed_in_the_fall_of_{s2}!", 0),
      (else_try),
        (eq, ":local0", "fac_harad"),
        (eq, ":local2", 9),
        (troop_set_slot, ":local1", 0, 5),
        (call_script, "script_flush_imprisoned_heroes_b", ":local1", 0),
        (str_store_troop_name, 1, ":local1"),
        (str_store_faction_name, 2, ":local0"),
        (display_message, "@{s1}_was_killed_in_the_fall_of_{s2}!", 0),
      (else_try),
        (eq, ":local0", "fac_imladris"),
        (eq, ":local2", 10),
        (troop_set_slot, ":local1", 0, 5),
        (call_script, "script_flush_imprisoned_heroes_b", ":local1", 0),
        (str_store_troop_name, 1, ":local1"),
        (str_store_faction_name, 2, ":local0"),
        (display_message, "@{s1}_was_killed_in_the_fall_of_{s2}!", 0),
    (try_end),
(try_end),
]), 

#script_flush_imprisoned_heroes_b
("flush_imprisoned_heroes_b",[
(store_script_param_1, ":local0"),
(try_begin),
    (eq, ":local0", "trp_haldir"),
    (troop_set_slot, "trp_map_haldir", 0, 5),
  (else_try),
    (eq, ":local0", "trp_orophin"),
    (troop_set_slot, "trp_map_orophin", 0, 5),
  (else_try),
    (eq, ":local0", "trp_miriel"),
    (troop_set_slot, "trp_map_miriel", 0, 5),
  (else_try),
    (eq, ":local0", "trp_elladan"),
    (troop_set_slot, "trp_map_elladan", 0, 5),
  (else_try),
    (eq, ":local0", "trp_elrohir"),
    (troop_set_slot, "trp_map_elrohir", 0, 5),
  (else_try),
    (eq, ":local0", "trp_glorfindel"),
    (troop_set_slot, "trp_map_glorfindel", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_celeborn"),
    (troop_set_slot, "trp_map_celeborn", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_grimbold"),
    (troop_set_slot, "trp_map_lord_grimbold", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_erkenbrand"),
    (troop_set_slot, "trp_map_lord_erkenbrand", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_freca"),
    (troop_set_slot, "trp_map_lord_freca", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_eowine"),
    (troop_set_slot, "trp_map_lord_eowine", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_deorhelm"),
    (troop_set_slot, "trp_map_lord_deorhelm", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_fastred"),
    (troop_set_slot, "trp_map_lord_fastred", 0, 5),
  (else_try),
    (eq, ":local0", "trp_king_theoden"),
    (troop_set_slot, "trp_map_king_theoden", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_eomer"),
    (troop_set_slot, "trp_map_lord_eomer", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_dunhere"),
    (troop_set_slot, "trp_map_lord_dunhere", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_elfhelm"),
    (troop_set_slot, "trp_map_lord_elfhelm", 0, 5),
  (else_try),
    (eq, ":local0", "trp_hama"),
    (troop_set_slot, "trp_map_hama", 0, 5),
  (else_try),
    (eq, ":local0", "trp_guthlaf"),
    (troop_set_slot, "trp_map_guthlaf", 0, 5),
  (else_try),
    (eq, ":local0", "trp_deorwine"),
    (troop_set_slot, "trp_map_deorwine", 0, 5),
  (else_try),
    (eq, ":local0", "trp_eowyn"),
    (troop_set_slot, "trp_map_eowyn", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_malvogil"),
    (troop_set_slot, "trp_map_lord_malvogil", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_halbarad"),
    (troop_set_slot, "trp_map_lord_halbarad", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_imrahil"),
    (troop_set_slot, "trp_map_lord_imrahil", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_orthalion"),
    (troop_set_slot, "trp_map_lord_orthalion", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_aravir"),
    (troop_set_slot, "trp_map_lord_aravir", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_hirluin"),
    (troop_set_slot, "trp_map_lord_hirluin", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_faramir"),
    (troop_set_slot, "trp_map_lord_faramir", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_forlong"),
    (troop_set_slot, "trp_map_lord_forlong", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_hallas"),
    (troop_set_slot, "trp_map_lord_hallas", 0, 5),
  (else_try),
    (eq, ":local0", "trp_lord_dirhael"),
    (troop_set_slot, "trp_map_lord_dirhael", 0, 5),
  (else_try),
    (eq, ":local0", "trp_ul_ulcari"),
    (troop_set_slot, "trp_map_ul_ulcari", 0, 5),
  (else_try),
    (eq, ":local0", "trp_varoujan"),
    (troop_set_slot, "trp_map_varoujan", 0, 5),
  (else_try),
    (eq, ":local0", "trp_khamul"),
    (troop_set_slot, "trp_map_khamul", 0, 5),
  (else_try),
    (eq, ":local0", "trp_captain_tulmir"),
    (troop_set_slot, "trp_map_captain_tulmir", 0, 5),
  (else_try),
    (eq, ":local0", "trp_warden_of_the_vale"),
    (troop_set_slot, "trp_map_warden_of_the_vale", 0, 5),
  (else_try),
    (eq, ":local0", "trp_captain_mortakh"),
    (troop_set_slot, "trp_map_captain_mortakh", 0, 5),
  (else_try),
    (eq, ":local0", "trp_duessa"),
    (troop_set_slot, "trp_map_duessa", 0, 5),
  (else_try),
    (eq, ":local0", "trp_daeglaf_the_black"),
    (troop_set_slot, "trp_map_daeglaf_the_black", 0, 5),
  (else_try),
    (eq, ":local0", "trp_ugluk"),
    (troop_set_slot, "trp_map_ugluk", 0, 5),
  (else_try),
    (eq, ":local0", "trp_mauhur"),
    (troop_set_slot, "trp_map_mauhur", 0, 5),
  (else_try),
    (eq, ":local0", "trp_mog_the_hunter"),
    (troop_set_slot, "trp_map_mog_the_hunter", 0, 5),
  (else_try),
    (eq, ":local0", "trp_general_tuskim"),
    (troop_set_slot, "trp_map_general_tuskim", 0, 5),
  (else_try),
    (eq, ":local0", "trp_bolg_the_lesser"),
    (troop_set_slot, "trp_map_bolg_the_lesser", 0, 5),
]), 

#script_flush_prisoners_from_neutrals
("flush_prisoners_from_neutrals",[
(try_for_range, reg0, "pt_brigand_company", "pt_ithilien_rangers"),
    (store_num_parties_of_template, reg15, reg0),
    (val_add, reg15, 1),
    (try_for_range, reg16, 1, reg15),
        (store_random_party_of_template, reg1, reg0),
        (gt, reg1, 0),
        (party_get_num_prisoners, reg2, reg1),
        (ge, reg2, 1),
        (try_for_range, reg3, "trp_brigand_lord", "trp_end_orc_uruk_troll"),
            (store_troop_count_prisoners, reg4, reg3, reg1),
            (ge, reg4, 1),
            (party_remove_prisoners, reg1, reg3, reg4),
        (try_end),
    (try_end),
(try_end),
]), 

#script_capture_routine
("capture_routine",[
(store_encountered_party, reg6),
(store_faction_of_party, reg5, reg6),
    (try_begin),
    (gt, "$g_encountered_party_2", 0),
    (store_faction_of_party, ":local0", "$g_enemy_party"),
    (else_try),
    (store_faction_of_party, ":local0", "$g_encountered_party"),
(try_end),
(assign, ":local1", 0),
(assign, ":local2", 0),
    (try_begin),
    (eq, ":local0", "fac_mordor"),
    (assign, ":local1", 3),
    (else_try),
    (eq, ":local0", "fac_haradrim"),
    (assign, ":local1", 3),
    (else_try),
    (eq, ":local0", "fac_easterlings"),
    (assign, ":local1", 3),
    (else_try),
    (eq, ":local0", "fac_corsairs"),
    (assign, ":local1", 3),
    (else_try),
    (eq, ":local0", "fac_dol_guldur"),
    (assign, ":local1", 3),
    (else_try),
    (eq, ":local0", "fac_isengard"),
    (assign, ":local1", 4),
    (else_try),
    (eq, ":local0", "fac_dunlanders"),
    (assign, ":local1", 4),
    (else_try),
    (eq, ":local0", "fac_moria"),
    (assign, ":local1", 4),
    (else_try),
    (eq, ":local0", "fac_rohan"),
    (assign, ":local1", 2),
    (else_try),
    (eq, ":local0", "fac_gondor"),
    (assign, ":local1", 1),
(try_end),
(neg|eq, ":local1", 0),
(get_player_agent_no, ":local3"),
    (try_for_agents, "$agent"),
    (neg|eq, "$agent", ":local3"),
    (agent_is_ally, "$agent"),
    (agent_is_human, "$agent"),
    (agent_get_troop_id, ":local4", "$agent"),
        (try_for_range, ":local5", "trp_mablung", "trp_test_hero"),
        (store_troop_count_companions, ":local6", ":local5", "p_main_party"),
        (eq, ":local6", 1),
        (eq, ":local4", ":local5"),
        (troop_get_slot, ":local7", ":local5", 0),
        (neg|eq, ":local7", 5),
        (store_agent_hit_points, ":local8", "$agent", 0),
        (eq, ":local8", 0),
        (assign|shuffle_range, ":local9", 100, 0),
        (neg|gt, ":local9", "$capture_setting"),
        (assign, ":local10", ":local1"),
        (val_add, ":local10", 5),
        (troop_set_slot, ":local5", 0, ":local10"),
        (str_store_troop_name, 1, ":local5"),
        (display_message, "@{s1}_has_been_captured_by_the_enemy.", 4294901760),
        (assign, "$hero_captured_in_battle", 1),
            (try_begin),
            (eq, ":local1", 1),
            (val_add, "$heroes_captured_by_gondor", 1),
            (str_store_party_name, 2, "$minas_tirith"),
            (display_message, "@Gondor_takes_a_captive", 0),
            (else_try),
            (eq, ":local1", 2),
            (val_add, "$heroes_captured_by_rohan", 1),
            (str_store_party_name, 2, "$hornburg"),
            (display_message, "@Rohan_takes_a_captive", 0),
            (else_try),
            (eq, ":local1", 3),
            (val_add, "$heroes_captured_by_mordor", 1),
            (str_store_party_name, 2, "p_minas_morgul"),
            (display_message, "@Mordor_takes_a_captive", 0),
            (else_try),
            (eq, ":local1", 4),
            (val_add, "$heroes_captured_by_isengard", 1),
            (str_store_party_name, 2, "p_isengard"),
            (display_message, "@Isengard_takes_a_captive", 0),
        (try_end),
    (try_end),
(try_end),
]), 

#script_hero_removal
("hero_removal",[
    (try_begin),
    (eq, "$hero_captured_in_battle", 1),
    (assign, "$hero_captured_in_battle", 0),
    (assign, ":local0", 0),
        (try_for_range, ":local1", "trp_mablung", "trp_test_hero"),
        (troop_get_slot, ":local2", ":local1", 0),
        (neg|eq, ":local2", 5),
        (is_between, ":local2", 6, 10),
        (store_troop_count_companions, ":local3", ":local1", "p_main_party"),
        (eq, ":local3", 1),
        (party_remove_members, "p_main_party", ":local1", 1),
    (try_end),
(try_end),
    (try_begin),
    (eq, "$hero_killed_in_battle", 1),
    (assign, "$hero_killed_in_battle", 0),
    (assign, ":local0", 0),
        (try_for_range, ":local1", "trp_mablung", "trp_test_hero"),
        (troop_get_slot, ":local2", ":local1", 0),
        (eq, ":local2", 5),
        (store_troop_count_companions, ":local3", ":local1", "p_main_party"),
        (eq, ":local3", 1),
        (party_remove_members, "p_main_party", ":local1", 1),
    (try_end),
(try_end),
]), 

#script_injury_routine
("injury_routine",[
    (try_for_range, ":npc", companions_begin, companions_end),
    (store_troop_count_companions, ":local1", ":npc", "p_main_party"),
    (eq, ":local1", 1),
    (assign|shuffle_range, ":local2", "$wound_setting", 0),
    (troop_get_slot, ":local3", ":npc", 2),
    (troop_get_slot, ":local4", ":npc", 3),
    (troop_get_slot, ":local5", ":npc", 4),
    (troop_get_slot, ":local6", ":npc", 5),
    (troop_get_slot, ":local7", ":npc", 1),
    (str_store_troop_name, 1, ":npc"),
        (try_begin),
        (eq, ":local2", 0),
        (eq, ":local3", 0),
        (store_skill_level, ":local8", 13, ":npc"),
        (store_skill_level, ":local9", 14, ":npc"),
        (troop_set_slot, ":npc", 18, ":local8"),
        (troop_set_slot, ":npc", 19, ":local9"),
        (val_min, ":local8", 1),
        (val_mul, ":local8", -1),
        (val_min, ":local9", 2),
        (val_mul, ":local9", -1),
        (troop_raise_skill, ":npc", 13, ":local8"),
        (troop_raise_skill, ":npc", 14, ":local9"),
        (troop_raise_attribute, ":npc", 1, -2),
        (troop_raise_proficiency_linear, ":npc", 0, -15),
        (troop_raise_proficiency_linear, ":npc", 1, -15),
        (troop_raise_proficiency_linear, ":npc", 2, -15),
        (val_add, ":local7", 1),
        (troop_set_slot, ":npc", 1, ":local7"),
        (troop_set_slot, ":npc", 2, 1),
        (display_message, "@{s1}_has_suffered_a_serious_wound.", 4294901760),
        (display_message, "@His_leg_has_been_badly_maimed_in_battle.", 0),
        (display_message, "@(-2_athletics,_-1_riding,_-2_agility,_-15_melee_skill)", 0),
        (else_try),
        (eq, ":local2", 1),
        (eq, ":local4", 0),
        (store_skill_level, ":local10", 17, ":npc"),
        (store_skill_level, ":local11", 18, ":npc"),
        (store_skill_level, ":local12", 19, ":npc"),
        (troop_set_slot, ":npc", 6, ":local10"),
        (troop_set_slot, ":npc", 8, ":local11"),
        (troop_set_slot, ":npc", 9, ":local12"),
        (val_min, ":local10", 1),
        (val_mul, ":local10", -1),
        (val_min, ":local11", 1),
        (val_mul, ":local11", -1),
        (val_min, ":local12", 1),
        (val_mul, ":local12", -1),
        (troop_raise_skill, ":npc", 17, ":local10"),
        (troop_raise_skill, ":npc", 18, ":local11"),
        (troop_raise_skill, ":npc", 19, ":local12"),
        (troop_raise_proficiency_linear, ":npc", 0, -20),
        (troop_raise_proficiency_linear, ":npc", 1, -20),
        (troop_raise_proficiency_linear, ":npc", 2, -20),
        (troop_raise_proficiency_linear, ":npc", 3, -20),
        (troop_raise_proficiency_linear, ":npc", 4, -20),
        (troop_raise_proficiency_linear, ":v", 5, -20),
        (troop_raise_attribute, ":npc", 0, -2),
        (val_add, ":local7", 1),
        (troop_set_slot, ":npc", 1, ":local7"),
        (troop_set_slot, ":npc", 3, 1),
        (display_message, "@{s1}_has_suffered_a_serious_wound.", 4294901760),
        (display_message, "@His_arm_has_been_badly_maimed_in_battle.", 0),
        (display_message, "@(-20_weapon_skill,_-2_strength,_-1_power_attacks)", 0),
        (else_try),
        (eq, ":local2", 2),
        (eq, ":local5", 0),
        (store_skill_level, ":local13", 0, ":npc"),
        (store_skill_level, ":local14", 3, ":npc"),
        (store_skill_level, ":local15", 4, ":npc"),
        (store_skill_level, ":local16", 5, ":npc"),
        (store_skill_level, ":local17", 7, ":npc"),
        (store_skill_level, ":local18", 8, ":npc"),
        (store_skill_level, ":local19", 9, ":npc"),
        (store_skill_level, ":local20", 10, ":npc"),
        (store_skill_level, ":local21", 11, ":npc"),
        (troop_set_slot, ":npc", 10, ":local13"),
        (troop_set_slot, ":npc", 12, ":local14"),
        (troop_set_slot, ":npc", 10, ":local15"),
        (troop_set_slot, ":npc", 11, ":local16"),
        (troop_set_slot, ":npc", 13, ":local17"),
        (troop_set_slot, ":npc", 15, ":local18"),
        (troop_set_slot, ":npc", 16, ":local19"),
        (troop_set_slot, ":npc", 14, ":local20"),
        (troop_set_slot, ":npc", 17, ":local21"),
        (val_min, ":local13", 1),
        (val_mul, ":local13", -1),
        (val_min, ":local14", 1),
        (val_mul, ":local14", -1),
        (val_min, ":local15", 1),
        (val_mul, ":local15", -1),
        (val_min, ":local16", 1),
        (val_mul, ":local16", -1),
        (val_min, ":local17", 1),
        (val_mul, ":local17", -1),
        (val_min, ":local18", 1),
        (val_mul, ":local18", -1),
        (val_min, ":local19", 1),
        (val_mul, ":local19", -1),
        (val_min, ":local20", 1),
        (val_mul, ":local20", -1),
        (val_min, ":local21", 1),
        (val_mul, ":local21", -1),
        (troop_raise_skill, ":npc", 0, ":local13"),
        (troop_raise_skill, ":npc", 5, ":local16"),
        (troop_raise_skill, ":npc", 9, ":local19"),
        (troop_raise_skill, ":npc", 3, ":local14"),
        (troop_raise_skill, ":npc", 7, ":local17"),
        (troop_raise_skill, ":npc", 10, ":local20"),
        (troop_raise_skill, ":npc", 4, ":local15"),
        (troop_raise_skill, ":npc", 8, ":local18"),
        (troop_raise_skill, ":npc", 11, ":local21"),
        (troop_raise_proficiency_linear, ":npc", 3, -15),
        (troop_raise_proficiency_linear, ":npc", 4, -15),
        (troop_raise_proficiency_linear, ":npc", 5, -15),
        (val_add, ":local7", 1),
        (troop_set_slot, ":npc", 1, ":local7"),
        (troop_set_slot, ":npc", 4, 1),
        (display_message, "@{s1}_has_suffered_a_serious_wound.", 4294901760),
        (display_message, "@His_has_suffered_a_heavy_blow_to_the_head.", 0),
        (display_message, "@(-1_intelligence_skills,_-15_missile_skill)", 0),
        (else_try),
        (eq, ":local2", 3),
        (eq, ":local6", 0),
        (troop_raise_proficiency_linear, ":npc", 0, -20),
        (troop_raise_proficiency_linear, ":npc", 1, -20),
        (troop_raise_proficiency_linear, ":npc", 2, -20),
        (troop_raise_proficiency_linear, ":npc", 3, -20),
        (troop_raise_proficiency_linear, ":npc", 4, -20),
        (troop_raise_proficiency_linear, ":npc", 5, -20),
        (val_add, ":local7", 1),
        (troop_set_slot, ":npc", 1, ":local7"),
        (troop_set_slot, ":npc", 5, 1),
        (display_message, "@{s1}_has_suffered_a_serious_wound.", 4294901760),
        (display_message, "@His_chest_has_suffered_some_cracked_ribs.", 0),
        (display_message, "@(-20_weapon_skill)", 0),
        (else_try),
        (eq, ":local2", 4),
        (eq, "$death_setting", 1),
        (assign, ":local22", 10),
        (val_mul, ":local22", ":local7"),
        (assign|shuffle_range, ":local2", 100, 0),
        (neg|ge, ":local2", ":local22"),
        (display_message, "@{s1}_has_been_killed.", 4294901760),
        (assign, "$hero_killed_in_battle", 1),
        (troop_set_slot, ":npc", 0, 5),
        (call_script, "script_build_mound_for_dead_hero", ":npc", 0),
    (try_end),
(try_end),
]), 

#script_healing_routine
("healing_routine",[
    (try_for_range, ":npc", companions_begin, companions_end),
    (troop_get_slot, ":slot0", ":npc", 0),
    (neg|eq, ":slot0", 5), # not killed in battle
    (store_random, ":local2", "$healing_setting"),
    (troop_get_slot, ":local7", ":npc", 1),
    (troop_get_slot, ":local3", ":npc", 2),
    (troop_get_slot, ":local4", ":npc", 3),
    (troop_get_slot, ":local5", ":npc", 4),
    (troop_get_slot, ":local6", ":npc", 5),
    (str_store_troop_name, 1, ":npc"),
    (try_begin),
        (eq, ":local2", 0),
        (eq, ":local3", 1),
        (assign, ":local8", 10),
        (assign, ":local9", 10),
        (store_skill_level, ":local10", 13, ":npc"),
        (store_skill_level, ":local11", 14, ":npc"),
        (val_sub, ":local8", ":local10"),
        (val_min, ":local8", 1),
        (val_sub, ":local9", ":local11"),
        (val_min, ":local9", 2),
        (troop_get_slot, ":local12", ":npc", 18),
        (val_min, ":local8", ":local12"),
        (troop_get_slot, ":local13", ":npc", 19),
        (val_min, ":local9", ":local13"),
        (troop_raise_skill, ":npc", 13, ":local8"),
        (troop_raise_skill, ":npc", 14, ":local9"),
        (troop_raise_attribute, ":npc", 1, 2),
        (troop_raise_proficiency_linear, ":npc", 0, 15),
        (troop_raise_proficiency_linear, ":npc", 1, 15),
        (troop_raise_proficiency_linear, ":npc", 2, 15),
        (val_sub, ":local7", 1),
        (troop_set_slot, ":npc", 1, ":local7"),
        (troop_set_slot, ":npc", 2, 0),
        (display_message, "@{s1}_has_recovered_from_a_serious_wound.", 4284901119),
        (display_message, "@His_leg_wound_has_healed.", 0),
        (display_message, "@(+2_athletics,_+1_riding,_+2_agility,_+15_melee_skill)", 0),
        (store_troop_health, ":local14", ":npc", 0),
        (val_add, ":local14", 10),
        (troop_set_health, ":npc", ":local14"),
        (else_try),
        (eq, ":local2", 1),
        (eq, ":local4", 1),
        (assign, ":local15", 10),
        (assign, ":local16", 10),
        (assign, ":local17", 10),
        (store_skill_level, ":local18", 17, ":npc"),
        (store_skill_level, ":local19", 18, ":npc"),
        (store_skill_level, ":local20", 19, ":npc"),
        (val_sub, ":local15", ":local18"),
        (val_min, ":local15", 1),
        (val_sub, ":local16", ":local19"),
        (val_min, ":local16", 1),
        (val_sub, ":local17", ":local20"),
        (val_min, ":local17", 1),
        (troop_get_slot, ":local21", ":npc", 6),
        (val_min, ":local15", ":local21"),
        (troop_get_slot, ":local22", ":npc", 8),
        (val_min, ":local16", ":local22"),
        (troop_get_slot, ":local23", ":npc", 9),
        (val_min, ":local17", ":local23"),
        (troop_raise_skill, ":npc", 17, ":local15"),
        (troop_raise_skill, ":npc", 18, ":local16"),
        (troop_raise_skill, ":npc", 19, ":local17"),
        (troop_raise_proficiency_linear, ":npc", 0, 20),
        (troop_raise_proficiency_linear, ":npc", 1, 20),
        (troop_raise_proficiency_linear, ":npc", 2, 20),
        (troop_raise_proficiency_linear, ":npc", 3, 20),
        (troop_raise_proficiency_linear, ":npc", 4, 20),
        (troop_raise_proficiency_linear, ":npc", 5, 20),
        (troop_raise_attribute, ":npc", 0, 2),
        (val_sub, ":local7", 1),
        (troop_set_slot, ":npc", 1, ":local7"),
        (troop_set_slot, ":npc", 3, 0),
        (display_message, "@{s1}_has_recovered_from_a_serious_wound.", 4284901119),
        (display_message, "@His_arm_wound_has_healed.", 0),
        (display_message, "@(+20_weapon_skill,_+2_strength,_+1_power_attacks)", 0),
        (store_troop_health, ":local14", ":npc", 0),
        (val_add, ":local14", 10),
        (troop_set_health, ":npc", ":local14"),
        (else_try),
        (eq, ":local2", 2),
        (eq, ":local5", 1),
        (assign, ":local24", 10),
        (assign, ":local25", 10),
        (assign, ":local26", 10),
        (assign, ":local27", 10),
        (assign, ":local28", 10),
        (assign, ":local29", 10),
        (assign, ":local30", 10),
        (assign, ":local31", 10),
        (assign, ":local32", 10),
        (store_skill_level, ":local33", 0, ":npc"),
        (val_sub, ":local24", ":local33"),
        (val_min, ":local24", 1),
        (store_skill_level, ":local34", 3, ":npc"),
        (val_sub, ":local27", ":local34"),
        (val_min, ":local27", 1),
        (store_skill_level, ":local35", 4, ":npc"),
        (val_sub, ":local30", ":local35"),
        (val_min, ":local30", 1),
        (store_skill_level, ":local36", 5, ":npc"),
        (val_sub, ":local25", ":local36"),
        (val_min, ":local25", 1),
        (store_skill_level, ":local37", 8, ":npc"),
        (val_sub, ":local28", ":local37"),
        (val_min, ":local28", 1),
        (store_skill_level, ":local38", 7, ":npc"),
        (val_sub, ":local31", ":local38"),
        (val_min, ":local31", 1),
        (store_skill_level, ":local39", 10, ":npc"),
        (val_sub, ":local26", ":local39"),
        (val_min, ":local26", 1),
        (store_skill_level, ":local40", 9, ":npc"),
        (val_sub, ":local29", ":local40"),
        (val_min, ":local29", 1),
        (store_skill_level, ":local41", 11, ":npc"),
        (val_sub, ":local32", ":local41"),
        (val_min, ":local32", 1),
        (troop_get_slot, ":local42", ":npc", 10),
        (val_min, ":local24", ":local42"),
        (troop_get_slot, ":local43", ":npc", 12),
        (val_min, ":local27", ":local43"),
        (troop_get_slot, ":local44", ":npc", 10),
        (val_min, ":local30", ":local44"),
        (troop_get_slot, ":local45", ":npc", 15),
        (val_min, ":local28", ":local45"),
        (troop_get_slot, ":local46", ":npc", 13),
        (val_min, ":local31", ":local46"),
        (troop_get_slot, ":local47", ":npc", 14),
        (val_min, ":local26", ":local47"),
        (troop_get_slot, ":local48", ":npc", 16),
        (val_min, ":local29", ":local48"),
        (troop_get_slot, ":local49", ":npc", 17),
        (val_min, ":local32", ":local49"),
        (troop_get_slot, ":local50", ":npc", 11),
        (val_min, ":local25", ":local50"),
        (troop_raise_skill, ":npc", 0, ":local24"),
        (troop_raise_skill, ":npc", 5, ":local25"),
        (troop_raise_skill, ":npc", 9, ":local29"),
        (troop_raise_skill, ":npc", 3, ":local27"),
        (troop_raise_skill, ":npc", 7, ":local31"),
        (troop_raise_skill, ":npc", 10, ":local26"),
        (troop_raise_skill, ":npc", 4, ":local30"),
        (troop_raise_skill, ":npc", 8, ":local28"),
        (troop_raise_skill, ":npc", 11, ":local32"),
        (troop_raise_proficiency_linear, ":npc", 3, 15),
        (troop_raise_proficiency_linear, ":npc", 4, 15),
        (troop_raise_proficiency_linear, ":npc", 5, 15),
        (val_sub, ":local7", 1),
        (troop_set_slot, ":npc", 1, ":local7"),
        (troop_set_slot, ":npc", 4, 0),
        (display_message, "@{s1}_has_recovered_from_a_serious_wound.", 4284901119),
        (display_message, "@His_head_wound_has_healed.", 0),
        (display_message, "@(+1_intelligence_skills,_+15_missile_skill)", 0),
        (store_troop_health, ":local14", ":npc", 0),
        (val_add, ":local14", 10),
        (troop_set_health, ":npc", ":local14"),
        (else_try),
        (eq, ":local2", 3),
        (eq, ":local6", 1),
        (troop_raise_proficiency_linear, ":npc", 0, 20),
        (troop_raise_proficiency_linear, ":npc", 1, 20),
        (troop_raise_proficiency_linear, ":npc", 2, 20),
        (troop_raise_proficiency_linear, ":npc", 3, 20),
        (troop_raise_proficiency_linear, ":npc", 4, 20),
        (troop_raise_proficiency_linear, ":npc", 5, 20),
        (val_sub, ":local7", 1),
        (troop_set_slot, ":npc", 1, ":local7"),
        (troop_set_slot, ":npc", 5, 0),
        (display_message, "@{s1}_has_recovered_from_a_serious_wound.", 4284901119),
        (display_message, "@His_cracked_ribs_have_healed.", 0),
        (display_message, "@(+20_weapon_skill)", 0),
        (store_troop_health, ":local14", ":npc", 0),
        (val_add, ":local14", 10),
        (troop_set_health, ":npc", ":local14"),
    (try_end),
(try_end),
]), 

#script_heal_party
("heal_party",[
(store_random, ":rnd", 4),
(try_begin),
    (eq, ":rnd", 0),
    (heal_party, 0),
(else_try),
    (try_for_range, ":npc", companions_begin, companions_end),
        (party_count_companions_of_type, ":num", "p_main_party", ":npc"),
        (eq, ":num", 1),
        (store_troop_health, ":hp", ":npc", 0),
        (val_mul, ":hp", 10),
        (val_div, ":hp", 7),
        (troop_set_health, ":npc", ":hp"),
    (try_end),
    (store_troop_health, ":hp", "trp_player", 0),
    (val_mul, ":hp", 10),
    (val_div, ":hp", 7),
    (troop_set_health, "trp_player", ":hp"),
(try_end),
]), 

#script_give_party_heroes_battle_rewards
("give_party_heroes_battle_rewards",[
(get_player_agent_no, reg20),
(assign, reg44, 0),
(try_for_agents, ":agent"),
    (neg|eq, ":agent", reg20),
    (agent_is_human, ":agent"),
    (agent_is_alive|neg, ":agent"),
    (agent_is_ally|neg, ":agent"),
    (val_add, reg44, 1),
(try_end),
(assign, reg11, reg44),
(val_mul, reg11, 3),
(assign, reg12, reg44),
(val_mul, reg12, 4),
(assign, reg27, 0),
(try_begin),
    (gt, reg44, 10),
    (val_div, reg44, 10),
    (call_script, "script_update_influence_count", reg44, 0),
    (display_message, "@Your_prowess_was_noted_(+{reg44}_influence).", 4282811060),
(try_end),
(try_for_range, ":npc", companions_begin, companions_end),
    (main_party_has_troop, ":npc"),
    (troop_add_gold, ":npc", reg12),
    (add_xp_to_troop, reg11, ":npc"),
(try_end),
]), 

#script_arena_cheers
("arena_cheers",[
(assign, reg40, 0),
(assign, reg41, 0),
    (try_for_agents, reg5),
    (neg|eq, reg5, reg20),
    (agent_is_human, reg5),
    (agent_is_alive|neg, reg5),
        (try_begin),
        (agent_is_ally|neg, reg5),
        (val_add, reg40, 1),
        (else_try),
        (get_player_agent_no, reg20),
        (neg|eq, reg5, reg20),
        (val_add, reg41, 1),
    (try_end),
(try_end),
    (try_begin),
    (gt, reg40, "$enemy_reinforcement_stage"),
    (play_sound, "snd_crowd_cheer_s", 0),
    (assign, "$enemy_reinforcement_stage", reg40),
(try_end),
    (try_begin),
    (gt, reg41, "$friend_reinforcement_stage"),
    (play_sound, "snd_crowd_awww_lowvol", 0),
    (assign, "$friend_reinforcement_stage", reg41),
(try_end),
]), 

#script_initialize_sorcerer_quest
("initialize_sorcerer_quest",[
(store_random, ":local0", 10),
(assign, "$meta_alarm", ":local0"),
(assign, "$rescue_courtyard_scene_1", "scn_tld_sorcerer_forest_a"),
(assign, "$rescue_stealth_scene_1", "scn_tld_sorcerer_forest_b"),
(assign, "$rescue_final_scene", "scn_tld_sorcerer_forest_c"),
(assign, "$guard_troop1", "trp_orc_sentry"),
(assign, "$guard_troop2", "trp_orc_of_mordor"),
(assign, "$guard_troop3", "trp_wolf_rider_of_mirkwood"),
(assign, "$guard_troop4", "trp_orc_of_mordor"),
(assign, "$guard_troop5", "trp_orc_archer_of_mordor"),
(assign, "$guard_troop6", "trp_black_numenorian_acolyte"),
(assign, "$guard_troop7", "trp_large_orc_of_mordor"),
(assign, "$guard_troop8", "trp_fell_orc_of_mordor"),
(assign, "$guard_troop9", "trp_black_numenorian_acolyte"),
(assign, "$guard_troop10", "trp_olog_hai"),
(assign, "$wall_missile_troop1", "trp_orc_archer_of_mordor"),
(assign, "$wall_missile_troop2", "trp_orc_archer_of_mordor"),
(assign, "$wall_missile_troop3", "trp_large_orc_archer_of_mordor"),
(assign, "$wall_missile_troop4", "trp_large_orc_archer_of_mordor"),
(assign, "$wall_missile_troop5", "trp_fell_orc_archer_of_mordor"),
(assign, "$wall_mounted_troop1", "trp_warg_rider_of_mirkwood"),
#(assign, "$wall_mounted_troop2", "trp_wolf_rider_of_mirkwood"),
(assign, "$wall_mounted_troop3", "trp_wolf_rider_of_mirkwood"),
#(assign, "$wall_mounted_troop4", "trp_wolf_rider_of_mirkwood"),
(assign, "$wall_mounted_troop5", "trp_wolf_rider_of_mirkwood"),
]), 

#script_final_sorcerer_fight
("final_sorcerer_fight",[
(set_jump_mission, "mst_sorcerer_mission"),
(jump_to_scene, "$rescue_final_scene", 0),
(reset_visitors),
(modify_visitors_at_site, "$rescue_final_scene"),
(call_script, "script_set_infiltration_companions", 0, 0),
    (try_begin),
    (is_between, "$meta_alarm", 0, 4),
    (set_visitor, 10, "trp_black_numenorean_sorcerer", 0),
    (set_visitor, 11, "$guard_troop2", 0),
    (set_visitor, 12, "$guard_troop2", 0),
    (set_visitor, 13, "$guard_troop3", 0),
    (set_visitor, 14, "$guard_troop3", 0),
    (set_visitor, 15, "$guard_troop3", 0),
    (set_visitor, 16, "$guard_troop4", 0),
    (set_visitor, 17, "$guard_troop4", 0),
    (set_visitor, 18, "$guard_troop5", 0),
    (set_visitor, 19, "$guard_troop5", 0),
    (set_visitor, 20, "$guard_troop6", 0),
    (else_try),
    (is_between, "$meta_alarm", 4, 7),
    (set_visitor, 10, "trp_black_numenorean_sorcerer", 0),
    (set_visitor, 11, "$guard_troop3", 0),
    (set_visitor, 12, "$guard_troop3", 0),
    (set_visitor, 13, "$guard_troop4", 0),
    (set_visitor, 14, "$guard_troop4", 0),
    (set_visitor, 15, "$guard_troop4", 0),
    (set_visitor, 16, "$guard_troop5", 0),
    (set_visitor, 17, "$guard_troop5", 0),
    (set_visitor, 18, "$guard_troop6", 0),
    (set_visitor, 19, "$guard_troop6", 0),
    (set_visitor, 20, "$guard_troop7", 0),
    (else_try),
    (is_between, "$meta_alarm", 7, 9),
    (set_visitor, 10, "trp_black_numenorean_sorcerer", 0),
    (set_visitor, 11, "$guard_troop4", 0),
    (set_visitor, 12, "$guard_troop4", 0),
    (set_visitor, 13, "$guard_troop5", 0),
    (set_visitor, 14, "$guard_troop5", 0),
    (set_visitor, 15, "$guard_troop5", 0),
    (set_visitor, 16, "$guard_troop6", 0),
    (set_visitor, 17, "$guard_troop6", 0),
    (set_visitor, 18, "$guard_troop7", 0),
    (set_visitor, 19, "$guard_troop7", 0),
    (set_visitor, 20, "$guard_troop8", 0),
    (else_try),
    (ge, "$meta_alarm", 9),
    (set_visitor, 10, "trp_black_numenorean_sorcerer", 0),
    (set_visitor, 11, "$guard_troop5", 0),
    (set_visitor, 12, "$guard_troop6", 0),
    (set_visitor, 13, "$guard_troop6", 0),
    (set_visitor, 14, "$guard_troop7", 0),
    (set_visitor, 15, "$guard_troop7", 0),
    (set_visitor, 16, "$guard_troop8", 0),
    (set_visitor, 17, "$guard_troop8", 0),
    (set_visitor, 18, "$guard_troop9", 0),
    (set_visitor, 19, "$guard_troop10", 0),
    (set_visitor, 20, "$guard_troop10", 0),
(try_end),
]), 

#script_set_infiltration_companions
("set_infiltration_companions",[
(set_visitor, 0, 0, 0),
(assign, ":local0", 0),
(try_for_range, ":faction", "fac_mission_companion_1", "fac_mission_companion_10"),
    (faction_get_slot, ":local2", ":faction", 4),
    (faction_get_slot, ":local3", ":faction", 1),
    (val_add, ":local0", 1),
    (neg|eq, ":local3", 0),
    (neg|eq, ":local2", 1),
    (set_visitor, ":local0", ":local3", 0),
(try_end),
]), 

#script_set_infiltration_player_record
("set_infiltration_player_record",[
(store_troop_health, ":local0", "trp_player", 0),
(faction_set_slot, "fac_mission_companion_10", 1, "trp_player"),
(faction_set_slot, "fac_mission_companion_10", 3, ":local0"),
]), 

#script_infiltration_battle_wall
("infiltration_battle_wall",[
(set_jump_mission, "mst_battle_wall_mission"),
(jump_to_scene, "$rescue_wall_battle", 0),
(reset_visitors),
(modify_visitors_at_site, "$rescue_wall_battle"),
    (try_for_range, reg1, 10, 20),
    (store_random_in_range, reg2, 1, 6),
        (try_begin),
        (eq, reg2, 1),
        (assign, reg3, "$wall_mounted_troop1"),
        (else_try),
        (eq, reg2, 2),
        (assign, reg3, "$guard_troop3"),
        (else_try),
        (eq, reg2, 3),
        (assign, reg3, "$wall_mounted_troop3"),
        (else_try),
        (eq, reg2, 4),
        (assign, reg3, "$guard_troop4"),
        (else_try),
        (eq, reg2, 5),
        (assign, reg3, "$wall_mounted_troop5"),
    (try_end),
    (set_visitor, reg1, reg3, 0),
(try_end),
    (try_for_range, reg1, 23, 27),
    (store_random_in_range, reg2, 1, 6),
        (try_begin),
        (eq, reg2, 1),
        (assign, reg3, "$wall_missile_troop1"),
        (else_try),
        (eq, reg2, 2),
        (assign, reg3, "$wall_missile_troop2"),
        (else_try),
        (eq, reg2, 3),
        (assign, reg3, "$wall_missile_troop3"),
        (else_try),
        (eq, reg2, 4),
        (assign, reg3, "$wall_missile_troop4"),
        (else_try),
        (eq, reg2, 5),
        (assign, reg3, "$wall_missile_troop5"),
    (try_end),
    (set_visitor, reg1, reg3, 0),
(try_end),
(call_script, "script_set_infiltration_companions", 0, 0),
]), 

#script_infiltration_stealth_1
("infiltration_stealth_1",[
(set_jump_mission, "mst_infiltration_stealth_mission"),
(jump_to_scene, "$rescue_final_scene", 0),
(reset_visitors),
(modify_visitors_at_site, "$rescue_final_scene"),
(set_visitor, 0, 0, 0),
(set_visitor, 1, "$guard_troop2", 0),
(set_visitor, 3, "$guard_troop2", 0),
(set_visitor, 6, "$guard_troop2", 0),
(set_visitor, 9, "$guard_troop2", 0),
(set_visitor, 14, "$guard_troop2", 0),
(set_visitor, 16, "$guard_troop2", 0),
]), 

#script_infiltration_stealth_2
("infiltration_stealth_2",[
(set_jump_mission, "mst_infiltration_stealth_mission"),
(jump_to_scene, "$rescue_stealth_scene_1", 0),
(reset_visitors),
(modify_visitors_at_site, "$rescue_stealth_scene_1"),
(set_visitor, 0, 0, 0),
(set_visitor, 1, "$guard_troop1", 0),
(set_visitor, 3, "$guard_troop1", 0),
(set_visitor, 6, "$guard_troop1", 0),
(set_visitor, 9, "$guard_troop1", 0),
(set_visitor, 14, "$guard_troop1", 0),
(set_visitor, 16, "$guard_troop1", 0),
]), 

#script_infiltration_combat_1
("infiltration_combat_1",[
(set_jump_mission, "mst_infiltration_combat_mission"),
(jump_to_scene, "$rescue_courtyard_scene_1", 0),
(reset_visitors),
(modify_visitors_at_site, "$rescue_courtyard_scene_1"),
(call_script, "script_set_infiltration_companions", 0, 0),
(assign, reg1, "$guard_troop2"),
(assign, reg2, "$guard_troop2"),
(assign, reg3, "$guard_troop3"),
(assign, reg4, "$guard_troop3"),
(assign, reg5, "$guard_troop4"),
(assign, reg5, "$guard_troop4"),
(assign, reg7, "$guard_troop5"),
(assign, reg8, "$guard_troop5"),
(assign, reg9, "$guard_troop6"),
(assign, reg10, "$guard_troop6"),
(assign, reg11, "$guard_troop7"),
(assign, reg12, "$guard_troop7"),
(assign, reg13, "$guard_troop8"),
(assign, reg14, "$guard_troop8"),
(assign, reg15, "$guard_troop9"),
(assign, reg16, "$guard_troop9"),
(assign, reg17, "$guard_troop10"),
(store_random_in_range, ":local0", 1, 6),
(val_add, ":local0", "$meta_alarm"),
(val_min, ":local0", 10),
(val_add, ":local0", 10),
(assign, ":local1", 7),
(val_add, ":local1", "$meta_alarm"),
    (try_for_range, ":local2", 10, ":local0"),
    (shuffle_range, 1, ":local1"),
    (neg|eq, reg1, 0),
    (set_visitor, ":local2", reg1, 0),
(try_end),
]), 

#script_infiltration_combat_2
("infiltration_combat_2",[
(set_jump_mission, "mst_infiltration_combat_mission"),
(jump_to_scene, "$rescue_courtyard_scene_2", 0),
(reset_visitors),
(modify_visitors_at_site, "$rescue_courtyard_scene_2"),
(call_script, "script_set_infiltration_companions", 0, 0),
(assign, reg1, "$guard_troop2"),
(assign, reg2, "$guard_troop2"),
(assign, reg3, "$guard_troop3"),
(assign, reg4, "$guard_troop3"),
(assign, reg5, "$guard_troop4"),
(assign, reg5, "$guard_troop4"),
(assign, reg7, "$guard_troop5"),
(assign, reg8, "$guard_troop5"),
(assign, reg9, "$guard_troop6"),
(assign, reg10, "$guard_troop6"),
(assign, reg11, "$guard_troop7"),
(assign, reg12, "$guard_troop7"),
(assign, reg13, "$guard_troop8"),
(assign, reg14, "$guard_troop8"),
(assign, reg15, "$guard_troop9"),
(assign, reg16, "$guard_troop9"),
(assign, reg17, "$guard_troop10"),
(store_random_in_range, ":local0", 1, 6),
(val_add, ":local0", "$meta_alarm"),
(val_min, ":local0", 10),
(val_add, ":local0", 10),
(assign, ":local1", 7),
(val_add, ":local1", "$meta_alarm"),
    (try_for_range, ":local2", 10, ":local0"),
    (shuffle_range, 1, ":local1"),
    (neg|eq, reg1, 0),
    (set_visitor, ":local2", reg1, 0),
(try_end),
]), 

#script_final_dungeon_fight
("final_dungeon_fight",[
(set_jump_mission, "mst_infiltration_combat_mission"),
(jump_to_scene, "$rescue_final_scene", 0),
(reset_visitors),
(modify_visitors_at_site, "$rescue_final_scene"),
(call_script, "script_set_infiltration_companions", 0, 0),
    (try_begin),
    (is_between, "$meta_alarm", 1, 4),
    (set_visitor, 10, "$guard_troop2", 0),
    (set_visitor, 11, "$guard_troop2", 0),
    (set_visitor, 12, "$guard_troop2", 0),
    (set_visitor, 13, "$guard_troop3", 0),
    (set_visitor, 14, "$guard_troop3", 0),
    (set_visitor, 15, "$guard_troop3", 0),
    (set_visitor, 16, "$guard_troop4", 0),
    (set_visitor, 17, "$guard_troop4", 0),
    (set_visitor, 18, "$guard_troop5", 0),
    (set_visitor, 19, "$guard_troop5", 0),
    (set_visitor, 20, "$guard_troop6", 0),
    (else_try),
    (is_between, "$meta_alarm", 4, 7),
    (set_visitor, 10, "$guard_troop3", 0),
    (set_visitor, 11, "$guard_troop3", 0),
    (set_visitor, 12, "$guard_troop3", 0),
    (set_visitor, 13, "$guard_troop4", 0),
    (set_visitor, 14, "$guard_troop4", 0),
    (set_visitor, 15, "$guard_troop4", 0),
    (set_visitor, 16, "$guard_troop5", 0),
    (set_visitor, 17, "$guard_troop5", 0),
    (set_visitor, 18, "$guard_troop6", 0),
    (set_visitor, 19, "$guard_troop6", 0),
    (set_visitor, 20, "$guard_troop7", 0),
    (else_try),
    (is_between, "$meta_alarm", 7, 9),
    (set_visitor, 10, "$guard_troop4", 0),
    (set_visitor, 11, "$guard_troop4", 0),
    (set_visitor, 12, "$guard_troop4", 0),
    (set_visitor, 13, "$guard_troop5", 0),
    (set_visitor, 14, "$guard_troop5", 0),
    (set_visitor, 15, "$guard_troop5", 0),
    (set_visitor, 16, "$guard_troop6", 0),
    (set_visitor, 17, "$guard_troop6", 0),
    (set_visitor, 18, "$guard_troop7", 0),
    (set_visitor, 19, "$guard_troop7", 0),
    (set_visitor, 20, "$guard_troop8", 0),
    (else_try),
    (ge, "$meta_alarm", 9),
    (set_visitor, 10, "$guard_troop5", 0),
    (set_visitor, 11, "$guard_troop5", 0),
    (set_visitor, 12, "$guard_troop6", 0),
    (set_visitor, 13, "$guard_troop6", 0),
    (set_visitor, 14, "$guard_troop7", 0),
    (set_visitor, 15, "$guard_troop7", 0),
    (set_visitor, 16, "$guard_troop8", 0),
    (set_visitor, 17, "$guard_troop8", 0),
    (set_visitor, 18, "$guard_troop9", 0),
    (set_visitor, 19, "$guard_troop9", 0),
    (set_visitor, 20, "$guard_troop10", 0),
(try_end),
(assign, reg35, 31),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_ulfas", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_ulfas", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_ulfas"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_eothain", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_eothain", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_eothain"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_duilin", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_duilin", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_duilin"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_mablung", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_mablung", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_mablung"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_ufthak", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_ufthak", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_ufthak"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_gulm", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_gulm", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_gulm"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_skang", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_skang", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_skang"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_durgash", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_durgash", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_durgash"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_erkenbrand", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_erkenbrand", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_erkenbrand"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_grimbold", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_grimbold", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_grimbold"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_freca", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_freca", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_freca"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_eowine", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_eowine", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_eowine"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_deorhelm", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_deorhelm", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_deorhelm"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_fastred", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_fastred", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_fastred"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_eomer", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_eomer", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_eomer"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_elfhelm", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_elfhelm", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_elfhelm"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_dunhere", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_dunhere", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_dunhere"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_deorwine", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_deorwine", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_deorwine"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_guthlaf", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_guthlaf", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_guthlaf"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_hama", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_hama", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_hama"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_eowyn", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_eowyn", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_eowyn"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_faramir", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_faramir", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_faramir"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_imrahil", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_imrahil", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_imrahil"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_orthalion", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_orthalion", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_orthalion"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_halbarad", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_halbarad", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_halbarad"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_malvogil", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_malvogil", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_malvogil"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_aravir", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_aravir", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_aravir"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_forlong", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_forlong", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_forlong"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_hallas", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_hallas", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_hallas"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_hirluin", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_hirluin", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_hirluin"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_dirhael", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_dirhael", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_dirhael"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_glorfindel", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_glorfindel", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_glorfindel"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_lord_celeborn", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_lord_celeborn", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_lord_celeborn"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_elrohir", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_elrohir", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_elrohir"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_elladan", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_elladan", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_elladan"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_haldir", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_haldir", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_haldir"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_orophin", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_orophin", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_orophin"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_miriel", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_miriel", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_miriel"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_julute", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_julute", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_julute"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_mog_the_hunter", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_mog_the_hunter", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_mog_the_hunter"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_duessa", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_duessa", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_duessa"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_bolg_the_lesser", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_bolg_the_lesser", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_bolg_the_lesser"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_general_tuskim", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_general_tuskim", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_general_tuskim"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_ul_ulcari", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_ul_ulcari", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_ul_ulcari"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_daeglaf_the_black", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_daeglaf_the_black", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_daeglaf_the_black"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_khamul", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_khamul", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_khamul"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_varoujan", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_varoujan", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_varoujan"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_captain_tulmir", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_captain_tulmir", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_captain_tulmir"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_warden_of_the_vale", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_warden_of_the_vale", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_warden_of_the_vale"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_captain_mortakh", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_captain_mortakh", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_captain_mortakh"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_mauhur", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_mauhur", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_mauhur"),
(try_end),
    (try_begin),
    (neg|gt, reg35, 36),
    (troop_get_slot, ":local0", "trp_ugluk", 0),
    (is_between, ":local0", 6, 11),
    (val_sub, ":local0", 5),
    (eq, ":local0", "$active_rescue"),
    (set_visitor, reg35, "trp_ugluk", 0),
    (val_add, reg35, 1),
    (assign, "$rescue_convo_troop", "trp_ugluk"),
(try_end),
]), 

#script_put_troops_back
("put_troops_back",[
    (try_begin),
    (eq, "$active_rescue", 3),
    (assign, ":local0", "$heroes_captured_by_mordor"),
    (assign, "$heroes_captured_by_mordor", 0),
    (else_try),
    (eq, "$active_rescue", 4),
    (assign, ":local0", "$heroes_captured_by_isengard"),
    (assign, "$heroes_captured_by_isengard", 0),
    (else_try),
    (eq, "$active_rescue", 2),
    (assign, ":local0", "$heroes_captured_by_rohan"),
    (assign, "$heroes_captured_by_rohan", 0),
    (else_try),
    (eq, "$active_rescue", 1),
    (assign, ":local0", "$heroes_captured_by_gondor"),
    (assign, "$heroes_captured_by_gondor", 0),
(try_end),
(assign, ":local1", 0),
(assign, ":local2", 5),
    (try_for_range, ":local3", "trp_mablung", "trp_test_hero"),
    (neg|eq, ":local0", ":local1"),
    (troop_get_slot, ":local4", ":local3", 0),
    (is_between, ":local4", 6, 11),
    (val_sub, ":local4", 5),
    (eq, ":local4", "$active_rescue"),
        (try_begin),
        (hero_can_join),
        (troop_join, ":local3"),
        (else_try),
        (hero_can_join|neg),
        (add_troop_to_site, ":local3", "scn_tld_eastfold_inn", ":local2"),
        (val_add, ":local2", 1),
        (str_store_troop_name, 1, ":local3"),
        (display_message, "@{s1}_will_await_you_at_Eastfold_Inn.", 0),
    (try_end),
    (troop_set_slot, ":local3", 0, 1),
    (val_add, ":local1", 1),
        (try_begin),
        (eq, ":local3", "trp_haldir"),
        (troop_set_slot, "trp_map_haldir", 0, 1),
        (else_try),
        (eq, ":local3", "trp_orophin"),
        (troop_set_slot, "trp_map_orophin", 0, 1),
        (else_try),
        (eq, ":local3", "trp_elladan"),
        (troop_set_slot, "trp_map_elladan", 0, 1),
        (else_try),
        (eq, ":local3", "trp_elrohir"),
        (troop_set_slot, "trp_map_elrohir", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_celeborn"),
        (troop_set_slot, "trp_map_celeborn", 0, 1),
        (else_try),
        (eq, ":local3", "trp_glorfindel"),
        (troop_set_slot, "trp_map_glorfindel", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_grimbold"),
        (troop_set_slot, "trp_map_lord_grimbold", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_erkenbrand"),
        (troop_set_slot, "trp_map_lord_erkenbrand", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_freca"),
        (troop_set_slot, "trp_map_lord_freca", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_eowine"),
        (troop_set_slot, "trp_map_lord_eowine", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_deorhelm"),
        (troop_set_slot, "trp_map_lord_deorhelm", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_fastred"),
        (troop_set_slot, "trp_map_lord_fastred", 0, 1),
        (else_try),
        (eq, ":local3", "trp_king_theoden"),
        (troop_set_slot, "trp_map_king_theoden", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_eomer"),
        (troop_set_slot, "trp_map_lord_eomer", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_elfhelm"),
        (troop_set_slot, "trp_map_lord_elfhelm", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_dunhere"),
        (troop_set_slot, "trp_map_lord_dunhere", 0, 1),
        (else_try),
        (eq, ":local3", "trp_deorwine"),
        (troop_set_slot, "trp_map_deorwine", 0, 1),
        (else_try),
        (eq, ":local3", "trp_guthlaf"),
        (troop_set_slot, "trp_map_guthlaf", 0, 1),
        (else_try),
        (eq, ":local3", "trp_hama"),
        (troop_set_slot, "trp_map_hama", 0, 1),
        (else_try),
        (eq, ":local3", "trp_eowyn"),
        (troop_set_slot, "trp_map_eowyn", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_malvogil"),
        (troop_set_slot, "trp_map_lord_malvogil", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_halbarad"),
        (troop_set_slot, "trp_map_lord_halbarad", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_imrahil"),
        (troop_set_slot, "trp_map_lord_imrahil", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_orthalion"),
        (troop_set_slot, "trp_map_lord_orthalion", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_aravir"),
        (troop_set_slot, "trp_map_lord_aravir", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_hirluin"),
        (troop_set_slot, "trp_map_lord_hirluin", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_faramir"),
        (troop_set_slot, "trp_map_lord_faramir", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_forlong"),
        (troop_set_slot, "trp_map_lord_forlong", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_hallas"),
        (troop_set_slot, "trp_map_lord_hallas", 0, 1),
        (else_try),
        (eq, ":local3", "trp_lord_dirhael"),
        (troop_set_slot, "trp_map_lord_dirhael", 0, 1),
        (else_try),
        (eq, ":local3", "trp_daeglaf_the_black"),
        (troop_set_slot, "trp_map_daeglaf_the_black", 0, 1),
        (else_try),
        (eq, ":local3", "trp_ugluk"),
        (troop_set_slot, "trp_map_ugluk", 0, 1),
        (else_try),
        (eq, ":local3", "trp_mauhur"),
        (troop_set_slot, "trp_map_mauhur", 0, 1),
        (else_try),
        (eq, ":local3", "trp_mog_the_hunter"),
        (troop_set_slot, "trp_map_mog_the_hunter", 0, 1),
        (else_try),
        (eq, ":local3", "trp_warden_of_the_vale"),
        (troop_set_slot, "trp_map_warden_of_the_vale", 0, 1),
        (else_try),
        (eq, ":local3", "trp_captain_mortakh"),
        (troop_set_slot, "trp_map_captain_mortakh", 0, 1),
        (else_try),
        (eq, ":local3", "trp_duessa"),
        (troop_set_slot, "trp_map_duessa", 0, 1),
        (else_try),
        (eq, ":local3", "trp_captain_tulmir"),
        (troop_set_slot, "trp_map_captain_tulmir", 0, 1),
        (else_try),
        (eq, ":local3", "trp_ul_ulcari"),
        (troop_set_slot, "trp_map_ul_ulcari", 0, 1),
        (else_try),
        (eq, ":local3", "trp_varoujan"),
        (troop_set_slot, "trp_map_varoujan", 0, 1),
        (else_try),
        (eq, ":local3", "trp_khamul"),
        (troop_set_slot, "trp_map_khamul", 0, 1),
        (else_try),
        (eq, ":local3", "trp_general_tuskim"),
        (troop_set_slot, "trp_map_general_tuskim", 0, 1),
        (else_try),
        (eq, ":local3", "trp_bolg_the_lesser"),
        (troop_set_slot, "trp_map_bolg_the_lesser", 0, 1),
    (try_end),
(try_end),
(val_add, "$trait_check_stealth_success", 1),
]), 

#script_store_hero_death
("store_hero_death",[
(assign, "$no_dead_companions", 0),
    (try_for_agents, reg10),
    (agent_is_human, reg10),
    (agent_is_ally, reg10),
    (get_player_agent_no, "$current_player_agent"),
    (neg|eq, reg10, "$current_player_agent"),
    (agent_is_alive|neg, reg10),
    (val_add, "$no_dead_companions", 1),
(try_end),
    (try_begin),
    (neg|eq, "$rescue_companion_1", 0),
    (neg|troop_is_hero, "$rescue_companion_1"),
    (gt, "$no_dead_companions", 0),
    (assign, "$rescue_casualty_1", "$rescue_companion_1"),
    (assign, "$rescue_companion_1", 0),
    (val_sub, "$no_dead_companions", 1),
    (else_try),
    (neg|eq, "$rescue_companion_2", 0),
    (neg|troop_is_hero, "$rescue_companion_2"),
    (gt, "$no_dead_companions", 0),
    (assign, "$rescue_casualty_2", "$rescue_companion_2"),
    (assign, "$rescue_companion_2", 0),
    (val_sub, "$no_dead_companions", 1),
    (else_try),
    (neg|eq, "$rescue_companion_3", 0),
    (neg|troop_is_hero, "$rescue_companion_3"),
    (gt, "$no_dead_companions", 0),
    (assign, "$rescue_casualty_3", "$rescue_companion_3"),
    (assign, "$rescue_companion_3", 0),
    (val_sub, "$no_dead_companions", 1),
    (else_try),
    (neg|eq, "$rescue_companion_4", 0),
    (neg|troop_is_hero, "$rescue_companion_4"),
    (gt, "$no_dead_companions", 0),
    (assign, "$rescue_casualty_4", "$rescue_companion_4"),
    (assign, "$rescue_companion_4", 0),
    (val_sub, "$no_dead_companions", 1),
    (else_try),
    (neg|eq, "$rescue_companion_5", 0),
    (neg|troop_is_hero, "$rescue_companion_5"),
    (gt, "$no_dead_companions", 0),
    (assign, "$rescue_casualty_5", "$rescue_companion_5"),
    (assign, "$rescue_companion_5", 0),
    (val_sub, "$no_dead_companions", 1),
    (else_try),
    (neg|eq, "$rescue_companion_6", 0),
    (neg|troop_is_hero, "$rescue_companion_6"),
    (gt, "$no_dead_companions", 0),
    (assign, "$rescue_casualty_6", "$rescue_companion_6"),
    (assign, "$rescue_companion_6", 0),
    (val_sub, "$no_dead_companions", 1),
    (else_try),
    (neg|eq, "$rescue_companion_7", 0),
    (neg|troop_is_hero, "$rescue_companion_7"),
    (gt, "$no_dead_companions", 0),
    (assign, "$rescue_casualty_7", "$rescue_companion_7"),
    (assign, "$rescue_companion_7", 0),
    (val_sub, "$no_dead_companions", 1),
    (else_try),
    (neg|eq, "$rescue_companion_8", 0),
    (neg|troop_is_hero, "$rescue_companion_8"),
    (gt, "$no_dead_companions", 0),
    (assign, "$rescue_casualty_8", "$rescue_companion_8"),
    (assign, "$rescue_companion_8", 0),
    (val_sub, "$no_dead_companions", 1),
    (else_try),
    (neg|eq, "$rescue_companion_9", 0),
    (neg|troop_is_hero, "$rescue_companion_9"),
    (gt, "$no_dead_companions", 0),
    (assign, "$rescue_casualty_9", "$rescue_companion_9"),
    (assign, "$rescue_companion_9", 0),
    (val_sub, "$no_dead_companions", 1),
(try_end),
]), 

#script_mt_sneak_1
("mt_sneak_1",[
    (try_begin),
    (eq, "$positions", 3),
    (eq, "$last_agent_position", 2),
    (agent_set_scripted_destination, "$agents", 2),
    (else_try),
    (eq, "$positions", 2),
    (eq, "$last_agent_position", 3),
    (agent_set_scripted_destination, "$agents", 1),
    (else_try),
    (eq, "$positions", 7),
    (eq, "$last_agent_position", 6),
    (agent_set_scripted_destination, "$agents", 6),
    (else_try),
    (eq, "$positions", 5),
    (eq, "$last_agent_position", 7),
    (agent_set_scripted_destination, "$agents", 4),
    (else_try),
    (eq, "$positions", 11),
    (agent_set_scripted_destination, "$agents", 8),
    (else_try),
    (eq, "$positions", 15),
    (agent_set_scripted_destination, "$agents", 14),
    (else_try),
    (eq, "$positions", 19),
    (agent_set_scripted_destination, "$agents", 17),
    (else_try),
    (eq, "$positions", 16),
    (agent_set_scripted_destination, "$agents", 20),
    (else_try),
    (eq, "$positions", 20),
    (agent_set_scripted_destination, "$agents", 16),
    (else_try),
    (assign, reg20, "$positions"),
    (val_add, reg20, 1),
    (agent_set_scripted_destination, "$agents", reg20),
(try_end),
]), 

#script_mt_sneak_2
("mt_sneak_2",[
    (try_begin),
    (eq, "$positions", 4),
    (agent_set_scripted_destination, "$agents", 1),
    (else_try),
    (eq, "$positions", 8),
    (agent_set_scripted_destination, "$agents", 5),
    (else_try),
    (eq, "$positions", 14),
    (eq, "$last_agent_position", 13),
    (agent_set_scripted_destination, "$agents", 13),
    (else_try),
    (eq, "$positions", 13),
    (eq, "$last_agent_position", 14),
    (agent_set_scripted_destination, "$agents", 12),
    (else_try),
    (eq, "$positions", 12),
    (eq, "$last_agent_position", 13),
    (agent_set_scripted_destination, "$agents", 11),
    (else_try),
    (eq, "$positions", 11),
    (eq, "$last_agent_position", 12),
    (agent_set_scripted_destination, "$agents", 10),
    (else_try),
    (eq, "$positions", 10),
    (eq, "$last_agent_position", 11),
    (agent_set_scripted_destination, "$agents", 9),
    (else_try),
    (eq, "$positions", 20),
    (eq, "$last_agent_position", 19),
    (agent_set_scripted_destination, "$agents", 19),
    (else_try),
    (eq, "$positions", 19),
    (eq, "$last_agent_position", 20),
    (agent_set_scripted_destination, "$agents", 16),
    (else_try),
    (eq, "$positions", 16),
    (eq, "$last_agent_position", 19),
    (agent_set_scripted_destination, "$agents", 15),
    (else_try),
    (assign, reg20, "$positions"),
    (val_add, reg20, 1),
    (agent_set_scripted_destination, "$agents", reg20),
(try_end),
]), 

#script_isen_sneak_1
("isen_sneak_1",[
    (try_begin),
    (eq, "$positions", 1),
    (agent_set_scripted_destination, "$agents", 2),
    (else_try),
    (eq, "$positions", 2),
    (agent_set_scripted_destination, "$agents", 1),
    (else_try),
    (eq, "$positions", 3),
    (agent_set_scripted_destination, "$agents", 4),
    (else_try),
    (eq, "$positions", 4),
    (agent_set_scripted_destination, "$agents", 3),
    (else_try),
    (eq, "$positions", 6),
    (agent_set_scripted_destination, "$agents", 7),
    (else_try),
    (eq, "$positions", 7),
    (agent_set_scripted_destination, "$agents", 6),
    (else_try),
    (eq, "$positions", 9),
    (agent_set_scripted_destination, "$agents", 10),
    (else_try),
    (eq, "$positions", 10),
    (agent_set_scripted_destination, "$agents", 9),
    (else_try),
    (eq, "$positions", 14),
    (agent_set_scripted_destination, "$agents", 15),
    (else_try),
    (eq, "$positions", 15),
    (agent_set_scripted_destination, "$agents", 14),
    (else_try),
    (eq, "$positions", 16),
    (agent_set_scripted_destination, "$agents", 17),
    (else_try),
    (eq, "$positions", 17),
    (agent_set_scripted_destination, "$agents", 16),
    (else_try),
    (assign, reg20, "$positions"),
    (val_add, reg20, 1),
    (agent_set_scripted_destination, "$agents", reg20),
(try_end),
]), 

#script_rescue_failed
("rescue_failed",[
    (try_begin),
    (eq, "$active_rescue", 1),
    (assign, ":local0", 1),
    (else_try),
    (eq, "$active_rescue", 2),
    (assign, ":local0", 2),
    (else_try),
    (eq, "$active_rescue", 3),
    (assign, ":local0", 3),
    (else_try),
    (eq, "$active_rescue", 4),
    (assign, ":local0", 4),
(try_end),
(neg|ge, "$active_rescue", 5),
(neg|eq, ":local0", 0),
(assign, ":local1", 0),
    (try_for_range, ":local2", "fac_mission_companion_1", "fac_mission_companion_10"),
    (assign, ":local3", 0),
    (faction_get_slot, ":local4", ":local2", 3),
    (faction_get_slot, ":local5", ":local2", 4),
    (faction_get_slot, ":local6", ":local2", 1),
    (eq, ":local5", 1),
        (try_for_range, ":local7", "trp_mablung", "trp_test_hero"),
        (eq, ":local6", ":local7"),
        (assign, ":local8", ":local0"),
        (val_add, ":local8", 5),
        (troop_set_slot, ":local7", 0, ":local8"),
        (assign, ":local3", 1),
        (party_remove_members, "p_main_party", ":local7", 1),
        (str_store_troop_name, 1, ":local7"),
        (display_message, "@{s1}_has_been_captured_by_the_enemy.", 4294901760),
            (try_begin),
            (eq, ":local3", 1),
            (eq, ":local0", 1),
            (val_add, "$heroes_captured_by_gondor", 1),
            (val_add, ":local1", ":local3"),
            (str_store_party_name, 2, "$minas_tirith"),
            (display_message, "@Gondor_takes_a_captive", 0),
            (else_try),
            (eq, ":local3", 1),
            (eq, ":local0", 2),
            (val_add, "$heroes_captured_by_rohan", 1),
            (val_add, ":local1", ":local3"),
            (str_store_party_name, 2, "$hornburg"),
            (display_message, "@Rohan_takes_a_captive", 0),
            (else_try),
            (eq, ":local3", 1),
            (eq, ":local0", 3),
            (val_add, "$heroes_captured_by_mordor", 1),
            (val_add, ":local1", ":local3"),
            (str_store_party_name, 2, "p_minas_morgul"),
            (display_message, "@Mordor_takes_a_captive", 0),
            (else_try),
            (eq, ":local3", 1),
            (eq, ":local0", 4),
            (val_add, "$heroes_captured_by_isengard", 1),
            (val_add, ":local1", ":local3"),
            (str_store_party_name, 2, "p_isengard"),
            (display_message, "@Isengard_takes_a_captive", 0),
        (try_end),
    (try_end),
(try_end),
    (try_begin),
    (eq, "$current_companions_total", 0),
    (tutorial_box, "@You_were_grievously_wounded_and_your_body_piled_with_the_dead._Picking_your_moment_you_managed_to_escape_over_the_wall_but_the_enemy_may_have_seen_your_movements._Best_to_be_quickly_away."),
    (else_try),
    (eq, ":local1", 1),
    (tutorial_box, "@You_were_grievously_wounded_in_battle._Your_men_managed_to_drag_you_away_but_took_horrific_casualties_in_the_effort."),
    (else_try),
    (gt, ":local1", 1),
    (tutorial_box, "@You_were_grievously_wounded_in_battle._Your_men_managed_to_drag_you_away_but_took_horrific_casualties_in_the_effort._Unfortunately,_some_of_your_companions_have_been_captured."),
    (assign, ":local9", 0),
(try_end),
]), 

#script_set_hero_companion
("set_hero_companion",[
    (try_for_range, reg10, 0, "$number_of_troop_type"),
        (try_begin),
        (troop_is_hero, "$troop_to_pick"),
        (store_troop_health, ":local0", "$troop_to_pick", 0),
        (else_try),
        (neg|troop_is_hero, "$troop_to_pick"),
        (assign, ":local1", 100),
    (try_end),
        (try_begin),
        (eq, "$pick_stage", 0),
        (assign, "$rescue_companion_1", "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_1", 1, "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_1", 3, ":local0"),
        (else_try),
        (eq, "$pick_stage", 1),
        (assign, "$rescue_companion_2", "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_2", 1, "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_2", 3, ":local0"),
        (else_try),
        (eq, "$pick_stage", 2),
        (assign, "$rescue_companion_3", "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_3", 1, "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_3", 3, ":local0"),
        (else_try),
        (eq, "$pick_stage", 3),
        (assign, "$rescue_companion_4", "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_4", 1, "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_4", 3, ":local0"),
        (else_try),
        (eq, "$pick_stage", 4),
        (assign, "$rescue_companion_5", "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_5", 1, "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_5", 3, ":local0"),
        (else_try),
        (eq, "$pick_stage", 5),
        (assign, "$rescue_companion_6", "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_6", 1, "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_6", 3, ":local0"),
        (else_try),
        (eq, "$pick_stage", 6),
        (assign, "$rescue_companion_7", "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_7", 1, "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_7", 3, ":local0"),
        (else_try),
        (eq, "$pick_stage", 7),
        (assign, "$rescue_companion_8", "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_8", 1, "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_8", 3, ":local0"),
        (else_try),
        (eq, "$pick_stage", 8),
        (assign, "$rescue_companion_9", "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_9", 1, "$troop_to_pick"),
        (faction_set_slot, "fac_mission_companion_9", 3, ":local0"),
    (try_end),
    (val_add, "$pick_stage", 1),
(try_end),
    (try_begin),
    (eq, "$troop_to_pick", "trp_ranger_of_ithilien"),
    (val_add, "$no_ranger_of_ithilien_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_veteran_ranger_of_ithilien"),
    (val_add, "$no_veteran_ranger_of_ithilien_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_master_ranger_of_ithilien"),
    (val_add, "$no_master_ranger_of_ithilien_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_dunedain_veteran_ranger"),
    (val_add, "$no_dunedain_veteran_ranger_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_dunedain_ranger"),
    (val_add, "$no_dunedain_ranger_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_dunedain_master_ranger"),
    (val_add, "$no_dunedain_master_ranger_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_raider_of_rohan"),
    (val_add, "$no_raider_of_rohan_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_corsair_raider"),
    (val_add, "$no_corsair_raider_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_corsair_veteran_raider"),
    (val_add, "$no_corsair_veteran_raider_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_corsair_night_raider"),
    (val_add, "$no_corsair_night_raider_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_orc_tracker_of_mordor"),
    (val_add, "$no_orc_tracker_of_mordor_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_fell_orc_tracker_of_mordor"),
    (val_add, "$no_fell_orc_tracker_of_mordor_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_uruk_hai_scout"),
    (val_add, "$no_uruk_hai_scout_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_large_uruk_hai_scout"),
    (val_add, "$no_large_uruk_hai_scout_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_fighting_uruk_hai_scout"),
    (val_add, "$no_fighting_uruk_hai_scout_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_assassin_of_umbar"),
    (val_add, "$no_assassin_of_umbar_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_master_assassin_of_umbar"),
    (val_add, "$no_master_assassin_of_umbar_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_black_numenorian_assassin"),
    (val_add, "$no_black_numenorian_assassin_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_ranger_captain"),
    (val_add, "$no_ranger_captain_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_noldorin_commander"),
    (val_add, "$no_noldorin_commander_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_elf_captain_of_lothlorien"),
    (val_add, "$no_elf_captain_of_lothlorien_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_elf_captain_of_rivendell"),
    (val_add, "$no_elf_captain_of_rivendell_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_elf_captain_of_mirkwood"),
    (val_add, "$no_elf_captain_of_mirkwood_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_lothlorien_lieutenant"),
    (val_add, "$no_lothlorien_lieutenant_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_mirkwood_lieutenant"),
    (val_add, "$no_mirkwood_lieutenant_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_rivendell_lieutenant"),
    (val_add, "$no_rivendell_lieutenant_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_lothlorien_warden"),
    (val_add, "$no_lothlorien_warden_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_lothlorien_veteran_warden"),
    (val_add, "$no_lothlorien_veteran_warden_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_galadhrim_royal_warden"),
    (val_add, "$no_galadhrim_royal_warden_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_rivendell_scout"),
    (val_add, "$no_rivendell_scout_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_rivendell_veteran_scout"),
    (val_add, "$no_rivendell_veteran_scout_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_rivendell_sentinel"),
    (val_add, "$no_rivendell_sentinel_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_rivendell_veteran_sentinel"),
    (val_add, "$no_rivendell_veteran_sentinel_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_rivendell_elite_sentinel"),
    (val_add, "$no_rivendell_veteran_elite_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_knight_of_rivendell"),
    (val_add, "$no_knight_of_rivendell_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_greenwood_scout"),
    (val_add, "$no_greenwood_scout_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_greenwood_veteran_scout"),
    (val_add, "$no_greenwood_veteran_scout_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_greenwood_archer"),
    (val_add, "$no_greenwood_archer_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_greenwood_veteran_archer"),
    (val_add, "$no_greenwood_veteran_archer_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_greenwood_master_archer"),
    (val_add, "$no_greenwood_master_archer_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_thranduil_s_royal_marksman"),
    (val_add, "$no_thranduil's_royal_marksman_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_greenwood_spearman"),
    (val_add, "$no_greenwood_spearman_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_greenwood_veteran_spearman"),
    (val_add, "$no_greenwood_veteran_spearman_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_greenwood_royal_spearman"),
    (val_add, "$no_greenwood_royal_spearman_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_lothlorien_scout"),
    (val_add, "$no_lothlorien_scout_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_lothlorien_veteran_scout"),
    (val_add, "$no_lothlorien_veteran_scout_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_greenwood_royal_spearman"),
    (val_add, "$no_greenwood_royal_spearman_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_lothlorien_archer"),
    (val_add, "$no_lothlorien_archer_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_lothlorien_veteran_archer"),
    (val_add, "$no_lothlorien_veteran_archer_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_lothlorien_master_archer"),
    (val_add, "$no_lothlorien_master_archer_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_galadhrim_royal_archer"),
    (val_add, "$no_galadhrim_royal_archer_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_galadhrim_royal_marksman"),
    (val_add, "$no_galadhrim_royal_marksman_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_lothlorien_infantry"),
    (val_add, "$no_lothlorien_infantry_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_lothlorien_veteran_infantry"),
    (val_add, "$no_lothlorien_veteran_infantry_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_lothlorien_elite_infantry"),
    (val_add, "$no_lothlorien_elite_infantry_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_galadhrim_royal_swordsman"),
    (val_add, "$no_galadhrim_royal_swordsman_picked", "$number_of_troop_type"),
    (else_try),
    (eq, "$troop_to_pick", "trp_noldorin_mounted_archer"),
    (val_add, "$no_noldorin_mounted_archer_picked", "$number_of_troop_type"),
(try_end),
(assign, "$number_of_troop_type", 1),
]), 

#script_set_meta_stealth
("set_meta_stealth",[
(assign, "$current_companions_total", 0),
(assign, "$meta_stealth", 0),
(try_begin),
    (neg|eq, "$rescue_companion_1", 0),
    (store_skill_level, reg1, skl_pathfinding, "$rescue_companion_1"),
    (val_add, "$meta_stealth", reg1),
    (val_add, "$current_companions_total", 1),
(try_end),
(try_begin),
    (neg|eq, "$rescue_companion_2", 0),
    (store_skill_level, reg1, skl_pathfinding, "$rescue_companion_2"),
    (val_add, "$meta_stealth", reg1),
    (val_add, "$current_companions_total", 1),
(try_end),
(try_begin),
    (neg|eq, "$rescue_companion_3", 0),
    (store_skill_level, reg1, skl_pathfinding, "$rescue_companion_3"),
    (val_add, "$meta_stealth", reg1),
    (val_add, "$current_companions_total", 1),
(try_end),
(try_begin),
    (neg|eq, "$rescue_companion_4", 0),
    (store_skill_level, reg1, skl_pathfinding, "$rescue_companion_4"),
    (val_add, "$meta_stealth", reg1),
    (val_add, "$current_companions_total", 1),
(try_end),
(try_begin),
    (neg|eq, "$rescue_companion_5", 0),
    (store_skill_level, reg1, skl_pathfinding, "$rescue_companion_5"),
    (val_add, "$meta_stealth", reg1),
    (val_add, "$current_companions_total", 1),
(try_end),
(try_begin),
    (neg|eq, "$rescue_companion_6", 0),
    (store_skill_level, reg1, skl_pathfinding, "$rescue_companion_6"),
    (val_add, "$meta_stealth", reg1),
    (val_add, "$current_companions_total", 1),
(try_end),
(try_begin),
    (neg|eq, "$rescue_companion_7", 0),
    (store_skill_level, reg1, skl_pathfinding, "$rescue_companion_7"),
    (val_add, "$meta_stealth", reg1),
    (val_add, "$current_companions_total", 1),
(try_end),
(try_begin),
    (neg|eq, "$rescue_companion_8", 0),
    (store_skill_level, reg1, skl_pathfinding, "$rescue_companion_8"),
    (val_add, "$meta_stealth", reg1),
    (val_add, "$current_companions_total", 1),
(try_end),
(try_begin),
    (neg|eq, "$rescue_companion_9", 0),
    (store_skill_level, reg1, skl_pathfinding, "$rescue_companion_9"),
    (val_add, "$meta_stealth", reg1),
    (val_add, "$current_companions_total", 1),
(try_end),
(try_begin),
    (ge, "$current_companions_total", 1),
    (assign, reg2, "$current_companions_total"),
    (val_add, reg2, 1),
    (store_skill_level, reg1, skl_pathfinding, "trp_player"),
    (val_add, "$meta_stealth", reg1),
    (val_div, "$meta_stealth", reg2),
    (try_begin),
        (gt, "$pick_stage", 0),
        (neg|ge, "$pick_stage", 3),
    (else_try),
        (ge, "$pick_stage", 3),
        (neg|ge, "$pick_stage", 5),
        (val_sub, "$meta_stealth", 1),
        (val_max, "$meta_stealth", 0),
    (else_try),
        (ge, "$pick_stage", 5),
        (neg|ge, "$pick_stage", 9),
        (val_sub, "$meta_stealth", 2),
        (val_max, "$meta_stealth", 0),
    (else_try),
        (ge, "$pick_stage", 9),
        (val_sub, "$meta_stealth", 3),
        (val_max, "$meta_stealth", 0),
    (try_end),
(else_try),
    (eq, "$current_companions_total", 0),
    (store_skill_level, reg1, 8, 0),
    (val_sub, reg1, "$old_ranger_path_modifier"),
    (val_add, "$meta_stealth", reg1),
    (val_add, "$meta_stealth", 2),
    (val_min, "$meta_stealth", 10),
(try_end),
    (try_begin),
    (check_quest_active, "qst_trait_stealthy", 1),
    (try_begin),(    eq, "$current_companions_total", 0),(val_add, "$meta_stealth", 3),
     (else_try),(neg|eq, "$current_companions_total", 0),(val_add, "$meta_stealth", 1),
    (try_end),
(try_end),
]), 

#script_crunch_stealth_results
("crunch_stealth_results",[
(assign, reg10, "$meta_alarm"),
(val_sub, reg10, "$meta_stealth"),
(val_mul, reg10, 5),
(store_random, reg5, 100),
(val_add, reg5, reg10),
(assign, reg11, "$meta_stealth"),
(assign, reg12, "$meta_alarm"),
(assign, reg14, reg10),
(assign, reg13, reg5),
(try_begin),    (neg|ge, reg5, 15),    (assign, "$stealth_results", 1),
 (else_try),(is_between, reg5, 15, 50),(assign, "$stealth_results", 2),
 (else_try),(is_between, reg5, 50, 85),(assign, "$stealth_results", 3),
 (else_try),        (ge, reg5, 85),    (assign, "$stealth_results", 4),
(try_end),
]), 

#script_set_gauntlet_companions
("set_gauntlet_companions",[
(troop_get_slot, ":local0", 0, 20),
    (try_begin),
    (eq, ":local0", 0),
    (set_visitor, 0, 0, 0),
    (else_try),
    (eq, ":local0", 1),
    (set_visitor, 1, 0, 0),
    (else_try),
    (eq, ":local0", 2),
    (set_visitor, 2, 0, 0),
    (else_try),
    (eq, ":local0", 3),
    (set_visitor, 3, 0, 0),
(try_end),
    (try_begin),
    (neg|eq, "$arena_companion_1", 0),
    (troop_get_slot, ":local0", "$arena_companion_1", 20),
        (try_begin),
        (eq, ":local0", 0),
        (set_visitor, 4, "$arena_companion_1", 0),
        (else_try),
        (eq, ":local0", 1),
        (set_visitor, 5, "$arena_companion_1", 0),
        (else_try),
        (eq, ":local0", 2),
        (set_visitor, 6, "$arena_companion_1", 0),
        (else_try),
        (eq, ":local0", 3),
        (set_visitor, 7, "$arena_companion_1", 0),
    (try_end),
(try_end),
    (try_begin),
    (neg|eq, "$arena_companion_2", 0),
    (troop_get_slot, ":local0", "$arena_companion_2", 20),
        (try_begin),
        (eq, ":local0", 0),
        (set_visitor, 8, "$arena_companion_2", 0),
        (else_try),
        (eq, ":local0", 1),
        (set_visitor, 9, "$arena_companion_2", 0),
        (else_try),
        (eq, ":local0", 2),
        (set_visitor, 10, "$arena_companion_2", 0),
        (else_try),
        (eq, ":local0", 3),
        (set_visitor, 11, "$arena_companion_2", 0),
    (try_end),
(try_end),
    (try_begin),
    (neg|eq, "$arena_companion_3", 0),
    (troop_get_slot, ":local0", "$arena_companion_3", 20),
        (try_begin),
        (eq, ":local0", 0),
        (set_visitor, 12, "$arena_companion_3", 0),
        (else_try),
        (eq, ":local0", 1),
        (set_visitor, 13, "$arena_companion_3", 0),
        (else_try),
        (eq, ":local0", 2),
        (set_visitor, 14, "$arena_companion_3", 0),
        (else_try),
        (eq, ":local0", 3),
        (set_visitor, 15, "$arena_companion_3", 0),
    (try_end),
(try_end),
    (try_begin),
    (neg|eq, "$arena_companion_4", 0),
    (troop_get_slot, ":local0", "$arena_companion_4", 20),
        (try_begin),
        (eq, ":local0", 0),
        (set_visitor, 16, "$arena_companion_4", 0),
        (else_try),
        (eq, ":local0", 1),
        (set_visitor, 17, "$arena_companion_4", 0),
        (else_try),
        (eq, ":local0", 2),
        (set_visitor, 18, "$arena_companion_4", 0),
        (else_try),
        (eq, ":local0", 3),
        (set_visitor, 19, "$arena_companion_4", 0),
    (try_end),
(try_end),
    (try_begin),
    (neg|eq, "$arena_companion_5", 0),
    (troop_get_slot, ":local0", "$arena_companion_5", 20),
        (try_begin),
        (eq, ":local0", 0),
        (set_visitor, 20, "$arena_companion_5", 0),
        (else_try),
        (eq, ":local0", 1),
        (set_visitor, 21, "$arena_companion_5", 0),
        (else_try),
        (eq, ":local0", 2),
        (set_visitor, 22, "$arena_companion_5", 0),
        (else_try),
        (eq, ":local0", 3),
        (set_visitor, 23, "$arena_companion_5", 0),
    (try_end),
(try_end),
]), 

#script_set_gauntlet_hero
("set_gauntlet_hero",[
    (try_begin),
    (eq, "$pick_stage", 0),
    (assign, "$arena_companion_1", "$troop_to_pick"),
    (val_add, "$pick_stage", 1),
    (else_try),
    (eq, "$pick_stage", 1),
    (assign, "$arena_companion_2", "$troop_to_pick"),
    (val_add, "$pick_stage", 1),
    (else_try),
    (eq, "$pick_stage", 2),
    (assign, "$arena_companion_3", "$troop_to_pick"),
    (val_add, "$pick_stage", 1),
    (else_try),
    (eq, "$pick_stage", 3),
    (assign, "$arena_companion_4", "$troop_to_pick"),
    (val_add, "$pick_stage", 1),
    (else_try),
    (eq, "$pick_stage", 4),
    (assign, "$arena_companion_5", "$troop_to_pick"),
    (val_add, "$pick_stage", 1),
    (else_try),
    (eq, "$pick_stage", 5),
    (assign, "$arena_companion_6", "$troop_to_pick"),
    (val_add, "$pick_stage", 1),
(try_end),
]), 

#script_initialize_gauntlet_arena
("initialize_gauntlet_arena",[
(assign, "$pick_stage", 0),
(assign, "$troop_to_pick", 0),
(assign, "$arena_companion_1", 0),
(assign, "$arena_companion_2", 0),
(assign, "$arena_companion_3", 0),
(assign, "$arena_companion_4", 0),
(assign, "$arena_companion_5", 0),
]), 

#script_initialize_general_rescue
("initialize_general_rescue",[
(assign, "$rescue_companion_1", 0),
(assign, "$rescue_companion_2", 0),
(assign, "$rescue_companion_3", 0),
(assign, "$rescue_companion_4", 0),
(assign, "$rescue_companion_5", 0),
(assign, "$rescue_companion_6", 0),
(assign, "$rescue_companion_7", 0),
(assign, "$rescue_companion_8", 0),
(assign, "$rescue_companion_9", 0),
(assign, "$no_ranger_of_ithilien_picked", 0),
(assign, "$no_veteran_ranger_of_ithilien_picked", 0),
(assign, "$no_master_ranger_of_ithilien_picked", 0),
(assign, "$no_dunedain_ranger_picked", 0),
(assign, "$no_dunedain_veteran_ranger_picked", 0),
(assign, "$no_dunedain_master_ranger_picked", 0),
(assign, "$no_raider_of_rohan_picked", 0),
(assign, "$no_corsair_raider_picked", 0),
(assign, "$no_corsair_veteran_raider_picked", 0),
(assign, "$no_corsair_night_raider_picked", 0),
(assign, "$no_uruk_hai_scout_picked", 0),
(assign, "$no_large_uruk_hai_scout_picked", 0),
(assign, "$no_fighting_uruk_hai_scout_picked", 0),
(assign, "$no_orc_tracker_of_mordor_picked", 0),
(assign, "$no_fell_orc_tracker_of_mordor_picked", 0),
(assign, "$no_assassin_of_umbar_picked", 0),
(assign, "$no_master_assassin_of_umbar_picked", 0),
(assign, "$no_black_numenorian_assassin_picked", 0),
(assign, "$no_ranger_captain_picked", 0),
(assign, "$no_noldorin_commander_picked", 0),
(assign, "$no_elf_captain_of_lothlorien_picked", 0),
(assign, "$no_elf_captain_of_mirkwood_picked", 0),
(assign, "$no_elf_captain_of_rivendell_picked", 0),
(assign, "$no_lothlorien_lieutenant_picked", 0),
(assign, "$no_mirkwood_lieutenant_picked", 0),
(assign, "$no_rivendell_lieutenant_picked", 0),
(assign, "$no_rivendell_scout_picked", 0),
(assign, "$no_rivendell_veteran_scout_picked", 0),
(assign, "$no_rivendell_sentinel_picked", 0),
(assign, "$no_rivendell_veteran_sentinel_picked", 0),
(assign, "$no_rivendell_elite_sentinel_picked", 0),
(assign, "$no_knight_of_rivendell_picked", 0),
(assign, "$no_greenwood_scout_picked", 0),
(assign, "$no_greenwood_veteran_scout_picked", 0),
(assign, "$no_greenwood_archer_picked", 0),
(assign, "$no_greenwood_veteran_archer_picked", 0),
(assign, "$no_greenwood_master_archer_picked", 0),
(assign, "$no_thranduil's_royal_marksman_picked", 0),
(assign, "$no_greenwood_spearman_picked", 0),
(assign, "$no_greenwood_veteran_spearman_picked", 0),
(assign, "$no_greenwood_royal_spearman_picked", 0),
(assign, "$no_lothlorien_scout_picked", 0),
(assign, "$no_lothlorien_veteran_scout_picked", 0),
(assign, "$no_lothlorien_archer_picked", 0),
(assign, "$no_lothlorien_veteran_archer_picked", 0),
(assign, "$no_lothlorien_master_archer_picked", 0),
(assign, "$no_galadhrim_royal_archer_picked", 0),
(assign, "$no_galadhrim_royal_marksman_picked", 0),
(assign, "$no_lothlorien_warden_picked", 0),
(assign, "$no_lothlorien_veteran_warden_picked", 0),
(assign, "$no_galadhrim_royal_warden_picked", 0),
(assign, "$no_lothlorien_infantry_picked", 0),
(assign, "$no_lothlorien_veteran_infantry_picked", 0),
(assign, "$no_lothlorien_elite_infantry_picked", 0),
(assign, "$no_galadhrim_royal_swordsman_picked", 0),
(assign, "$no_noldorin_mounted_archer_picked", 0),
]), 

#script_initialize_minas_tirith_rescue
("initialize_minas_tirith_rescue",[
(assign, "$meta_alarm", "$minas_tirith_alarm"),
(assign, "$rescue_wall_battle", "scn_tld_minas_tirith_wall"),
(assign, "$rescue_stealth_scene_1", "scn_tld_minas_tirith_stealth_1"),
(assign, "$rescue_stealth_scene_2", "scn_tld_minas_tirith_stealth_2"),
(assign, "$rescue_courtyard_scene_1", "scn_tld_minas_tirith_combat_1"),
(assign, "$rescue_courtyard_scene_2", "scn_tld_minas_tirith_combat_2"),
(assign, "$rescue_final_scene", "scn_tld_minas_tirith_final_dungeon"),
(assign, "$guard_troop1", "trp_city_guard"),
(assign, "$guard_troop2", "trp_guardsman_of_gondor"),
(assign, "$guard_troop3", "trp_infantry_of_gondor"),
(assign, "$guard_troop4", "trp_infantry_of_gondor"),
(assign, "$guard_troop5", "trp_archer_of_gondor"),
(assign, "$guard_troop6", "trp_veteran_infantry_of_gondor"),
(assign, "$guard_troop7", "trp_heavy_infantry_of_gondor"),
(assign, "$guard_troop8", "trp_heavy_infantry_of_gondor"),
(assign, "$guard_troop9", "trp_master_yeoman_of_gondor"),
(assign, "$guard_troop10", "trp_knight_of_the_tower_guard"),
(assign, "$wall_missile_troop1", "trp_archer_of_gondor"),
(assign, "$wall_missile_troop2", "trp_archer_of_gondor"),
(assign, "$wall_missile_troop3", "trp_veteran_archer_of_gondor"),
(assign, "$wall_missile_troop4", "trp_veteran_archer_of_gondor"),
(assign, "$wall_missile_troop5", "trp_master_yeoman_of_gondor"),
(assign, "$wall_mounted_troop1", "trp_squire_of_gondor"),
#(assign, "$wall_mounted_troop2", "trp_knight_of_gondor"),
(assign, "$wall_mounted_troop3", "trp_knight_of_gondor"),
#(assign, "$wall_mounted_troop4", "trp_veteran_knight_of_gondor"),
(assign, "$wall_mounted_troop5", "trp_veteran_knight_of_gondor"),
]), 

#script_initialize_rohan_rescue
("initialize_rohan_rescue",[
(assign, "$meta_alarm", "$hornburg_alarm"),
(assign, "$rescue_wall_battle", "scn_tld_hornburg_wall"),
(assign, "$rescue_stealth_scene_1", "scn_tld_hornburg_stealth_1"),
(assign, "$rescue_stealth_scene_2", "scn_tld_hornburg_stealth_2"),
(assign, "$rescue_courtyard_scene_1", "scn_tld_hornburg_combat_1"),
(assign, "$rescue_courtyard_scene_2", "scn_tld_hornburg_combat_2"),
(assign, "$rescue_final_scene", "scn_tld_hornburg_final_dungeon"),
(assign, "$guard_troop1", "trp_watchman"),
(assign, "$guard_troop2", "trp_footman_of_rohan"),
(assign, "$guard_troop3", "trp_footman_of_rohan"),
(assign, "$guard_troop4", "trp_footman_of_rohan"),
(assign, "$guard_troop5", "trp_footman_of_rohan"),
(assign, "$guard_troop6", "trp_veteran_footman_of_rohan"),
(assign, "$guard_troop7", "trp_elite_footman_of_rohan"),
(assign, "$guard_troop8", "trp_elite_footman_of_rohan"),
(assign, "$guard_troop9", "trp_heavy_swordsman_of_rohan"),
(assign, "$guard_troop10", "trp_folcwine_guard_of_rohan"),
(assign, "$wall_missile_troop1", "trp_rider_of_rohan"),
(assign, "$wall_missile_troop2", "trp_rider_of_rohan"),
(assign, "$wall_missile_troop3", "trp_veteran_rider_of_rohan"),
(assign, "$wall_missile_troop4", "trp_elite_rider_of_rohan"),
(assign, "$wall_missile_troop5", "trp_eorl_guard_of_rohan"),
(assign, "$wall_mounted_troop1", "trp_rider_of_rohan"),
#(assign, "$wall_mounted_troop2", "trp_rider_of_rohan"),
(assign, "$wall_mounted_troop3", "trp_veteran_rider_of_rohan"),
#(assign, "$wall_mounted_troop4", "trp_veteran_rider_of_rohan"),
(assign, "$wall_mounted_troop5", "trp_eorl_guard_of_rohan"),
]), 

#script_initialize_mordor_rescue
("initialize_mordor_rescue",[
(assign, "$meta_alarm", "$minas_morgul_alarm"),
(assign, "$rescue_wall_battle", "scn_tld_minas_morgul_wall"),
(assign, "$rescue_stealth_scene_1", "scn_tld_minas_morgul_stealth_1"),
(assign, "$rescue_stealth_scene_2", "scn_tld_minas_morgul_stealth_2"),
(assign, "$rescue_courtyard_scene_1", "scn_tld_minas_morgul_combat_1"),
(assign, "$rescue_courtyard_scene_2", "scn_tld_minas_morgul_combat_2"),
(assign, "$rescue_final_scene", "scn_tld_minas_morgul_final_dungeon"),
(assign, "$guard_troop1", "trp_orc_sentry"),
(assign, "$guard_troop2", "trp_orc_of_mordor"),
(assign, "$guard_troop3", "trp_orc_of_mordor"),
(assign, "$guard_troop4", "trp_orc_of_mordor"),
(assign, "$guard_troop5", "trp_orc_archer_of_mordor"),
(assign, "$guard_troop6", "trp_large_orc_of_mordor"),
(assign, "$guard_troop7", "trp_large_orc_of_mordor"),
(assign, "$guard_troop8", "trp_fell_orc_of_mordor"),
(assign, "$guard_troop9", "trp_fell_orc_of_mordor"),
(assign, "$guard_troop10", "trp_olog_hai"),
(assign, "$wall_missile_troop1", "trp_orc_archer_of_mordor"),
(assign, "$wall_missile_troop2", "trp_orc_archer_of_mordor"),
(assign, "$wall_missile_troop3", "trp_large_orc_archer_of_mordor"),
(assign, "$wall_missile_troop4", "trp_large_orc_archer_of_mordor"),
(assign, "$wall_missile_troop5", "trp_fell_orc_archer_of_mordor"),
(assign, "$wall_mounted_troop1", "trp_large_orc_of_mordor"),
#(assign, "$wall_mounted_troop2", "trp_large_orc_of_mordor"),
(assign, "$wall_mounted_troop3", "trp_fell_orc_of_mordor"),
#(assign, "$wall_mounted_troop4", "trp_warg_rider_of_gorgoroth"),
(assign, "$wall_mounted_troop5", "trp_great_warg_rider_of_mordor"),
]), 

#script_initialize_isengard_rescue
("initialize_isengard_rescue",[
(assign, "$meta_alarm", "$isengard_alarm"),
(assign, "$rescue_wall_battle", "scn_tld_isengard_wall"),
(assign, "$rescue_stealth_scene_1", "scn_tld_isengard_stealth_1"),
(assign, "$rescue_stealth_scene_2", "scn_tld_isengard_stealth_2"),
(assign, "$rescue_courtyard_scene_1", "scn_tld_isengard_combat_1"),
(assign, "$rescue_courtyard_scene_2", "scn_tld_isengard_combat_2"),
(assign, "$rescue_final_scene", "scn_tld_isengard_final_dungeon"),
(assign, "$guard_troop1", "trp_uruk_hai_sentry"),
(assign, "$guard_troop2", "trp_uruk_hai_of_isengard"),
(assign, "$guard_troop3", "trp_uruk_hai_of_isengard"),
(assign, "$guard_troop4", "trp_uruk_hai_of_isengard"),
(assign, "$guard_troop5", "trp_uruk_hai_scout"),
(assign, "$guard_troop6", "trp_large_uruk_hai_of_isengard"),
(assign, "$guard_troop7", "trp_large_uruk_hai_of_isengard"),
(assign, "$guard_troop8", "trp_fighting_uruk_hai_scout"),
(assign, "$guard_troop9", "trp_fighting_uruk_hai_warrior"),
(assign, "$guard_troop10", "trp_fighting_uruk_hai_champion"),
(assign, "$wall_missile_troop1", "trp_uruk_hai_scout"),
(assign, "$wall_missile_troop2", "trp_uruk_hai_scout"),
(assign, "$wall_missile_troop3", "trp_large_uruk_hai_scout"),
(assign, "$wall_missile_troop4", "trp_large_uruk_hai_scout"),
(assign, "$wall_missile_troop5", "trp_fighting_uruk_hai_scout"),
(assign, "$wall_mounted_troop1", "trp_wolf_rider_of_isengard"),
#(assign, "$wall_mounted_troop2", "trp_warg_rider_of_isengard"),
(assign, "$wall_mounted_troop3", "trp_warg_rider_of_isengard"),
#(assign, "$wall_mounted_troop4", "trp_white_hand_rider"),
(assign, "$wall_mounted_troop5", "trp_fighting_uruk_hai_berserker"),
]), 

#script_rescue_information
("rescue_information",[
(try_begin),
    (eq, "$rescue_stage", 0),
    (display_message, "@You_have_been_discovered_before_scaling_the_wall.", 4294901760),
    (display_message, "@The_enemy_is_coming_in_force,_you_must_flee!", 4294901760),
  (else_try),
    (eq, "$rescue_stage", 1),
    (display_message, "@Scout_this_area_alone_and_meet_your_men_beyond!", 4294901760),
    (display_message, "@Be_stealthy_but_eliminate_any_threats_quickly!", 4294901760),
  (else_try),
    (eq, "$rescue_stage", 2),
    (display_message, "@You_are_spotted_by_a_patrol!", 4294901760),
    (display_message, "@Eliminate_them_before_the_alarm_spreads!", 4294901760),
  (else_try),
    (eq, "$rescue_stage", 3),
    (display_message, "@Scout_this_area_alone_and_meet_your_men_beyond!", 4294901760),
    (display_message, "@Be_stealthy_but_eliminate_any_threats_quickly!", 4294901760),
  (else_try),
    (eq, "$rescue_stage", 4),
    (display_message, "@You_are_spotted_by_a_patrol!", 4294901760),
    (display_message, "@Eliminate_them_before_the_alarm_spreads!", 4294901760),
  (else_try),
    (eq, "$rescue_stage", 5),
    (display_message, "@You_have_reached_the_dungeons!", 0),
    (display_message, "@Eliminate_the_guards_and_free_your_men!", 0),
(try_end),
]), 

#script_formation_start
("formation_start",[
(get_player_agent_no, reg10),
(agent_get_position, 1, reg10),
    (try_for_range, reg20, 1, 100),
    (agent_set_slot, reg10, reg20, 0),
(try_end),
    (try_for_agents, reg5),
    (assign, reg0, 0),
    (neg|eq, reg5, reg10),
    (agent_is_alive, reg5),
    (agent_is_human, reg5),
    (agent_is_ally, reg5),
    (agent_get_slot, ":local0", reg5, 2),
    (neg|eq, ":local0", 1),
    (agent_get_troop_id, ":local1", reg5),
    (this_or_next|eq, ":local1", "$formation_troop_1"),
    (this_or_next|eq, ":local1", "$formation_troop_2"),
    (this_or_next|eq, ":local1", "$formation_troop_3"),
    (this_or_next|eq, ":local1", "$formation_troop_4"),
    (this_or_next|eq, ":local1", "$formation_troop_5"),
    (this_or_next|eq, ":local1", "$formation_troop_6"),
    (this_or_next|eq, ":local1", "$formation_troop_7"),
    (this_or_next|eq, ":local1", "$formation_troop_8"),
    (this_or_next|eq, ":local1", "$formation_troop_9"),
    (this_or_next|eq, ":local1", "$formation_troop_10"),
    (this_or_next|eq, ":local1", "$formation_troop_11"),
    (this_or_next|eq, ":local1", "$formation_troop_12"),
    (this_or_next|eq, ":local1", "$formation_troop_13"),
    (this_or_next|eq, ":local1", "$formation_troop_14"),
    (this_or_next|eq, ":local1", "$formation_troop_15"),
    (this_or_next|eq, ":local1", "$formation_troop_16"),
    (this_or_next|eq, ":local1", "$formation_troop_17"),
    (this_or_next|eq, ":local1", "$formation_troop_18"),
    (this_or_next|eq, ":local1", "$formation_troop_19"),
    (this_or_next|eq, ":local1", "$formation_troop_20"),
    (this_or_next|eq, ":local1", "$formation_troop_21"),
    (this_or_next|eq, ":local1", "$formation_troop_22"),
    (this_or_next|eq, ":local1", "$formation_troop_23"),
    (this_or_next|eq, ":local1", "$formation_troop_24"),
    (this_or_next|eq, ":local1", "$formation_troop_25"),
    (this_or_next|eq, ":local1", "$formation_troop_26"),
    (this_or_next|eq, ":local1", "$formation_troop_27"),
    (this_or_next|eq, ":local1", "$formation_troop_28"),
    (this_or_next|eq, ":local1", "$formation_troop_29"),
    (this_or_next|eq, ":local1", "$formation_troop_30"),
    (this_or_next|eq, ":local1", "$formation_troop_31"),
    (this_or_next|eq, ":local1", "$formation_troop_32"),
    (this_or_next|eq, ":local1", "$formation_troop_33"),
    (this_or_next|eq, ":local1", "$formation_troop_34"),
    (this_or_next|eq, ":local1", "$formation_troop_35"),
    (this_or_next|eq, ":local1", "$formation_troop_36"),
    (this_or_next|eq, ":local1", "$formation_troop_37"),
    (is_between, ":local1", "trp_noldorin_commander", "trp_end_leaders"),
    (assign, reg1, 1),
        (try_begin),
        (assign, reg20, 1),
        (agent_get_slot, reg21, reg10, reg20),
        (eq, reg21, 0),
        (assign, reg1, reg20),
        (assign, reg3, reg1),
        (val_mul, reg3, 100),
        (copy_position, reg1, 1),
        (position_move_x, reg1, reg3, 0),
        (agent_set_scripted_destination, reg5, reg1),
        (agent_set_slot, reg5, 1, reg1),
        (agent_set_slot, reg10, reg20, 1),
        (else_try),
        (call_script, "script_formation_repeat", 0, 0),
    (try_end),
(try_end),
]), 

#script_formation_repeat
("formation_repeat",[
(val_add, reg20, 1),
(agent_get_slot, reg21, reg10, reg20),
(eq, reg21, 0),
(assign, reg1, reg20),
(assign, reg3, reg1),
(assign, reg4, 0),
    (try_begin),
    (eq, "$formation_type", 1),
        (try_for_range, reg15, 1, 100),
        (assign, reg17, reg15),
        (assign, reg16, reg15),
        (val_mul, reg15, 5),
        (val_mul, reg16, 5),
        (val_add, reg16, 5),
        (gt, reg3, reg15),
        (neg|gt, reg3, reg16),
        (assign, reg15, reg17),
        (val_mul, reg15, 6),
        (val_sub, reg3, reg15),
        (assign, reg4, reg17),
    (try_end),
(try_end),
(val_mul, reg3, 100),
(val_mul, reg4, 200),
(copy_position, reg1, 1),
(position_move_x, reg1, reg3, 0),
(position_move_y, reg1, reg4, 0),
(agent_set_scripted_destination, reg5, reg1),
(agent_set_slot, reg5, 1, reg1),
(agent_set_slot, reg10, reg20, 1),
]), 

#script_formation_fall_back_start
("formation_fall_back_start",[
(get_player_agent_no, reg10),
(scene_prop_get_instance, reg15, [opmask_scene_prop]1, 0),
(prop_instance_get_position, 1, reg15),
    (try_for_range, reg20, 1, 100),
    (agent_set_slot, reg10, reg20, 0),
(try_end),
    (try_for_agents, reg5),
    (assign, reg0, 0),
    (neg|eq, reg5, reg10),
    (agent_is_alive, reg5),
    (agent_is_human, reg5),
    (agent_is_ally, reg5),
    (agent_get_slot, ":local0", reg5, 2),
    (neg|eq, ":local0", 1),
    (assign, reg1, 1),
        (try_begin),
        (assign, reg20, 1),
        (agent_get_slot, reg21, reg10, reg20),
        (eq, reg21, 0),
        (assign, reg1, reg20),
        (assign, reg3, reg1),
        (val_mul, reg3, 100),
        (copy_position, reg1, 1),
        (position_move_x, reg1, reg3, 0),
        (agent_set_scripted_destination, reg5, reg1),
        (agent_set_slot, reg5, 1, reg1),
        (agent_set_slot, reg10, reg20, 1),
        (else_try),
        (call_script, "script_formation_repeat", 0, 0),
    (try_end),
(try_end),
]), 

#script_formation_repeat1
("formation_repeat1",[
(val_add, reg20, 1),
(agent_get_slot, reg21, reg10, reg20),
(eq, reg21, 0),
(assign, reg1, reg20),
(assign, reg3, reg1),
(assign, reg4, 0),
    (try_begin),
    (eq, "$formation_type", 1),
        (try_for_range, reg15, 1, 100),
        (assign, reg17, reg15),
        (assign, reg16, reg15),
        (val_mul, reg15, 5),
        (val_mul, reg16, 5),
        (val_add, reg16, 5),
        (gt, reg3, reg15),
        (neg|gt, reg3, reg16),
        (assign, reg15, reg17),
        (val_mul, reg15, 6),
        (val_sub, reg3, reg15),
        (assign, reg4, reg17),
    (try_end),
(try_end),
(val_mul, reg3, 100),
(val_mul, reg4, 200),
(copy_position, reg1, 1),
(position_move_x, reg1, reg3, 0),
(position_move_y, reg1, reg4, 0),
(agent_set_scripted_destination, reg5, reg1),
(agent_set_slot, reg5, 1, reg1),
(agent_set_slot, reg10, reg20, 1),
]), 

#script_cancel_formation
("cancel_formation",[
(get_player_agent_no, reg10),
    (try_for_agents, "$agent"),
    (neg|eq, "$agent", reg10),
    (agent_is_alive, "$agent"),
    (agent_is_human, "$agent"),
    (agent_is_ally, "$agent"),
    (agent_get_slot, ":local0", "$agent", 1),
    (neg|eq, ":local0", 0),
    (agent_clear_scripted_mode, "$agent"),
(try_end),
]), 

#script_load_melee_troops_for_formation
("load_melee_troops_for_formation",[
(assign, "$formation_troop_1", "trp_guardsman_of_gondor"),
(assign, "$formation_troop_2", "trp_infantry_of_gondor"),
(assign, "$formation_troop_3", "trp_veteran_infantry_of_gondor"),
(assign, "$formation_troop_4", "trp_heavy_infantry_of_gondor"),
(assign, "$formation_troop_5", "trp_knight_of_the_tower_guard"),
(assign, "$formation_troop_6", "trp_knight_of_the_fountain_court"),
(assign, "$formation_troop_7", "trp_guardsman_of_rohan"),
(assign, "$formation_troop_8", "trp_footman_of_rohan"),
(assign, "$formation_troop_9", "trp_veteran_footman_of_rohan"),
(assign, "$formation_troop_10", "trp_elite_footman_of_rohan"),
(assign, "$formation_troop_11", "trp_folcwine_guard_of_rohan"),
(assign, "$formation_troop_12", "trp_warden_of_methuseld"),
(assign, "$formation_troop_13", "trp_lothlorien_infantry"),
(assign, "$formation_troop_14", "trp_lothlorien_veteran_infantry"),
(assign, "$formation_troop_15", "trp_lothlorien_elite_infantry"),
(assign, "$formation_troop_16", "trp_galadhrim_royal_swordsman"),
(assign, "$formation_troop_17", "trp_greenwood_spearman"),
(assign, "$formation_troop_18", "trp_greenwood_veteran_spearman"),
(assign, "$formation_troop_19", "trp_greenwood_royal_spearman"),
(assign, "$formation_troop_20", "trp_uruk_hai_pikeman"),
(assign, "$formation_troop_21", "trp_fighting_uruk_hai_pikeman"),
(assign, "$formation_troop_22", "trp_pikeman_of_umbar"),
(assign, "$formation_troop_23", "trp_veteran_pikeman_of_umbar"),
(assign, "$formation_troop_24", "trp_pike_master_of_umbar"),
(assign, "$formation_troop_25", "trp_black_numenorian_warrior"),
(assign, "$formation_troop_26", "trp_black_numenorian_veteran_warrior"),
(assign, "$formation_troop_27", "trp_black_numenorian_champion"),
(assign, "$formation_troop_28", "trp_black_uruk_of_barad_dur"),
(assign, "$formation_troop_29", "trp_dunedain_warrior"),
(assign, "$formation_troop_30", "trp_dunedain_man_at_arms"),
(assign, "$formation_troop_31", "trp_dunedain_master_at_arms"),
(assign, "$formation_troop_32", "trp_high_swordsman_of_arnor"),
(assign, "$formation_troop_33", "trp_dunnish_long_spearman"),
(assign, "$formation_troop_34", "trp_dunnish_pike_master"),
(assign, "$formation_troop_35", "trp_lossarnach_axeman"),
(assign, "$formation_troop_36", "trp_veteran_lossarnach_axeman"),
(assign, "$formation_troop_37", "trp_master_lossarnach_axeman"),
]), 

#script_load_missile_troops_for_formation
("load_missile_troops_for_formation",[
(assign, "$formation_troop_1", "trp_archer_of_gondor"),
(assign, "$formation_troop_2", "trp_veteran_archer_of_gondor"),
(assign, "$formation_troop_3", "trp_master_yeoman_of_gondor"),
(assign, "$formation_troop_4", "trp_archer_of_the_tower_guard"),
(assign, "$formation_troop_5", "trp_harad_archer"),
(assign, "$formation_troop_6", "trp_harad_veteran_archer"),
(assign, "$formation_troop_7", "trp_harad_master_archer"),
(assign, "$formation_troop_8", "trp_blackroot_vale_archer"),
(assign, "$formation_troop_9", "trp_veteran_blackroot_vale_archer"),
(assign, "$formation_troop_10", "trp_master_blackroot_vale_archer"),
(assign, "$formation_troop_11", "trp_easterling_hurler"),
(assign, "$formation_troop_12", "trp_easterling_veteran_hurler"),
(assign, "$formation_troop_13", "trp_easterling_javelin_master"),
(assign, "$formation_troop_14", "trp_militia_of_umbar"),
(assign, "$formation_troop_15", "trp_marksman_of_umbar"),
(assign, "$formation_troop_16", "trp_veteran_marksman_of_umbar"),
(assign, "$formation_troop_17", "trp_master_marksman_of_umbar"),
(assign, "$formation_troop_18", "trp_orc_archer_of_mordor"),
(assign, "$formation_troop_19", "trp_large_orc_archer_of_mordor"),
(assign, "$formation_troop_20", "trp_fell_orc_archer_of_mordor"),
(assign, "$formation_troop_21", "trp_uruk_hai_scout"),
(assign, "$formation_troop_22", "trp_large_uruk_hai_scout"),
(assign, "$formation_troop_23", "trp_fighting_uruk_hai_scout"),
(assign, "$formation_troop_24", "trp_ranger_of_ithilien"),
(assign, "$formation_troop_25", "trp_veteran_ranger_of_ithilien"),
(assign, "$formation_troop_26", "trp_master_ranger_of_ithilien"),
(assign, "$formation_troop_27", 0),
(assign, "$formation_troop_28", 0),
(assign, "$formation_troop_29", 0),
(assign, "$formation_troop_30", 0),
(assign, "$formation_troop_31", 0),
(assign, "$formation_troop_32", 0),
(assign, "$formation_troop_33", 0),
(assign, "$formation_troop_34", 0),
(assign, "$formation_troop_35", 0),
(assign, "$formation_troop_36", 0),
(assign, "$formation_troop_37", 0),
]), 

#script_hero_leads_host
("hero_leads_host",[
(store_script_param_1, ":local0"),
(store_faction_of_party, ":local1", ":local0"),
(assign|shuffle_range, ":local2", 100, 0),
(neg|ge, ":local2", "$map_hero_setting"),
    (try_begin),
    (eq, ":local1", "fac_lothlorien"),
    (assign, reg1, "trp_map_haldir"),
    (assign, reg2, "trp_map_orophin"),
    (assign, reg3, "trp_map_elladan"),
    (assign, reg4, "trp_map_celeborn"),
    (assign, reg5, "trp_map_glorfindel"),
    (assign, ":local3", 5),
    (else_try),
    (eq, ":local1", "fac_rohan"),
    (assign, reg1, "trp_map_lord_grimbold"),
    (assign, reg2, "trp_map_lord_erkenbrand"),
    (assign, reg3, "trp_map_lord_freca"),
    (assign, reg4, "trp_map_lord_eowine"),
    (assign, reg5, "trp_map_lord_deorhelm"),
    (assign, reg6, "trp_map_lord_fastred"),
    (assign, reg7, "trp_map_lord_eomer"),
    (assign, reg8, "trp_map_lord_elfhelm"),
    (assign, reg9, "trp_map_lord_dunhere"),
    (assign, ":local3", 9),
    (else_try),
    (eq, ":local1", "fac_gondor"),
    (assign, reg1, "trp_map_lord_malvogil"),
    (assign, reg2, "trp_map_lord_halbarad"),
    (assign, reg3, "trp_map_lord_imrahil"),
    (assign, reg4, "trp_map_lord_orthalion"),
    (assign, reg5, "trp_map_lord_aravir"),
    (assign, reg6, "trp_map_lord_hirluin"),
    (assign, reg7, "trp_map_lord_faramir"),
    (assign, reg8, "trp_map_lord_forlong"),
    (assign, reg9, "trp_map_lord_hallas"),
    (assign, reg10, "trp_map_lord_dirhael"),
    (assign, ":local3", 10),
    (else_try),
    (eq, ":local1", "fac_isengard"),
    (assign, reg1, "trp_map_daeglaf_the_black"),
    (assign, reg2, "trp_map_ugluk"),
    (assign, reg3, "trp_map_mauhur"),
    (assign, reg4, "trp_map_mog_the_hunter"),
    (assign, ":local3", 4),
    (else_try),
    (eq, ":local1", "fac_dol_guldur"),
    (assign, reg1, "trp_map_general_tuskim"),
    (assign, ":local3", 1),
    (else_try),
    (eq, ":local1", "fac_moria"),
    (assign, reg1, "trp_map_bolg_the_lesser"),
    (assign, ":local3", 1),
    (else_try),
    (eq, ":local1", "fac_mordor"),
    (assign, reg1, "trp_map_warden_of_the_vale"),
    (assign, reg2, "trp_map_duessa"),
    (assign, reg3, "trp_map_captain_mortakh"),
    (assign, reg4, "trp_map_ul_ulcari"),
    (assign, reg5, "trp_map_varoujan"),
    (assign, reg6, "trp_map_captain_tulmir"),
    (assign, reg7, "trp_map_khamul"),
    (assign, ":local3", 7),
(try_end),
(assign, ":local4", 0),
    (try_for_range, ":local5", 0, 10),
    (neg|eq, ":local4", 1),
    (shuffle_range, 1, ":local3"),
    (troop_get_slot, ":local6", reg1, 0),
    (eq, ":local6", 0),
    (assign, ":local4", 1),
    (assign, ":local7", reg1),
(try_end),
(eq, ":local4", 1),
    (try_begin),
    (eq, reg1, "trp_map_haldir"),
    (assign, "$haldir_joined", 1),
    (remove_troop_from_site, "trp_haldir", "scn_tld_cerin_amroth"),
    (assign, ":local8", "trp_haldir"),
    (else_try),
    (eq, reg1, "trp_map_orophin"),
    (assign, "$orophin_joined", 1),
    (remove_troop_from_site, "trp_orophin", "scn_tld_cerin_dolen"),
    (assign, ":local8", "trp_orophin"),
    (else_try),
    (eq, reg1, "trp_map_celeborn"),
    (assign, "$celeborn_joined", 1),
    (remove_troop_from_site, "trp_lord_celeborn", "scn_tld_caras_galadhon"),
    (assign, ":local8", "trp_lord_celeborn"),
    (else_try),
    (eq, reg1, "trp_map_glorfindel"),
    (assign, "$glorfindel_joined", 1),
    (remove_troop_from_site, "trp_glorfindel", "scn_tld_caras_galadhon"),
    (assign, ":local8", "trp_glorfindel"),
    (else_try),
    (eq, reg1, "trp_map_lord_grimbold"),
    (assign, "$grimbold_joined", 1),
    (remove_troop_from_site, "trp_lord_grimbold", "scn_town_16_castle"),
    (assign, ":local8", "trp_lord_grimbold"),
    (else_try),
    (eq, reg1, "trp_map_lord_erkenbrand"),
    (assign, "$erkenbrand_joined", 1),
    (remove_troop_from_site, "trp_lord_erkenbrand", "scn_town_13_castle"),
    (assign, ":local8", "trp_lord_erkenbrand"),
    (else_try),
    (eq, reg1, "trp_map_lord_freca"),
    (assign, "$freca_joined", 1),
    (remove_troop_from_site, "trp_lord_freca", "scn_town_17_castle"),
    (assign, ":local8", "trp_lord_freca"),
    (else_try),
    (eq, reg1, "trp_map_lord_eowine"),
    (assign, "$eowine_joined", 1),
    (remove_troop_from_site, "trp_lord_eowine", "scn_town_14_castle"),
    (assign, ":local8", "trp_lord_eowine"),
    (else_try),
    (eq, reg1, "trp_map_lord_deorhelm"),
    (assign, "$deorhelm_joined", 1),
    (remove_troop_from_site, "trp_lord_deorhelm", "scn_town_15_castle"),
    (assign, ":local8", "trp_lord_deorhelm"),
    (else_try),
    (eq, reg1, "trp_map_lord_fastred"),
    (assign, "$fastred_joined", 1),
    (remove_troop_from_site, "trp_lord_fastred", "scn_town_12_castle"),
    (assign, ":local8", "trp_lord_fastred"),
    (else_try),
    (eq, reg1, "trp_map_lord_eomer"),
    (assign, "$eomer_joined", 1),
    (else_try),
    (eq, reg1, "trp_map_lord_elfhelm"),
    (assign, "$elfhelm_joined", 1),
    (remove_troop_from_site, "trp_lord_elfhelm", "scn_town_11_castle"),
    (assign, ":local8", "trp_lord_elfhelm"),
    (else_try),
    (eq, reg1, "trp_map_lord_dunhere"),
    (assign, "$dunhere_joined", 1),
    (remove_troop_from_site, "trp_lord_dunhere", "scn_town_11_castle"),
    (assign, ":local8", "trp_lord_dunhere"),
    (else_try),
    (eq, reg1, "trp_map_lord_malvogil"),
    (assign, "$malvogil_joined", 1),
    (remove_troop_from_site, "trp_lord_malvogil", "scn_town_3_castle"),
    (assign, ":local8", "trp_lord_malvogil"),
    (else_try),
    (eq, reg1, "trp_map_lord_halbarad"),
    (assign, "$halbarad_joined", 1),
    (remove_troop_from_site, "trp_lord_halbarad", "scn_town_2_castle"),
    (assign, ":local8", "trp_lord_halbarad"),
    (else_try),
    (eq, reg1, "trp_map_lord_imrahil"),
    (assign, "$imrahil_joined", 1),
    (remove_troop_from_site, "trp_lord_imrahil", "scn_town_4_castle"),
    (assign, ":local8", "trp_lord_imrahil"),
    (else_try),
    (eq, reg1, "trp_map_lord_orthalion"),
    (assign, "$orthalion_joined", 1),
    (remove_troop_from_site, "trp_lord_orthalion", "scn_town_5_castle"),
    (assign, ":local8", "trp_lord_orthalion"),
    (else_try),
    (eq, reg1, "trp_map_lord_aravir"),
    (assign, "$aravir_joined", 1),
    (remove_troop_from_site, "trp_lord_aravir", "scn_town_6_castle"),
    (assign, ":local8", "trp_lord_aravir"),
    (else_try),
    (eq, reg1, "trp_map_lord_hirluin"),
    (assign, "$hirluin_joined", 1),
    (remove_troop_from_site, "trp_lord_hirluin", "scn_town_10_castle"),
    (assign, ":local8", "trp_lord_hirluin"),
    (else_try),
    (eq, reg1, "trp_map_lord_faramir"),
    (assign, "$faramir_joined", 1),
    (remove_troop_from_site, "trp_lord_faramir", "scn_tld_henneth_annun"),
    (assign, ":local8", "trp_lord_faramir"),
    (else_try),
    (eq, reg1, "trp_map_lord_forlong"),
    (assign, "$forlong_joined", 1),
    (remove_troop_from_site, "trp_lord_forlong", "scn_town_7_castle"),
    (assign, ":local8", "trp_lord_forlong"),
    (else_try),
    (eq, reg1, "trp_map_lord_hallas"),
    (assign, "$hallas_joined", 1),
    (remove_troop_from_site, "trp_lord_hallas", "scn_town_8_castle"),
    (assign, ":local8", "trp_lord_hallas"),
    (else_try),
    (eq, reg1, "trp_map_lord_dirhael"),
    (assign, "$dirhael_joined", 1),
    (remove_troop_from_site, "trp_lord_dirhael", "scn_town_9_castle"),
    (assign, ":local8", "trp_lord_dirhael"),
    (else_try),
    (eq, reg1, "trp_map_daeglaf_the_black"),
    (assign, "$daeglaf_the_black_joined", 1),
    (remove_troop_from_site, "trp_daeglaf_the_black", "scn_tld_dunlander_camp"),
    (assign, ":local8", "trp_daeglaf_the_black"),
    (else_try),
    (eq, reg1, "trp_map_ugluk"),
    (assign, "$ugluk_joined", 1),
    (remove_troop_from_site, "trp_ugluk", "scn_tld_uruk_hai_river_camp"),
    (assign, ":local8", "trp_ugluk"),
    (else_try),
    (eq, reg1, "trp_map_mauhur"),
    (assign, "$mauhur_joined", 1),
    (remove_troop_from_site, "trp_mauhur", "scn_tld_uruk_hai_outpost"),
    (assign, ":local8", "trp_mauhur"),
    (else_try),
    (eq, reg1, "trp_map_mog_the_hunter"),
    (assign, "$mog_the_hunter_joined", 1),
    (remove_troop_from_site, "trp_mog_the_hunter", "scn_tld_uruk_hai_hunting_camp"),
    (assign, ":local8", "trp_mog_the_hunter"),
    (else_try),
    (eq, reg1, "trp_map_warden_of_the_vale"),
    (assign, "$warden_of_the_vale_joined", 1),
    (remove_troop_from_site, "trp_warden_of_the_vale", "scn_tld_minas_morgul_castle"),
    (assign, ":local8", "trp_warden_of_the_vale"),
    (else_try),
    (eq, reg1, "trp_map_captain_mortakh"),
    (assign, "$captain_mortakh_joined", 1),
    (remove_troop_from_site, "trp_captain_mortakh", "scn_tld_osgiliath_castle"),
    (assign, ":local8", "trp_captain_mortakh"),
    (else_try),
    (eq, reg1, "trp_map_duessa"),
    (assign, "$duessa_joined", 1),
    (remove_troop_from_site, "trp_duessa", "scn_tld_orc_sentry_camp"),
    (assign, ":local8", "trp_duessa"),
    (else_try),
    (eq, reg1, "trp_map_captain_tulmir"),
    (assign, "$captain_tulmir_joined", 1),
    (remove_troop_from_site, "trp_captain_tulmir", "scn_tld_corsair_camp"),
    (assign, ":local8", "trp_captain_tulmir"),
    (else_try),
    (eq, reg1, "trp_map_ul_ulcari"),
    (assign, "$ul_ulcari_joined", 1),
    (remove_troop_from_site, "trp_ul_ulcari", "scn_tld_haradrim_camp"),
    (assign, ":local8", "trp_ul_ulcari"),
    (else_try),
    (eq, reg1, "trp_map_varoujan"),
    (assign, "$varoujan_joined", 1),
    (remove_troop_from_site, "trp_varoujan", "scn_tld_easterling_north_camp"),
    (assign, ":local8", "trp_varoujan"),
    (else_try),
    (eq, reg1, "trp_map_khamul"),
    (assign, "$khamul_joined", 1),
    (remove_troop_from_site, "trp_captain_tulmir", "scn_tld_easterling_south_camp"),
    (assign, ":local8", "trp_captain_tulmir"),
    (else_try),
    (eq, reg1, "trp_map_general_tuskim"),
    (assign, "$general_tuskim_joined", 1),
    (remove_troop_from_site, "trp_general_tuskim", "scn_tld_dol_guldur_castle"),
    (assign, ":local8", "trp_general_tuskim"),
    (else_try),
    (eq, reg1, "trp_map_bolg_the_lesser"),
    (assign, "$bolg_the_lesser_joined", 1),
    (remove_troop_from_site, "trp_bolg_the_lesser", "scn_tld_moria_castle"),
    (assign, ":local8", "trp_bolg_the_lesser"),
    (else_try),
    (eq, reg1, "trp_map_elladan"),
    (assign, "$elladan_joined", 1),
    (remove_troop_from_site, "trp_elladan", "scn_tld_rivendell_elf_camp"),
    (assign, ":local8", "trp_haldir"),
    (assign, "$elrohir_joined", 1),
    (remove_troop_from_site, "trp_elrohir", "scn_tld_rivendell_elf_camp"),
    (party_add_leader, ":local0", "trp_map_elrohir", 1),
    (troop_set_slot, "trp_map_elrohir", 0, 2),
    (troop_set_slot, "trp_map_elrohir", 1, ":local0"),
    (val_add, "$number_of_heroes_leading_hosts", 1),
(try_end),
    (try_for_range, ":local9", "qst_generic_deliver_message", "qst_gov_quests_end"),
    (check_quest_active, ":local9", 1),
    (quest_get_slot, ":local10", ":local9", 0),
    (eq, ":local10", ":local8"),
    (cancel_quest, ":local9"),
    (str_store_troop_name, 1, ":local8"),
    (display_message, "@{s1}_has_taken_to_the_field_and_recinded_your_orders.", 4284901119),
(try_end),
(party_add_leader, ":local0", ":local7", 1),
(troop_set_slot, ":local7", 0, 2),
(troop_set_slot, ":local7", 1, ":local0"),
(val_add, "$number_of_heroes_leading_hosts", 1),
]), 

#script_capture_host_leaders
("capture_host_leaders",[
(store_script_param_1, ":local0"),
(party_count_members_of_type, ":local1", "$map_hero_root_defender_party", ":local0"),
(party_count_members_of_type, ":local2", "$map_hero_root_attacker_party", ":local0"),
(party_count_members_of_type, ":local3", "p_collective_ally", ":local0"),
(party_count_members_of_type, ":local4", "p_collective_enemy", ":local0"),
    (try_begin),
    (eq, ":local1", 1),
    (store_faction_of_party, ":local5", "$map_hero_root_attacker_party"),
    (else_try),
    (eq, ":local2", 1),
    (store_faction_of_party, ":local5", "$map_hero_root_defender_party"),
    (else_try),
    (eq, ":local3", 1),
    (store_faction_of_party, ":local5", "$map_hero_root_attacker_party"),
    (else_try),
    (eq, ":local4", 1),
    (store_faction_of_party, ":local5", "$map_hero_root_defender_party"),
(try_end),
(neg|eq, ":local5", 0),
(store_troop_faction, ":local6", ":local0"),
    (try_begin),
    (eq, ":local5", "fac_mordor"),
    (assign, ":local7", 3),
    (else_try),
    (eq, ":local5", "fac_haradrim"),
    (assign, ":local7", 3),
    (else_try),
    (eq, ":local5", "fac_easterlings"),
    (assign, ":local7", 3),
    (else_try),
    (eq, ":local5", "fac_corsairs"),
    (assign, ":local7", 3),
    (else_try),
    (eq, ":local5", "fac_dol_guldur"),
    (assign, ":local7", 3),
    (else_try),
    (eq, ":local5", "fac_isengard"),
    (assign, ":local7", 4),
    (else_try),
    (eq, ":local5", "fac_dunlanders"),
    (assign, ":local7", 4),
    (else_try),
    (eq, ":local5", "fac_moria"),
    (assign, ":local7", 4),
    (else_try),
    (eq, ":local5", "fac_rohan"),
    (assign, ":local7", 2),
    (else_try),
    (eq, ":local5", "fac_gondor"),
    (assign, ":local7", 1),
    (else_try),
    (eq, ":local5", "fac_imladris"),
    (assign, ":local7", 5),
    (else_try),
    (eq, ":local5", "fac_lothlorien"),
    (assign, ":local7", 5),
    (else_try),
    (eq, ":local5", "fac_woodelves"),
    (assign, ":local7", 5),
    (else_try),
    (assign, ":local7", 6),
(try_end),
(assign, ":local8", ":local7"),
(val_add, ":local8", 5),
(troop_set_slot, ":local0", 0, ":local8"),
    (try_begin),
    (eq, ":local0", "trp_map_haldir"),
    (assign, "$haldir_captured", 1),
    (troop_set_slot, "trp_haldir", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_orophin"),
    (assign, "$orophin_captured", 1),
    (troop_set_slot, "trp_orophin", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_elladan"),
    (assign, "$elladan_captured", 1),
    (troop_set_slot, "trp_elladan", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_elrohir"),
    (assign, "$elrohir_captured", 1),
    (troop_set_slot, "trp_elrohir", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_celeborn"),
    (assign, "$celeborn_captured", 1),
    (troop_set_slot, "trp_lord_celeborn", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_glorfindel"),
    (assign, "$glorfindel_captured", 1),
    (troop_set_slot, "trp_glorfindel", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_grimbold"),
    (assign, "$lord_grimbold_captured", 1),
    (troop_set_slot, "trp_lord_grimbold", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_erkenbrand"),
    (assign, "$lord_erkenbrand_captured", 1),
    (troop_set_slot, "trp_lord_erkenbrand", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_freca"),
    (assign, "$lord_freca_captured", 1),
    (troop_set_slot, "trp_lord_freca", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_eowine"),
    (assign, "$lord_eowine_captured", 1),
    (troop_set_slot, "trp_lord_eowine", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_deorhelm"),
    (assign, "$lord_deorhelm_captured", 1),
    (troop_set_slot, "trp_lord_deorhelm", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_fastred"),
    (assign, "$lord_fastred_captured", 1),
    (troop_set_slot, "trp_lord_fastred", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_eomer"),
    (assign, "$lord_eomer_captured", 1),
    (troop_set_slot, "trp_lord_eomer", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_elfhelm"),
    (assign, "$lord_elfhelm_captured", 1),
    (troop_set_slot, "trp_lord_elfhelm", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_dunhere"),
    (assign, "$lord_dunhere_captured", 1),
    (troop_set_slot, "trp_lord_dunhere", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_deorwine"),
    (assign, "$deorwine_captured", 1),
    (troop_set_slot, "trp_deorwine", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_guthlaf"),
    (assign, "$guthlaf_captured", 1),
    (troop_set_slot, "trp_guthlaf", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_hama"),
    (assign, "$hama_captured", 1),
    (troop_set_slot, "trp_hama", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_eowyn"),
    (assign, "$eowyn_captured", 1),
    (troop_set_slot, "trp_eowyn", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_malvogil"),
    (assign, "$lord_malvogil_captured", 1),
    (troop_set_slot, "trp_lord_malvogil", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_halbarad"),
    (assign, "$lord_halbarad_captured", 1),
    (troop_set_slot, "trp_lord_halbarad", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_imrahil"),
    (assign, "$lord_imrahil_captured", 1),
    (troop_set_slot, "trp_lord_imrahil", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_orthalion"),
    (assign, "$lord_orthalion_captured", 1),
    (troop_set_slot, "trp_lord_orthalion", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_aravir"),
    (assign, "$lord_aravir_captured", 1),
    (troop_set_slot, "trp_lord_aravir", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_hirluin"),
    (assign, "$lord_hirluin_captured", 1),
    (troop_set_slot, "trp_lord_hirluin", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_faramir"),
    (assign, "$lord_faramir_captured", 1),
    (troop_set_slot, "trp_lord_faramir", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_forlong"),
    (assign, "$lord_forlong_captured", 1),
    (troop_set_slot, "trp_lord_forlong", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_hallas"),
    (assign, "$lord_hallas_captured", 1),
    (troop_set_slot, "trp_lord_hallas", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_lord_dirhael"),
    (assign, "$lord_dirhael_captured", 1),
    (troop_set_slot, "trp_lord_dirhael", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_daeglaf_the_black"),
    (assign, "$daeglaf_the_black_captured", 1),
    (troop_set_slot, "trp_daeglaf_the_black", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_ugluk"),
    (assign, "$ugluk_captured", 1),
    (troop_set_slot, "trp_ugluk", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_mauhur"),
    (assign, "$mauhur_captured", 1),
    (troop_set_slot, "trp_mauhur", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_mog_the_hunter"),
    (assign, "$mog_the_hunter_captured", 1),
    (troop_set_slot, "trp_mog_the_hunter", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_warden_of_the_vale"),
    (assign, "$warden_of_the_vale_captured", 1),
    (troop_set_slot, "trp_warden_of_the_vale", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_captain_mortakh"),
    (assign, "$captain_mortakh_captured", 1),
    (troop_set_slot, "trp_captain_mortakh", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_duessa"),
    (assign, "$duessa_captured", 1),
    (troop_set_slot, "trp_duessa", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_captain_tulmir"),
    (assign, "$captain_tulmir_captured", 1),
    (troop_set_slot, "trp_captain_tulmir", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_ul_ulcari"),
    (assign, "$ul_ulcari_captured", 1),
    (troop_set_slot, "trp_ul_ulcari", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_varoujan"),
    (assign, "$varoujan_captured", 1),
    (troop_set_slot, "trp_varoujan", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_khamul"),
    (assign, "$khamul_captured", 1),
    (troop_set_slot, "trp_khamul", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_general_tuskim"),
    (assign, "$general_tuskim_captured", 1),
    (troop_set_slot, "trp_general_tuskim", 0, ":local8"),
    (else_try),
    (eq, ":local0", "trp_map_bolg_the_lesser"),
    (assign, "$bolg_the_lesser_captured", 1),
    (troop_set_slot, "trp_bolg_the_lesser", 0, ":local8"),
(try_end),
(str_store_troop_name, 1, ":local0"),
    (try_begin),
    (eq, ":local7", 1),
    (val_add, "$heroes_captured_by_gondor", 1),
    (display_message, "@The_men_of_Gondor_have_captured_{s1}_in_battle!", 4294901760),
    (else_try),
    (eq, ":local7", 2),
    (val_add, "$heroes_captured_by_rohan", 1),
    (display_message, "@The_men_of_Rohan_have_captured_{s1}_in_battle!", 4294901760),
    (else_try),
    (eq, ":local7", 3),
    (val_add, "$heroes_captured_by_mordor", 1),
    (display_message, "@The_forces_of_Mordor_have_captured_{s1}_in_battle!", 4294901760),
    (else_try),
    (eq, ":local7", 4),
    (val_add, "$heroes_captured_by_isengard", 1),
    (display_message, "@The_forces_of_Isengard_have_captured_{s1}_in_battle!", 4294901760),
    (else_try),
    (eq, ":local7", 5),
    (val_add, "$heroes_captured_by_elves", 1),
    (display_message, "@The_Elves_have_captured_{s1}_in_battle!", 4294901760),
    (display_message, "@He_is_unlikely_to_be_heard_from_again!", 4294901760),
    (else_try),
    (eq, ":local7", 6),
    (val_add, "$heroes_captured_by_neutrals", 1),
    (display_message, "@Lawless_raiders_have_captured_{s1}_in_battle!", 4294901760),
    (display_message, "@He_is_unlikely_to_be_heard_from_again!", 4294901760),
(try_end),
(val_sub, "$number_of_heroes_leading_hosts", 1),
]), 

#script_hero_leader_killed_abstractly
("hero_leader_killed_abstractly",[
(store_script_param_1, ":local0"),
    (try_begin),
    (eq, ":local0", "trp_map_haldir"),
    (troop_set_slot, "trp_haldir", 0, 5),
    (assign, ":local1", "p_mound_of_haldir"),
    (else_try),
    (eq, ":local0", "trp_map_orophin"),
    (troop_set_slot, "trp_orophin", 0, 5),
    (assign, ":local1", "p_mound_of_orophin"),
    (else_try),
    (eq, ":local0", "trp_map_elladan"),
    (troop_set_slot, "trp_elladan", 0, 5),
    (assign, ":local1", "p_mound_of_elladan"),
    (else_try),
    (eq, ":local0", "trp_map_elrohir"),
    (troop_set_slot, "trp_elrohir", 0, 5),
    (assign, ":local1", "p_mound_of_elrohir"),
    (else_try),
    (eq, ":local0", "trp_map_celeborn"),
    (troop_set_slot, "trp_lord_celeborn", 0, 5),
    (assign, ":local1", "p_mound_of_celeborn"),
    (else_try),
    (eq, ":local0", "trp_map_glorfindel"),
    (troop_set_slot, "trp_glorfindel", 0, 5),
    (assign, ":local1", "p_mound_of_glorfindel"),
    (else_try),
    (eq, ":local0", "trp_map_lord_grimbold"),
    (troop_set_slot, "trp_lord_grimbold", 0, 5),
    (assign, ":local1", "p_mound_of_grimbold"),
    (else_try),
    (eq, ":local0", "trp_map_lord_erkenbrand"),
    (troop_set_slot, "trp_lord_erkenbrand", 0, 5),
    (assign, ":local1", "p_mound_of_erkenbrand"),
    (else_try),
    (eq, ":local0", "trp_map_lord_freca"),
    (troop_set_slot, "trp_lord_freca", 0, 5),
    (assign, ":local1", "p_mound_of_freca"),
    (else_try),
    (eq, ":local0", "trp_map_lord_eowine"),
    (troop_set_slot, "trp_lord_eowine", 0, 5),
    (assign, ":local1", "p_mound_of_eowine"),
    (else_try),
    (eq, ":local0", "trp_map_lord_deorhelm"),
    (troop_set_slot, "trp_lord_deorhelm", 0, 5),
    (assign, ":local1", "p_mound_of_deorhelm"),
    (else_try),
    (eq, ":local0", "trp_map_lord_fastred"),
    (troop_set_slot, "trp_lord_fastred", 0, 5),
    (assign, ":local1", "p_mound_of_fastred"),
    (else_try),
    (eq, ":local0", "trp_map_king_theoden"),
    (troop_set_slot, "trp_king_theoden", 0, 5),
    (assign, ":local1", "p_mound_of_theoden"),
    (else_try),
    (eq, ":local0", "trp_map_lord_eomer"),
    (troop_set_slot, "trp_lord_eomer", 0, 5),
    (assign, ":local1", "p_mound_of_eomer"),
    (else_try),
    (eq, ":local0", "trp_map_lord_elfhelm"),
    (troop_set_slot, "trp_lord_elfhelm", 0, 5),
    (assign, ":local1", "p_mound_of_elfhelm"),
    (else_try),
    (eq, ":local0", "trp_map_lord_dunhere"),
    (troop_set_slot, "trp_lord_dunhere", 0, 5),
    (assign, ":local1", "p_mound_of_dunhere"),
    (else_try),
    (eq, ":local0", "trp_map_deorwine"),
    (troop_set_slot, "trp_deorwine", 0, 5),
    (assign, ":local1", "p_mound_of_deorwine"),
    (else_try),
    (eq, ":local0", "trp_map_guthlaf"),
    (troop_set_slot, "trp_guthlaf", 0, 5),
    (assign, ":local1", "p_mound_of_guthlaf"),
    (else_try),
    (eq, ":local0", "trp_map_hama"),
    (troop_set_slot, "trp_hama", 0, 5),
    (assign, ":local1", "p_mound_of_hama"),
    (else_try),
    (eq, ":local0", "trp_map_eowyn"),
    (troop_set_slot, "trp_eowyn", 0, 5),
    (assign, ":local1", "p_mound_of_eowyn"),
    (else_try),
    (eq, ":local0", "trp_map_lord_malvogil"),
    (troop_set_slot, "trp_lord_malvogil", 0, 5),
    (assign, ":local1", "p_mound_of_malvogil"),
    (else_try),
    (eq, ":local0", "trp_map_lord_halbarad"),
    (troop_set_slot, "trp_lord_halbarad", 0, 5),
    (assign, ":local1", "p_mound_of_halbarad"),
    (else_try),
    (eq, ":local0", "trp_map_lord_imrahil"),
    (troop_set_slot, "trp_lord_imrahil", 0, 5),
    (assign, ":local1", "p_mound_of_imrahil"),
    (else_try),
    (eq, ":local0", "trp_map_lord_orthalion"),
    (troop_set_slot, "trp_lord_orthalion", 0, 5),
    (assign, ":local1", "p_mound_of_orthalion"),
    (else_try),
    (eq, ":local0", "trp_map_lord_aravir"),
    (troop_set_slot, "trp_lord_aravir", 0, 5),
    (assign, ":local1", "p_mound_of_aravir"),
    (else_try),
    (eq, ":local0", "trp_map_lord_hirluin"),
    (troop_set_slot, "trp_lord_hirluin", 0, 5),
    (assign, ":local1", "p_mound_of_hirluin"),
    (else_try),
    (eq, ":local0", "trp_map_lord_faramir"),
    (troop_set_slot, "trp_lord_faramir", 0, 5),
    (assign, ":local1", "p_mound_of_faramir"),
    (else_try),
    (eq, ":local0", "trp_map_lord_forlong"),
    (troop_set_slot, "trp_lord_forlong", 0, 5),
    (assign, ":local1", "p_mound_of_forlong"),
    (else_try),
    (eq, ":local0", "trp_map_lord_hallas"),
    (troop_set_slot, "trp_lord_hallas", 0, 5),
    (assign, ":local1", "p_mound_of_hallas"),
    (else_try),
    (eq, ":local0", "trp_map_lord_dirhael"),
    (troop_set_slot, "trp_lord_dirhael", 0, 5),
    (assign, ":local1", "p_mound_of_dirhael"),
    (else_try),
    (eq, ":local0", "trp_map_daeglaf_the_black"),
    (troop_set_slot, "trp_daeglaf_the_black", 0, 5),
    (assign, ":local1", "p_pyre_of_daeglaf"),
    (else_try),
    (eq, ":local0", "trp_map_ugluk"),
    (troop_set_slot, "trp_ugluk", 0, 5),
    (assign, ":local1", 0),
    (else_try),
    (eq, ":local0", "trp_map_mauhur"),
    (troop_set_slot, "trp_mauhur", 0, 5),
    (assign, ":local1", 0),
    (else_try),
    (eq, ":local0", "trp_map_mog_the_hunter"),
    (troop_set_slot, "trp_mog_the_hunter", 0, 5),
    (assign, ":local1", 0),
    (else_try),
    (eq, ":local0", "trp_map_warden_of_the_vale"),
    (troop_set_slot, "trp_warden_of_the_vale", 0, 5),
    (assign, ":local1", "p_pyre_of_gothmog"),
    (else_try),
    (eq, ":local0", "trp_map_captain_mortakh"),
    (troop_set_slot, "trp_captain_mortakh", 0, 5),
    (assign, ":local1", "p_pyre_of_mortakh"),
    (else_try),
    (eq, ":local0", "trp_map_duessa"),
    (troop_set_slot, "trp_duessa", 0, 5),
    (assign, ":local1", "p_pyre_of_duessa"),
    (else_try),
    (eq, ":local0", "trp_map_captain_tulmir"),
    (troop_set_slot, "trp_captain_tulmir", 0, 5),
    (assign, ":local1", "p_pyre_of_tulmir"),
    (else_try),
    (eq, ":local0", "trp_map_ul_ulcari"),
    (troop_set_slot, "trp_ul_ulcari", 0, 5),
    (assign, ":local1", "p_pyre_of_ul_ulcari"),
    (else_try),
    (eq, ":local0", "trp_map_varoujan"),
    (troop_set_slot, "trp_varoujan", 0, 5),
    (assign, ":local1", "p_pyre_of_varoujan"),
    (else_try),
    (eq, ":local0", "trp_map_khamul"),
    (troop_set_slot, "trp_khamul", 0, 5),
    (assign, ":local1", "p_pyre_of_khamul"),
    (else_try),
    (eq, ":local0", "trp_map_general_tuskim"),
    (troop_set_slot, "trp_general_tuskim", 0, 5),
    (assign, ":local1", 0),
    (else_try),
    (eq, ":local0", "trp_map_bolg_the_lesser"),
    (troop_set_slot, "trp_bolg_the_lesser", 0, 5),
    (assign, ":local1", 0),
(try_end),
(troop_set_slot, ":local0", 0, 5),
(str_store_troop_name, 1, ":local0"),
(display_message, "@News_has_arrived_that_{s1}_was_killed_in_battle!", 4294901760),
(val_sub, "$number_of_heroes_leading_hosts", 1),
    (try_begin),
    (neg|eq, ":local1", 0),
    (troop_get_slot, ":local2", ":local0", 1),
    (party_relocate_near_party, ":local1", ":local2", 1),
    (enable_party, ":local1"),
    (party_set_slot, ":local1", 5, 1),
    (party_set_slot, ":local1", 6, ":local0"),
(try_end),
]), 

#script_build_mound_for_dead_hero
("build_mound_for_dead_hero",[
(store_script_param_1, ":local0"),
    (try_begin),
    (eq, ":local0", "trp_haldir"),
    (assign, ":local1", "p_mound_of_haldir"),
    (else_try),
    (eq, ":local0", "trp_orophin"),
    (assign, ":local1", "p_mound_of_orophin"),
    (else_try),
    (eq, ":local0", "trp_elladan"),
    (assign, ":local1", "p_mound_of_elladan"),
    (else_try),
    (eq, ":local0", "trp_elrohir"),
    (assign, ":local1", "p_mound_of_elrohir"),
    (else_try),
    (eq, ":local0", "trp_lord_celeborn"),
    (assign, ":local1", "p_mound_of_celeborn"),
    (else_try),
    (eq, ":local0", "trp_glorfindel"),
    (assign, ":local1", "p_mound_of_glorfindel"),
    (else_try),
    (eq, ":local0", "trp_mablung"),
    (assign, ":local1", "p_mound_of_mablung"),
    (else_try),
    (eq, ":local0", "trp_ulfas"),
    (assign, ":local1", "p_mound_of_ulfas"),
    (else_try),
    (eq, ":local0", "trp_eothain"),
    (assign, ":local1", "p_mound_of_eothain"),
    (else_try),
    (eq, ":local0", "trp_duilin"),
    (assign, ":local1", "p_mound_of_duilin"),
    (else_try),
    (eq, ":local0", "trp_lord_grimbold"),
    (assign, ":local1", "p_mound_of_grimbold"),
    (else_try),
    (eq, ":local0", "trp_lord_erkenbrand"),
    (assign, ":local1", "p_mound_of_erkenbrand"),
    (else_try),
    (eq, ":local0", "trp_lord_freca"),
    (assign, ":local1", "p_mound_of_freca"),
    (else_try),
    (eq, ":local0", "trp_lord_eowine"),
    (assign, ":local1", "p_mound_of_eowine"),
    (else_try),
    (eq, ":local0", "trp_lord_deorhelm"),
    (assign, ":local1", "p_mound_of_deorhelm"),
    (else_try),
    (eq, ":local0", "trp_lord_fastred"),
    (assign, ":local1", "p_mound_of_fastred"),
    (else_try),
    (eq, ":local0", "trp_king_theoden"),
    (assign, ":local1", "p_mound_of_theoden"),
    (else_try),
    (eq, ":local0", "trp_lord_eomer"),
    (assign, ":local1", "p_mound_of_eomer"),
    (else_try),
    (eq, ":local0", "trp_lord_elfhelm"),
    (assign, ":local1", "p_mound_of_elfhelm"),
    (else_try),
    (eq, ":local0", "trp_lord_dunhere"),
    (assign, ":local1", "p_mound_of_dunhere"),
    (else_try),
    (eq, ":local0", "trp_deorwine"),
    (assign, ":local1", "p_mound_of_deorwine"),
    (else_try),
    (eq, ":local0", "trp_guthlaf"),
    (assign, ":local1", "p_mound_of_guthlaf"),
    (else_try),
    (eq, ":local0", "trp_hama"),
    (assign, ":local1", "p_mound_of_hama"),
    (else_try),
    (eq, ":local0", "trp_eowyn"),
    (assign, ":local1", "p_mound_of_eowyn"),
    (else_try),
    (eq, ":local0", "trp_lord_malvogil"),
    (assign, ":local1", "p_mound_of_malvogil"),
    (else_try),
    (eq, ":local0", "trp_lord_halbarad"),
    (assign, ":local1", "p_mound_of_halbarad"),
    (else_try),
    (eq, ":local0", "trp_lord_imrahil"),
    (assign, ":local1", "p_mound_of_imrahil"),
    (else_try),
    (eq, ":local0", "trp_lord_orthalion"),
    (assign, ":local1", "p_mound_of_orthalion"),
    (else_try),
    (eq, ":local0", "trp_lord_aravir"),
    (assign, ":local1", "p_mound_of_aravir"),
    (else_try),
    (eq, ":local0", "trp_lord_hirluin"),
    (assign, ":local1", "p_mound_of_hirluin"),
    (else_try),
    (eq, ":local0", "trp_lord_faramir"),
    (assign, ":local1", "p_mound_of_faramir"),
    (else_try),
    (eq, ":local0", "trp_lord_forlong"),
    (assign, ":local1", "p_mound_of_forlong"),
    (else_try),
    (eq, ":local0", "trp_lord_hallas"),
    (assign, ":local1", "p_mound_of_hallas"),
    (else_try),
    (eq, ":local0", "trp_lord_dirhael"),
    (assign, ":local1", "p_mound_of_dirhael"),
    (else_try),
    (eq, ":local0", "trp_ugluk"),
    (assign, ":local1", 0),
    (else_try),
    (eq, ":local0", "trp_mauhur"),
    (assign, ":local1", 0),
    (else_try),
    (eq, ":local0", "trp_mog_the_hunter"),
    (assign, ":local1", 0),
    (else_try),
    (eq, ":local0", "trp_daeglaf_the_black"),
    (assign, ":local1", "p_pyre_of_daeglaf"),
    (else_try),
    (eq, ":local0", "trp_warden_of_the_vale"),
    (assign, ":local1", "p_pyre_of_gothmog"),
    (else_try),
    (eq, ":local0", "trp_captain_mortakh"),
    (assign, ":local1", "p_pyre_of_mortakh"),
    (else_try),
    (eq, ":local0", "trp_duessa"),
    (assign, ":local1", "p_pyre_of_duessa"),
    (else_try),
    (eq, ":local0", "trp_captain_tulmir"),
    (assign, ":local1", "p_pyre_of_tulmir"),
    (else_try),
    (eq, ":local0", "trp_ul_ulcari"),
    (assign, ":local1", "p_pyre_of_ul_ulcari"),
    (else_try),
    (eq, ":local0", "trp_varoujan"),
    (assign, ":local1", "p_pyre_of_varoujan"),
    (else_try),
    (eq, ":local0", "trp_khamul"),
    (assign, ":local1", "p_pyre_of_khamul"),
    (else_try),
    (eq, ":local0", "trp_general_tuskim"),
    (assign, ":local1", 0),
    (else_try),
    (eq, ":local0", "trp_bolg_the_lesser"),
    (assign, ":local1", 0),
    (else_try),
    (ge, "$faction_gondor_member_status", 2),
    (eq, ":local0", "trp_julute"),
    (assign, ":local1", "p_mound_of_julute"),
    (else_try),
    (eq, "$faction_gondor_member_status", 0),
    (eq, ":local0", "trp_julute"),
    (assign, ":local1", 0),
(try_end),
(neg|eq, ":local1", 0),
(party_relocate_near_party, ":local1", "p_main_party", 1),
(enable_party, ":local1"),
(party_set_slot, ":local1", 5, 1),
(party_set_slot, ":local1", 6, ":local0"),
]), 

#script_hero_host_leader_present
("hero_host_leader_present",[
    (try_for_range, ":local0", "trp_map_heroes_begin", "trp_map_heroes_end"),
    (assign, ":local1", 0),
        (try_begin),
        (party_count_companions_of_type, ":local1", "p_collective_enemy", ":local0"),
        (eq, ":local1", 1),
        (str_store_troop_name, 1, ":local0"),
        (assign, "$map_hero_present_in_battle", 1),
        (troop_set_slot, ":local0", 2, 1),
        (else_try),
        (party_count_companions_of_type, ":local1", "p_collective_ally", ":local0"),
        (eq, ":local1", 1),
        (str_store_troop_name, 1, ":local0"),
        (assign, "$map_hero_present_in_battle", 1),
        (troop_set_slot, ":local0", 2, 1),
    (try_end),
(try_end),
]), 

#script_hero_leader_check_for_death_after_player_battle
("hero_leader_check_for_death_after_player_battle",[
    (try_for_range, ":local0", "trp_map_heroes_begin", "trp_map_heroes_end"),
    (troop_get_slot, ":local1", ":local0", 2),
    (eq, ":local1", 1),
    (troop_get_slot, ":local2", ":local0", 1),
    (party_count_members_of_type, ":local3", ":local2", ":local0"),
    (eq, ":local3", 0),
    (troop_get_slot, ":local4", ":local0", 0),
    (neg|is_between, ":local4", 6, 12),
    (assign, ":local5", 0),
        (try_begin),
        (store_troop_count_prisoners, ":local5", ":local0", "p_main_party"),
        (eq, ":local5", 1),
        (troop_set_slot, ":local0", 0, 12),
        (str_store_troop_name, 1, ":local0"),
        (display_message, "@{s1}_has_been_captured!", 4294901760),
        (val_sub, "$number_of_heroes_leading_hosts", 1),
    (try_end),
    (neg|eq, ":local5", 1),
    (val_sub, "$number_of_heroes_leading_hosts", 1),
    (troop_set_slot, ":local0", 0, 5),
    (troop_set_slot, ":local0", 3, 1),
        (try_begin),
        (eq, ":local0", "trp_map_haldir"),
        (troop_set_slot, "trp_haldir", 0, 5),
        (assign, ":local6", "p_mound_of_haldir"),
        (else_try),
        (eq, ":local0", "trp_map_orophin"),
        (troop_set_slot, "trp_orophin", 0, 5),
        (assign, ":local6", "p_mound_of_orophin"),
        (else_try),
        (eq, ":local0", "trp_map_elladan"),
        (troop_set_slot, "trp_elladan", 0, 5),
        (assign, ":local6", "p_mound_of_elladan"),
        (else_try),
        (eq, ":local0", "trp_map_elrohir"),
        (troop_set_slot, "trp_elrohir", 0, 5),
        (assign, ":local6", "p_mound_of_elrohir"),
        (else_try),
        (eq, ":local0", "trp_map_celeborn"),
        (troop_set_slot, "trp_lord_celeborn", 0, 5),
        (assign, ":local6", "p_mound_of_celeborn"),
        (else_try),
        (eq, ":local0", "trp_map_glorfindel"),
        (troop_set_slot, "trp_glorfindel", 0, 5),
        (assign, ":local6", "p_mound_of_glorfindel"),
        (else_try),
        (eq, ":local0", "trp_map_lord_grimbold"),
        (troop_set_slot, "trp_lord_grimbold", 0, 5),
        (assign, ":local6", "p_mound_of_grimbold"),
        (else_try),
        (eq, ":local0", "trp_map_lord_erkenbrand"),
        (troop_set_slot, "trp_lord_erkenbrand", 0, 5),
        (assign, ":local6", "p_mound_of_erkenbrand"),
        (else_try),
        (eq, ":local0", "trp_map_lord_freca"),
        (troop_set_slot, "trp_lord_freca", 0, 5),
        (assign, ":local6", "p_mound_of_freca"),
        (else_try),
        (eq, ":local0", "trp_map_lord_eowine"),
        (troop_set_slot, "trp_lord_eowine", 0, 5),
        (assign, ":local6", "p_mound_of_eowine"),
        (else_try),
        (eq, ":local0", "trp_map_lord_deorhelm"),
        (troop_set_slot, "trp_lord_deorhelm", 0, 5),
        (assign, ":local6", "p_mound_of_deorhelm"),
        (else_try),
        (eq, ":local0", "trp_map_lord_fastred"),
        (troop_set_slot, "trp_lord_fastred", 0, 5),
        (assign, ":local6", "p_mound_of_fastred"),
        (else_try),
        (eq, ":local0", "trp_map_king_theoden"),
        (troop_set_slot, "trp_king_theoden", 0, 5),
        (assign, ":local6", "p_mound_of_theoden"),
        (else_try),
        (eq, ":local0", "trp_map_lord_eomer"),
        (troop_set_slot, "trp_lord_eomer", 0, 5),
        (assign, ":local6", "p_mound_of_eomer"),
        (else_try),
        (eq, ":local0", "trp_map_lord_elfhelm"),
        (troop_set_slot, "trp_lord_elfhelm", 0, 5),
        (assign, ":local6", "p_mound_of_elfhelm"),
        (else_try),
        (eq, ":local0", "trp_map_lord_dunhere"),
        (troop_set_slot, "trp_lord_dunhere", 0, 5),
        (assign, ":local6", "p_mound_of_dunhere"),
        (else_try),
        (eq, ":local0", "trp_map_deorwine"),
        (troop_set_slot, "trp_deorwine", 0, 5),
        (assign, ":local6", "p_mound_of_deorwine"),
        (else_try),
        (eq, ":local0", "trp_map_guthlaf"),
        (troop_set_slot, "trp_guthlaf", 0, 5),
        (assign, ":local6", "p_mound_of_guthlaf"),
        (else_try),
        (eq, ":local0", "trp_map_hama"),
        (troop_set_slot, "trp_hama", 0, 5),
        (assign, ":local6", "p_mound_of_hama"),
        (else_try),
        (eq, ":local0", "trp_map_eowyn"),
        (troop_set_slot, "trp_eowyn", 0, 5),
        (assign, ":local6", "p_mound_of_eowyn"),
        (else_try),
        (eq, ":local0", "trp_map_lord_malvogil"),
        (troop_set_slot, "trp_lord_malvogil", 0, 5),
        (assign, ":local6", "p_mound_of_malvogil"),
        (else_try),
        (eq, ":local0", "trp_map_lord_halbarad"),
        (troop_set_slot, "trp_lord_halbarad", 0, 5),
        (assign, ":local6", "p_mound_of_halbarad"),
        (else_try),
        (eq, ":local0", "trp_map_lord_imrahil"),
        (troop_set_slot, "trp_lord_imrahil", 0, 5),
        (assign, ":local6", "p_mound_of_imrahil"),
        (else_try),
        (eq, ":local0", "trp_map_lord_orthalion"),
        (troop_set_slot, "trp_lord_orthalion", 0, 5),
        (assign, ":local6", "p_mound_of_orthalion"),
        (else_try),
        (eq, ":local0", "trp_map_lord_aravir"),
        (troop_set_slot, "trp_lord_aravir", 0, 5),
        (assign, ":local6", "p_mound_of_aravir"),
        (else_try),
        (eq, ":local0", "trp_map_lord_hirluin"),
        (troop_set_slot, "trp_lord_hirluin", 0, 5),
        (assign, ":local6", "p_mound_of_hirluin"),
        (else_try),
        (eq, ":local0", "trp_map_lord_faramir"),
        (troop_set_slot, "trp_lord_faramir", 0, 5),
        (assign, ":local6", "p_mound_of_faramir"),
        (else_try),
        (eq, ":local0", "trp_map_lord_forlong"),
        (troop_set_slot, "trp_lord_forlong", 0, 5),
        (assign, ":local6", "p_mound_of_forlong"),
        (else_try),
        (eq, ":local0", "trp_map_lord_hallas"),
        (troop_set_slot, "trp_lord_hallas", 0, 5),
        (assign, ":local6", "p_mound_of_hallas"),
        (else_try),
        (eq, ":local0", "trp_map_lord_dirhael"),
        (troop_set_slot, "trp_lord_dirhael", 0, 5),
        (assign, ":local6", "p_mound_of_dirhael"),
        (else_try),
        (eq, ":local0", "trp_map_daeglaf_the_black"),
        (troop_set_slot, "trp_daeglaf_the_black", 0, 5),
        (assign, ":local6", "p_pyre_of_daeglaf"),
        (else_try),
        (eq, ":local0", "trp_map_ugluk"),
        (troop_set_slot, "trp_ugluk", 0, 5),
        (assign, ":local6", 0),
        (else_try),
        (eq, ":local0", "trp_map_mauhur"),
        (troop_set_slot, "trp_mauhur", 0, 5),
        (assign, ":local6", 0),
        (else_try),
        (eq, ":local0", "trp_map_mog_the_hunter"),
        (troop_set_slot, "trp_mog_the_hunter", 0, 5),
        (assign, ":local6", 0),
        (else_try),
        (eq, ":local0", "trp_map_warden_of_the_vale"),
        (troop_set_slot, "trp_warden_of_the_vale", 0, 5),
        (assign, ":local6", "p_pyre_of_gothmog"),
        (else_try),
        (eq, ":local0", "trp_map_captain_mortakh"),
        (troop_set_slot, "trp_captain_mortakh", 0, 5),
        (assign, ":local6", "p_pyre_of_mortakh"),
        (else_try),
        (eq, ":local0", "trp_map_duessa"),
        (troop_set_slot, "trp_duessa", 0, 5),
        (assign, ":local6", "p_pyre_of_duessa"),
        (else_try),
        (eq, ":local0", "trp_map_captain_tulmir"),
        (troop_set_slot, "trp_captain_tulmir", 0, 5),
        (assign, ":local6", "p_pyre_of_tulmir"),
        (else_try),
        (eq, ":local0", "trp_map_ul_ulcari"),
        (troop_set_slot, "trp_ul_ulcari", 0, 5),
        (assign, ":local6", "p_pyre_of_ul_ulcari"),
        (else_try),
        (eq, ":local0", "trp_map_varoujan"),
        (troop_set_slot, "trp_varoujan", 0, 5),
        (assign, ":local6", "p_pyre_of_varoujan"),
        (else_try),
        (eq, ":local0", "trp_map_khamul"),
        (troop_set_slot, "trp_khamul", 0, 5),
        (assign, ":local6", "p_pyre_of_khamul"),
        (else_try),
        (eq, ":local0", "trp_map_general_tuskim"),
        (troop_set_slot, "trp_general_tuskim", 0, 5),
        (assign, ":local6", 0),
        (else_try),
        (eq, ":local0", "trp_map_bolg_the_lesser"),
        (troop_set_slot, "trp_bolg_the_lesser", 0, 5),
        (assign, ":local6", 0),
    (try_end),
    (str_store_troop_name, 1, ":local0"),
    (store_troop_faction, ":local7", ":local0"),
    (store_relation, ":local8", ":local7", "fac_player_faction"),
    (party_get_template_id, ":local9", ":local2"),
    (store_num_parties_of_template, ":local10", ":local9"),
        (try_begin),
        (neg|gt, ":local8", -1),
        (eq, ":local10", 0),
        (display_message, "@{s1}_was_killed_in_this_battle!", 4294901760),
        (display_message, "@The_body_was_despoiled_and_burned.", 4294954035),
        (else_try),
        (neg|gt, ":local8", -1),
        (eq, ":local10", 1),
        (display_message, "@{s1}_was_killed_in_this_battle!", 4294901760),
        (display_message, "@_", 4294954035),
        (else_try),
        (ge, ":local8", 1),
        (eq, ":local10", 1),
        (display_message, "@{s1}_was_killed_in_this_battle!", 4294901760),
        (ge, "$faction_gondor_member_status", 2),
        (display_message, "@A_great_mound_was_raised_over_the_body", 4294954035),
        (else_try),
        (ge, ":local8", 1),
        (eq, ":local10", 0),
        (display_message, "@{s1}_was_killed_in_this_battle!", 4294901760),
        (display_message, "@The_body_was_despoiled_by_the_enemy.", 4294954035),
    (try_end),
    (neg|eq, ":local6", 0),
    (party_relocate_near_party, ":local6", "p_main_party", 1),
    (enable_party, ":local6"),
    (party_set_slot, ":local6", 5, 1),
    (party_set_slot, ":local6", 6, ":local0"),
(try_end),
    (try_for_range, ":local0", "trp_map_heroes_begin", "trp_map_heroes_end"),
    (troop_set_slot, ":local0", 2, 0),
(try_end),
]), 

#script_match_troop_to_horse
("match_troop_to_horse",[
(store_script_param_1, ":local0"),
(assign, "$mounted_troop", 0),
    (try_for_agents, "$agent"),
    (agent_is_alive, "$agent"),
    (agent_is_human, "$agent"),
    (agent_get_troop_id, ":local1", "$agent"),
    (eq, ":local1", ":local0"),
        (try_for_agents, ":local2"),
        (agent_is_alive, ":local2"),
        (agent_is_human|neg, ":local2"),
        (agent_get_position, 1, "$agent"),
        (agent_get_position, 2, ":local2"),
        (get_distance_between_positions, ":local3", 1, 2),
        (neg|ge, ":local3", 10),
        (assign, "$mounted_troop", 1),
    (try_end),
(try_end),
]), 

#script_match_agent_to_horse
("match_agent_to_horse",[
(store_script_param_1, ":local0"),
(assign, "$mounted_troop", 0),
    (try_for_agents, ":local1"),
    (agent_is_alive, ":local1"),
    (agent_is_human|neg, ":local1"),
    (agent_get_position, 1, ":local0"),
    (agent_get_position, 2, ":local1"),
    (get_distance_between_positions, ":local2", 1, 2),
    (neg|ge, ":local2", 10),
    (assign, "$mounted_troop", 1),
(try_end),
]), 

#script_formation_options
("formation_options",[
    (try_begin),
    (eq, "$formation_option_rotation", 0),
    (assign, "$formation_key", 1),
    (val_add, "$formation_option_rotation", 1),
    (display_message, "@<infantry_form_ranks>", 4284901119),
    (else_try),
    (eq, "$formation_option_rotation", 1),
    (assign, "$formation_key", 1),
    (val_add, "$formation_option_rotation", 1),
    (display_message, "@<infantry_form_line>", 4284901119),
    (else_try),
    (eq, "$formation_option_rotation", 2),
    (assign, "$formation_key", 1),
    (val_add, "$formation_option_rotation", 1),
    (display_message, "@<fall_back_to_baggage>", 4284901119),
    (else_try),
    (eq, "$formation_option_rotation", 3),
    (assign, "$formation_key", 1),
    (assign, "$formation_option_rotation", 0),
    (display_message, "@<break_formation>", 4284901119),
(try_end),
]), 

#script_formation_selected
("formation_selected",[
    (try_begin),
    (eq, "$formation_key", 1),
    (eq, "$formation_option_rotation", 1),
    (assign, "$formation_type", 1),
    (assign, "$formation_key", 0),
    (assign, "$formation_option_rotation", 0),
    (call_script, "script_load_melee_troops_for_formation", 0, 0),
    (call_script, "script_formation_start", 0, 0),
    (call_script, "script_match_troop_to_horse", "trp_player", 0),
    (display_message, "@Close_ranks!", 4281545574),
        (try_begin),
        (eq, "$mounted_troop", 1),
        (get_player_agent_no, "$agent"),
        (agent_set_animation, "$agent", 119),
        (else_try),
        (get_player_agent_no, "$agent"),
        (agent_set_animation, "$agent", 110),
    (try_end),
        (try_begin),
        (eq, "$character_race", 1),
        (neg|eq, "$character_gender", 1),
        (play_sound, "snd_order_form_ranks_man", 0),
        (else_try),
        (eq, "$character_race", 2),
        (neg|eq, "$character_gender", 1),
        (play_sound, "snd_order_form_ranks_elf", 0),
        (else_try),
        (eq, "$character_race", 3),
        (play_sound, "snd_order_form_ranks_orc", 0),
    (try_end),
    (else_try),
    (eq, "$formation_key", 1),
    (eq, "$formation_option_rotation", 2),
    (assign, "$formation_type", 2),
    (assign, "$formation_key", 0),
    (assign, "$formation_option_rotation", 0),
    (call_script, "script_load_melee_troops_for_formation", 0, 0),
    (call_script, "script_formation_start", 0, 0),
    (call_script, "script_match_troop_to_horse", "trp_player", 0),
    (display_message, "@Form_line!", 4281545574),
        (try_begin),
        (eq, "$mounted_troop", 1),
        (get_player_agent_no, "$agent"),
        (agent_set_animation, "$agent", 119),
        (else_try),
        (get_player_agent_no, "$agent"),
        (agent_set_animation, "$agent", 110),
    (try_end),
        (try_begin),
        (eq, "$character_race", 1),
        (neg|eq, "$character_gender", 1),
        (play_sound, "snd_order_form_line_man", 0),
        (else_try),
        (eq, "$character_race", 2),
        (neg|eq, "$character_gender", 1),
        (play_sound, "snd_order_form_line_elf", 0),
        (else_try),
        (eq, "$character_race", 3),
        (play_sound, "snd_order_form_line_orc", 0),
    (try_end),
    (else_try),
    (eq, "$formation_key", 1),
    (eq, "$formation_option_rotation", 3),
    (assign, "$formation_type", 2),
    (assign, "$formation_key", 0),
    (assign, "$formation_option_rotation", 0),
    (call_script, "script_formation_fall_back_start", 0, 0),
    (call_script, "script_match_troop_to_horse", "trp_player", 0),
    (display_message, "@Fall_Back!", 4281545574),
        (try_begin),
        (eq, "$mounted_troop", 1),
        (get_player_agent_no, "$agent"),
        (agent_set_animation, "$agent", 119),
        (else_try),
        (get_player_agent_no, "$agent"),
        (agent_set_animation, "$agent", 110),
    (try_end),
        (try_begin),
        (eq, "$character_race", 1),
        (eq, "$character_gender", 0),
        (play_sound, "snd_order_fall_back_man", 0),
        (else_try),
        (eq, "$character_race", 2),
        (eq, "$character_gender", 0),
        (play_sound, "snd_order_fall_back_elf", 0),
        (else_try),
        (eq, "$character_race", 3),
        (play_sound, "snd_order_fall_back_orc", 0),
    (try_end),
    (else_try),
    (eq, "$formation_key", 1),
    (eq, "$formation_option_rotation", 0),
    (assign, "$formation_type", 2),
    (assign, "$formation_key", 0),
    (assign, "$formation_option_rotation", 0),
    (call_script, "script_cancel_formation", 0, 0),
    (call_script, "script_match_troop_to_horse", "trp_player", 0),
    (display_message, "@Break_ranks!", 4281545574),
        (try_begin),
        (eq, "$mounted_troop", 1),
        (get_player_agent_no, "$agent"),
        (agent_set_animation, "$agent", 119),
        (else_try),
        (get_player_agent_no, "$agent"),
        (agent_set_animation, "$agent", 110),
    (try_end),
        (try_begin),
        (eq, "$character_race", 1),
        (eq, "$character_gender", 0),
        (play_sound, "snd_order_break_ranks_man", 0),
        (else_try),
        (eq, "$character_race", 2),
        (eq, "$character_gender", 0),
        (play_sound, "snd_order_break_ranks_elf", 0),
        (else_try),
        (eq, "$character_race", 3),
        (play_sound, "snd_order_break_ranks_orc", 0),
    (try_end),
    (else_try),
    (eq, "$formation_key", 0),
        (try_begin),
        (eq, "$battle_won", 1),
        (finish_mission),
        (else_try),
        (call_script, "script_check_enemies_nearby", 0, 0),
        (question_box, "@Are_you_sure_you_want_to_retreat?", 0, 0),
        (else_try),
        (display_message, "@Can't_retreat._There_are_enemies_nearby!", 0),
    (try_end),
(try_end),
]), 

#script_infiltration_mission_synch_agents_and_troops
("infiltration_mission_synch_agents_and_troops",[
    (try_for_range, ":local0", "fac_mission_companion_1", "fac_mission_companion_10"),
    (faction_set_slot, ":local0", 2, 0),
(try_end),
(get_player_agent_no, ":local1"),
(faction_set_slot, "fac_mission_companion_10", 2, ":local1"),
    (try_for_agents, "$agent"),
    (neg|eq, "$agent", ":local1"),
    (agent_is_ally, "$agent"),
    (agent_is_human, "$agent"),
    (agent_get_troop_id, ":local2", "$agent"),
        (try_for_range, ":local0", "fac_mission_companion_1", "fac_mission_companion_10"),
        (faction_get_slot, ":local3", ":local0", 1),
        (faction_get_slot, ":local4", ":local0", 2),
        (faction_get_slot, ":local5", ":local0", 4),
        (neg|eq, ":local5", 1),
        (eq, ":local4", 0),
        (eq, ":local3", ":local2"),
        (assign, ":local6", 0),
            (try_for_range, ":local7", "fac_mission_companion_1", "fac_mission_companion_10"),
            (faction_get_slot, ":local8", ":local7", 2),
            (eq, ":local8", "$agent"),
            (assign, ":local6", 1),
        (try_end),
        (eq, ":local6", 0),
        (faction_set_slot, ":local0", 2, "$agent"),
    (try_end),
(try_end),
]), 

#script_infiltration_mission_update_companion_casualties
("infiltration_mission_update_companion_casualties",[
(faction_get_slot, ":local0", "fac_mission_companion_10", 2),
(faction_get_slot, ":local1", "fac_mission_companion_10", 3),
(store_agent_hit_points, ":local2", ":local0", 0),
    (try_begin),
    (neg|ge, ":local2", ":local1"),
    (faction_set_slot, "fac_mission_companion_10", 3, ":local2"),
(try_end),
(get_player_agent_no, ":local3"),
    (try_for_agents, "$agent"),
    (agent_is_ally, "$agent"),
    (agent_is_human, "$agent"),
    (neg|eq, "$agent", ":local3"),
    (store_agent_hit_points, ":local2", "$agent", 0),
    (agent_get_troop_id, ":local4", "$agent"),
        (try_begin),
        (agent_is_alive|neg, "$agent"),
            (try_for_range, ":local5", "fac_mission_companion_1", "fac_mission_companion_10"),
            (faction_get_slot, ":local0", ":local5", 2),
            (faction_get_slot, ":local6", ":local5", 4),
            (neg|eq, ":local6", 1),
            (eq, ":local0", "$agent"),
            (faction_set_slot, ":local5", 3, ":local2"),
            (faction_set_slot, ":local5", 4, 1),
        (try_end),
        (else_try),
        (agent_is_alive, "$agent"),
            (try_for_range, ":local5", "fac_mission_companion_1", "fac_mission_companion_10"),
            (faction_get_slot, ":local0", ":local5", 2),
            (eq, ":local0", "$agent"),
            (faction_get_slot, ":local1", ":local5", 3),
            (neg|ge, ":local2", ":local1"),
            (faction_set_slot, ":local5", 3, ":local2"),
        (try_end),
    (try_end),
(try_end),
]), 

#script_infiltration_mission_set_hit_points
("infiltration_mission_set_hit_points",[
(get_player_agent_no, ":local0"),
    (try_for_range, ":local1", "fac_mission_companion_1", "fac_mission_companion_10"),
    (faction_get_slot, ":local2", ":local1", 2),
    (faction_get_slot, ":local3", ":local1", 4),
    (faction_get_slot, ":local4", ":local1", 3),
    (faction_get_slot, ":local5", ":local1", 1),
        (try_begin),
        (neg|eq, ":local2", ":local0"),
        (neg|eq, ":local5", 0),
        (neg|eq, ":local3", 1),
        (agent_set_hit_points, ":local2", ":local4", 0),
    (try_end),
    (faction_get_slot, ":local2", "fac_mission_companion_10", 2),
    (faction_get_slot, ":local4", "fac_mission_companion_10", 3),
    (agent_set_hit_points, ":local2", ":local4", 0),
]), 

#script_infiltration_mission_final_casualty_tabulation
("infiltration_mission_final_casualty_tabulation",[
(try_for_range, ":faction", "fac_mission_companion_1", "fac_mission_companion_11"),
    (faction_get_slot, ":troop", ":faction", 1),
    (faction_get_slot, ":local2", ":faction", 3),
    (faction_get_slot, ":local3", ":faction", 4),
    (try_begin),
        (troop_is_hero, ":troop"),
        (store_random_in_range, ":rnd", 20, 30),
        (try_begin),
            (eq, ":faction", "fac_mission_companion_10"),
            (neg|gt, ":rnd", ":local2"),
            (troop_set_health, ":troop", ":local2"),
          (else_try),
            (eq, ":faction", "fac_mission_companion_10"),
            (gt, ":rnd", ":local2"),
            (troop_set_health, ":troop", ":rnd"),
          (else_try),
            (neg|eq, ":troop", 0),
            (gt, ":rnd", ":local2"),
            (troop_set_health, ":troop", ":rnd"),
          (else_try),
            (neg|eq, ":troop", 0),
            (neg|gt, ":rnd", ":local2"),
            (troop_set_health, ":troop", ":local2"),
        (try_end),
      (else_try),
        (neg|troop_is_hero, ":troop"),
        (eq, ":local3", 1),
        (party_remove_members, "p_main_party", ":troop", 1),
    (try_end),
(try_end),
]), 

#script_infiltration_initialize_companion_records
("infiltration_initialize_companion_records",[
(try_for_range, ":faction", "fac_mission_companion_1", "fac_mission_companion_11"),
    (faction_set_slot, ":faction", 1, 0),
    (faction_set_slot, ":faction", 2, 0),
    (faction_set_slot, ":faction", 3, 0),
    (faction_set_slot, ":faction", 4, 0),
(try_end),
]), 

#script_wounded_hero_cap_mission_health
("wounded_hero_cap_mission_health",[
(get_player_agent_no, ":player"),
(assign, ":local1", 0),
(try_for_agents, ":agent"),
    (neg|eq, ":agent", ":player"),
    (agent_is_human, ":agent"),
    (agent_is_ally, ":agent"),
	(agent_get_troop_id, ":local2", ":agent"),
    (try_for_range, ":npc", companions_begin, companions_end),
        (eq, ":local2", ":npc"),
        (troop_get_slot, ":local4", ":npc", 1),
        (assign, ":local5", 100),
        (val_mul, ":local4", 10),
        (val_sub, ":local5", ":local4"),
        (store_agent_hit_points, ":local6", ":agent", 0),
        (neg|ge, ":local5", ":local6"),
        (agent_set_hit_points, ":agent", ":local5", 0),
        (assign, ":local1", 1),
    (try_end),
(try_end),
(try_begin),
    (eq, ":local1", 1),
    (display_message, "@Some_of_your_companions_are_suffering_from_old_wounds.", 4294901760),
(try_end),
]), 

#script_show_all_agents
("show_all_agents",[
(try_for_agents, ":agent"),
    (agent_get_troop_id, ":troop", ":agent"),
    (str_store_troop_name, s1, ":troop"),
    (assign, reg1, ":agent"),
    (display_message, "@Troop:{s1}_Agent:{reg1}", 0),
(try_end),
]), 

#script_display_dead_heroes
("display_dead_heroes",[
(try_for_range, ":troop", companions_begin, companions_end),
    (troop_get_slot, ":slot0", ":troop", 0),
    (eq, ":slot0", 5),
    (str_store_troop_name, s1, ":troop"),
    (display_message, "@{s1}_is_logged_as_dead", 0),
(try_end),
]), 

#script_infiltration_test_record
("infiltration_test_record",[
(try_for_range, ":faction", "fac_mission_companion_1", "fac_mission_companion_11"),
    (assign, reg5, ":faction"),
    (faction_get_slot, reg3, ":faction", 1),
    (faction_get_slot, reg2, ":faction", 2),
    (faction_get_slot, reg1, ":faction", 3),
    (faction_get_slot, reg4, ":faction", 4),
    (str_store_troop_name, s1, reg3),
    (display_message, "@Unit:{s1}_Rec:{reg5}_Agent:{reg2}_HP:{reg1}_KO:{reg4}", 0),
(try_end),
]), 

#script_sub_update_influence_count
("sub_update_influence_count",[
(store_script_param_1, ":local0"),
(val_sub, "$faction_influence", ":local0"),
(assign, reg1, "$faction_influence"),
(setup_quest_text, "qst_trait_influence"),
]), 

#script_update_influence_count
("update_influence_count",[
(store_script_param_1, ":local0"),
(val_add, "$faction_influence", ":local0"),
(assign, reg1, "$faction_influence"),
(setup_quest_text, "qst_trait_influence"),
]), 

("gain_trait_blessed",[
(check_quest_active|neg, "qst_trait_blessed"),
(setup_quest_text, "qst_trait_blessed"),
(start_quest, "qst_trait_blessed"),
(troop_raise_proficiency_linear, "trp_player", wpt_one_handed_weapon, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_two_handed_weapon, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_polearm, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_archery, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_throwing, 10),
(troop_raise_attribute, "trp_player", ca_strength, 1),
(troop_raise_attribute, "trp_player", ca_agility, 1),
(troop_raise_attribute, "trp_player", ca_charisma, 1),
]), 

#script_gain_trait_reverent
("gain_trait_reverent",[
(check_quest_active|neg, "qst_trait_reverent"),
(setup_quest_text, "qst_trait_reverent"),
(start_quest, "qst_trait_reverent"),
]), 

#script_gain_trait_merciful
("gain_trait_merciful",[
(check_quest_active|neg, "qst_trait_merciful"),
(setup_quest_text, "qst_trait_merciful"),
(start_quest, "qst_trait_merciful"),
]), 

#script_gain_trait_elf_friend
("gain_trait_elf_friend",[
(check_quest_active|neg, "qst_trait_elf_friend"),
(setup_quest_text, "qst_trait_elf_friend"),
(start_quest, "qst_trait_elf_friend"),
]), 

#script_gain_trait_kings_man
("gain_trait_kings_man",[
(check_quest_active|neg, "qst_trait_rohan_friend"),
(setup_quest_text, "qst_trait_rohan_friend"),
(start_quest, "qst_trait_rohan_friend"),
]), 

#script_gain_trait_stewarts_blessing
("gain_trait_stewarts_blessing",[
(check_quest_active|neg, "qst_trait_gondor_friend"),
(setup_quest_text, "qst_trait_gondor_friend"),
(start_quest, "qst_trait_gondor_friend"),
]), 

#script_gain_trait_brigand_friend
("gain_trait_brigand_friend",[
(check_quest_active|neg, "qst_trait_brigand_friend"),
(setup_quest_text, "qst_trait_brigand_friend"),
(start_quest, "qst_trait_brigand_friend"),
]), 

#script_gain_trait_oathkeeper
("gain_trait_oathkeeper",[
(check_quest_active|neg, "qst_trait_oathkeeper"),
(try_begin),
    (check_quest_active, "qst_trait_oathbreaker"),
    (cancel_quest, "qst_trait_oathbreaker"),
(try_end),
(setup_quest_text, "qst_trait_oathkeeper"),
(start_quest, "qst_trait_oathkeeper"),
]), 

#script_gain_trait_oathbreaker
("gain_trait_oathbreaker",[
(check_quest_active|neg, "qst_trait_oathbreaker"),
(try_begin),
    (check_quest_active, "qst_trait_oathkeeper"),
    (cancel_quest, "qst_trait_oathkeeper"),
(try_end),
(setup_quest_text, "qst_trait_oathbreaker"),
(start_quest, "qst_trait_oathbreaker"),
]), 

#script_gain_trait_orc_pit_champion
("gain_trait_orc_pit_champion",[
(check_quest_active|neg, "qst_trait_orc_pit_champion"),
(setup_quest_text, "qst_trait_orc_pit_champion"),
(start_quest, "qst_trait_orc_pit_champion"),
]), 

#script_gain_trait_despoiler
("gain_trait_despoiler",[
(check_quest_active|neg, "qst_trait_despoiler"),
(setup_quest_text, "qst_trait_despoiler"),
(start_quest, "qst_trait_despoiler"),
]), 

#script_gain_trait_accursed
("gain_trait_accursed",[
(check_quest_active|neg, "qst_trait_accursed"),
(setup_quest_text, "qst_trait_accursed"),
(start_quest, "qst_trait_accursed"),
]), 

#script_gain_trait_berserker
("gain_trait_berserker",[
(check_quest_active|neg, "qst_trait_berserker"),
(troop_raise_attribute, "trp_player", ca_strength, 2),
(setup_quest_text, "qst_trait_berserker"),
(start_quest, "qst_trait_berserker"),
]), 

#script_gain_trait_stealthy
("gain_trait_stealthy",[
(check_quest_active|neg, "qst_trait_stealthy"),
(setup_quest_text, "qst_trait_stealthy"),
(start_quest, "qst_trait_stealthy"),
]), 

#script_gain_trait_infantry_captain
("gain_trait_infantry_captain",[
(check_quest_active|neg, "qst_trait_infantry_captain"),
(setup_quest_text, "qst_trait_infantry_captain"),
(start_quest, "qst_trait_infantry_captain"),
]), 

#script_gain_trait_archer_captain
("gain_trait_archer_captain",[
(check_quest_active|neg, "qst_trait_archer_captain"),
(setup_quest_text, "qst_trait_archer_captain"),
(start_quest, "qst_trait_archer_captain"),
]), 

#script_gain_trait_cavalry_captain
("gain_trait_cavalry_captain",[
(check_quest_active|neg, "qst_trait_cavalry_captain"),
(setup_quest_text, "qst_trait_cavalry_captain"),
(start_quest, "qst_trait_cavalry_captain"),
]), 

#script_gain_trait_command_voice
("gain_trait_command_voice",[
(check_quest_active|neg, "qst_trait_command_voice"),
(neg|eq, "$character_race", 3),
(troop_raise_attribute, "trp_player", ca_charisma, 2),
(setup_quest_text, "qst_trait_command_voice"),
(start_quest, "qst_trait_command_voice"),
]), 

#script_gain_trait_battle_scarred
("gain_trait_battle_scarred",[
(check_quest_active|neg, "qst_trait_battle_scarred"),
(neg|eq, "$character_race", 2),
(setup_quest_text, "qst_trait_battle_scarred"),
(start_quest, "qst_trait_battle_scarred"),
(troop_raise_attribute, "trp_player", ca_charisma, -1),
(store_skill_level, ":local0", skl_ironflesh, "trp_player"),
(neg|ge, ":local0", 10),
(troop_raise_skill, "trp_player", skl_ironflesh, 1),

]), 

#script_gain_trait_fell_beast
("gain_trait_fell_beast",[
(check_quest_active|neg, "qst_trait_fell_beast"),
(eq, "$character_race", 3),
(troop_raise_attribute, "trp_player", ca_strength, 5),
(troop_raise_attribute, "trp_player", ca_charisma, -2),
(store_skill_level, ":skill", skl_ironflesh, "trp_player"),
(try_begin),
    (neg|ge, ":skill", 9),
    (troop_raise_skill, "trp_player", skl_ironflesh, 2),
 (else_try),
    (neg|ge, ":skill", 10),
    (troop_raise_skill, "trp_player", skl_ironflesh, 1),
(try_end),
(troop_raise_proficiency_linear, "trp_player", wpt_one_handed_weapon, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_two_handed_weapon, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_polearm, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_archery, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_throwing, 10),
(setup_quest_text, "qst_trait_fell_beast"),
(start_quest, "qst_trait_fell_beast"),
]), 

#script_gain_trait_foe_hammer
("gain_trait_foe_hammer",[
(check_quest_active|neg, "qst_trait_foe_hammer"),
(store_skill_level, ":skill", skl_tactics, "trp_player"),
(neg|ge, ":skill", 10),
(troop_raise_skill, "trp_player", skl_tactics, 1),
(troop_raise_proficiency_linear, "trp_player", wpt_one_handed_weapon, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_two_handed_weapon, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_polearm, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_archery, 10),
(troop_raise_proficiency_linear, "trp_player", wpt_throwing, 10),
(setup_quest_text, "qst_trait_foe_hammer"),
(start_quest, "qst_trait_foe_hammer"),
]), 

#script_check_trait_captain
("check_trait_captain",[
(check_quest_active|neg, "qst_trait_archer_captain"),
(check_quest_active|neg, "qst_trait_infantry_captain"),
(check_quest_active|neg, "qst_trait_cavalry_captain"),
(party_get_num_companion_stacks, ":numstacks", "p_main_party"),
(assign, ":inf_count", 0),
(assign, ":arc_count", 0),
(assign, ":cav_count", 0),
(try_for_range, ":stack", 0, ":numstacks"),
    (party_stack_get_troop_id, ":troop", "p_main_party", ":stack"),
    (troop_get_slot, ":troop_type", ":troop", 6),
    (try_begin),
        (eq, ":troop_type", 1),
        (val_add, ":inf_count", 1),
      (else_try),
        (eq, ":troop_type", 2),
        (val_add, ":arc_count", 1),
      (else_try),
        (eq, ":troop_type", 3),
        (val_add, ":cav_count", 1),
    (try_end),
(try_end),
(try_begin),
    (gt, ":inf_count", ":arc_count"), 
    (gt, ":inf_count", ":cav_count"), 
    (val_add, "$trait_captain_infantry_week", 1),
  (else_try),
    (gt, ":arc_count", ":inf_count"), 
    (gt, ":arc_count", ":cav_count"), 
    (val_add, "$trait_captain_archer_week", 1),
  (else_try),
    (gt, ":cav_count", ":arc_count"), 
    (gt, ":cav_count", ":inf_count"), 
    (val_add, "$trait_captain_cavalry_week", 1),
(try_end),
(store_skill_level, ":local7", 1, 0),
(ge, ":local7", 6),
(try_begin),
    (gt, "$trait_captain_infantry_week", "$trait_captain_archer_week"),
    (gt, "$trait_captain_infantry_week", "$trait_captain_cavalry_week"),
    (assign, ":accumulated_captain", "$trait_captain_infantry_week"),
    (val_mul, ":accumulated_captain", 10),
    (store_random,":rnd", 100),
    (neg|ge, ":rnd", ":accumulated_captain"),
    (call_script, "script_gain_trait_infantry_captain"),
  (else_try),
    (gt, "$trait_captain_archer_week", "$trait_captain_infantry_week"),
    (gt, "$trait_captain_archer_week", "$trait_captain_cavalry_week"),
    (assign, ":accumulated_captain", "$trait_captain_archer_week"),
    (val_mul, ":accumulated_captain", 10),
    (store_random,":rnd", 100),
    (neg|ge, ":rnd", ":accumulated_captain"),
    (call_script, "script_gain_trait_archer_captain"),
  (else_try),
    (gt, "$trait_captain_cavalry_week", "$trait_captain_archer_week"),
    (gt, "$trait_captain_cavalry_week", "$trait_captain_infantry_week"),
    (assign, ":accumulated_captain", "$trait_captain_cavalry_week"),
    (val_mul, ":accumulated_captain", 10),
    (store_random,":rnd", 100),
    (neg|ge, ":rnd", ":accumulated_captain"),
    (call_script, "script_gain_trait_cavalry_captain"),
(try_end),
]), 

#script_rohirrim_ride_east
("rohirrim_ride_east",[
(try_begin),
    (this_or_next|eq, "$rohirrim_ride_east", 1),
    (eq, "$rohirrim_ride_east", 2),
    (assign, ":local0", 0),
    (try_for_parties, ":party"),
        (party_get_template_id, ":local2", ":party"),
        (this_or_next|eq, ":local2", "pt_rohan_patrol"),
        (this_or_next|eq, ":local2", "pt_small_host_of_rohan"),
        (eq, ":local2", "pt_host_of_rohan"),
        (store_distance_to_party_from_party, ":dist", ":party", "$edoras"),
        (neg|eq, ":dist", 0),
        (party_set_ai_behavior, ":party", 1),
        (party_set_ai_object, ":party", "$edoras"),
        (val_add, ":local0", 1),
    (try_end),
    (eq, ":local0", 4),
    (assign, "$rohirrim_ride_east", 2),
(try_end),
(try_begin),
    (eq, "$rohirrim_ride_east", 2),
    (assign, ":local4", 0),
    (try_for_parties, ":party"),
        (party_get_template_id, ":local2", ":party"),
        (this_or_next|eq, ":local2", "pt_rohan_patrol"),
        (this_or_next|eq, ":local2", "pt_small_host_of_rohan"),
        (eq, ":local2", "pt_host_of_rohan"),
        (store_distance_to_party_from_party, ":dist", ":party", "$edoras"),
        (eq, ":dist", 0),
        (val_add, ":local4", 1),
    (try_end),
    (eq, ":local4", 4),
    (assign, "$rohirrim_ride_east", 3),
(else_try),
    (eq, "$rohirrim_ride_east", 3),
    (set_spawn_radius, 1),
    (spawn_around_party, "$edoras", "pt_eohere_of_the_riddermark"),
    (assign, "$eohere_party_id", reg0),
    (try_for_parties, ":party"),
        (party_get_template_id, ":local2", ":party"),
        (this_or_next|eq, ":local2", "pt_rohan_patrol"),
        (this_or_next|eq, ":local2", "pt_small_host_of_rohan"),
        (eq, ":local2", "pt_host_of_rohan"),
        (call_script, "script_party_add_party_companions", "$eohere_party_id", ":party"),
        (remove_party, ":party"),
        (assign, "$host_of_rohan_active", 0),
        (assign, "$host_of_rohan_order_tracking", 0),
    (try_end),
    (store_party_size_wo_prisoners, ":local5", "$eohere_party_id"),
    (try_begin),
        (neg|ge, ":local5", 200),
        (assign, ":local6", 200),
        (val_sub, ":local6", ":local5"),
        (party_add_members, "$eohere_party_id", "trp_rider_of_rohan", ":local6"),
        (else_try),
        (ge, ":local5", 200),
    (try_end),
    (party_get_num_companion_stacks, ":local7", "$eohere_party_id"),
    (try_for_range, ":local8", 0, ":local7"),
        (party_stack_get_troop_id, ":local9", "$eohere_party_id", ":local8"),
        (eq, ":local9", "trp_lieutenant_of_rohan"),
        (party_count_companions_of_type, ":local10", "$eohere_party_id", ":local9"),
        (party_remove_members, "$eohere_party_id", ":local9", ":local10"),
        (party_add_leader, "$eohere_party_id", ":local9", ":local10"),
        (troop_set_slot, ":local9", 0, 2),
        (troop_set_slot, ":local9", 1, "$eohere_party_id"),
    (try_end),
    (try_for_range, ":local8", 0, ":local7"),
        (party_stack_get_troop_id, ":local9", "$eohere_party_id", ":local8"),
        (eq, ":local9", "trp_captain_of_rohan"),
        (party_count_companions_of_type, ":local10", "$eohere_party_id", ":local9"),
        (party_remove_members, "$eohere_party_id", ":local9", ":local10"),
        (party_add_leader, "$eohere_party_id", ":local9", ":local10"),
        (troop_set_slot, ":local9", 0, 2),
        (troop_set_slot, ":local9", 1, "$eohere_party_id"),
    (try_end),
    (try_for_range, ":local8", 0, ":local7"),
        (party_stack_get_troop_id, ":local9", "$eohere_party_id", ":local8"),
        (eq, ":local9", "trp_high_captain_of_rohan"),
        (party_count_companions_of_type, ":local10", "$eohere_party_id", ":local9"),
        (party_remove_members, "$eohere_party_id", ":local9", ":local10"),
        (party_add_leader, "$eohere_party_id", ":local9", ":local10"),
        (troop_set_slot, ":local9", 0, 2),
        (troop_set_slot, ":local9", 1, "$eohere_party_id"),
    (try_end),
    (try_for_range, ":local8", 0, ":local7"),
        (party_stack_get_troop_id, ":local9", "$eohere_party_id", ":local8"),
        (is_between, ":local9", "trp_map_heroes_begin", "trp_map_heroes_end"),
        (party_remove_members, "$eohere_party_id", ":local9", 1),
        (assign, ":local11", ":local9"),
    (try_end),
    (party_add_leader, "$eohere_party_id", "trp_king_s_man_of_rohan", 10),
    (party_add_leader, "$eohere_party_id", "trp_map_eowyn", 1),
    (assign, "$eowyn_joined", 1),
    (troop_set_slot, "trp_map_eowyn", 0, 2),
    (troop_set_slot, "trp_map_eowyn", 1, "$eohere_party_id"),
    (remove_troop_from_site, "trp_eowyn", "scn_town_11_castle"),
    (party_add_leader, "$eohere_party_id", "trp_map_deorwine", 1),
    (assign, "$deorwine_joined", 1),
    (troop_set_slot, "trp_map_deorwine", 0, 2),
    (troop_set_slot, "trp_map_deorwine", 1, "$eohere_party_id"),
    (remove_troop_from_site, "trp_deorwine", "scn_town_11_castle"),
    (party_add_leader, "$eohere_party_id", "trp_map_guthlaf", 1),
    (assign, "$guthlaf_joined", 1),
    (troop_set_slot, "trp_map_guthlaf", 0, 2),
    (troop_set_slot, "trp_map_guthlaf", 1, "$eohere_party_id"),
    (remove_troop_from_site, "trp_guthlaf", "scn_town_11_castle"),
    (party_add_leader, "$eohere_party_id", "trp_map_hama", 1),
    (assign, "$hama_joined", 1),
    (troop_set_slot, "trp_map_hama", 0, 2),
    (troop_set_slot, "trp_map_hama", 1, "$eohere_party_id"),
    (remove_troop_from_site, "trp_hama", "scn_town_11_castle"),
    (try_begin),
        (neg|eq, ":local11", 0),
        (party_add_leader, "$eohere_party_id", ":local11", 1),
        (troop_set_slot, ":local11", 0, 2),
        (troop_set_slot, ":local11", 1, "$eohere_party_id"),
    (try_end),
    (try_begin),
        (troop_get_slot, ":local12", "trp_map_lord_dunhere", 0),
        (eq, ":local12", 0),
        (party_add_leader, "$eohere_party_id", "trp_map_lord_dunhere", 1),
        (assign, "$dunhere_joined", 1),
        (troop_set_slot, "trp_map_lord_dunhere", 0, 2),
        (troop_set_slot, "trp_map_lord_dunhere", 1, "$eohere_party_id"),
        (remove_troop_from_site, "trp_lord_dunhere", "scn_town_11_castle"),
    (try_end),
    (try_begin),
        (troop_get_slot, ":local12", "trp_map_lord_elfhelm", 0),
        (eq, ":local12", 0),
        (party_add_leader, "$eohere_party_id", "trp_map_lord_elfhelm", 1),
        (assign, "$elfhelm_joined", 1),
        (troop_set_slot, "trp_map_lord_elfhelm", 0, 2),
        (troop_set_slot, "trp_map_lord_elfhelm", 1, "$eohere_party_id"),
        (remove_troop_from_site, "trp_lord_elfhelm", "scn_town_11_castle"),
    (try_end),
    (try_begin),
        (troop_get_slot, ":local12", "trp_map_lord_eomer", 0),
        (eq, ":local12", 0),
        (party_add_leader, "$eohere_party_id", "trp_map_lord_eomer", 1),
        (assign, "$eomer_joined", 1),
        (troop_set_slot, "trp_map_lord_eomer", 0, 2),
        (troop_set_slot, "trp_map_lord_eomer", 1, "$eohere_party_id"),
    (try_end),
    (party_add_leader, "$eohere_party_id", "trp_map_king_theoden", 1),
    (assign, "$theoden_joined", 1),
    (troop_set_slot, "trp_map_king_theoden", 0, 2),
    (troop_set_slot, "trp_map_king_theoden", 1, "$eohere_party_id"),
    (remove_troop_from_site, "trp_king_theoden", "scn_town_11_castle"),
    (try_for_range, ":local13", "qst_generic_deliver_message", "qst_gov_quests_end"),
        (check_quest_active, ":local13", 1),
        (quest_get_slot, ":local14", ":local13", 0),
        (eq, ":local14", "trp_king_theoden"),
        (cancel_quest, ":local13"),
        (str_store_troop_name, 1, "trp_king_theoden"),
        (display_message, "@{s1}_has_taken_to_the_field_and_recinded_your_orders.", 4284901119),
    (try_end),
    (party_set_ai_behavior, "$eohere_party_id", 1),
    (party_set_ai_object, "$eohere_party_id", "$minas_tirith"),
    (party_set_slot, "$eohere_party_id", 3, "$minas_tirith"),
    (assign, "$rohirrim_ride_east", 4),
(try_end),
]), 

#script_set_recruited_lord_gear
("set_recruited_lord_gear",[
(store_script_param_1, ":local0"),
    (try_begin),
    (eq, ":local0", "trp_elladan"),
    (troop_add_items, ":local0", "itm_rivendell_warhorse", 1),
    (troop_add_items, ":local0", "itm_elven_coif", 1),
    (else_try),
    (eq, ":local0", "trp_elrohir"),
    (troop_add_items, ":local0", "itm_rivendell_warhorse", 1),
    (troop_add_items, ":local0", "itm_elven_coif", 1),
    (else_try),
    (eq, ":local0", "trp_lord_grimbold"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_rohirrim_captain_helm", 1),
    (troop_add_items, ":local0", "itm_rohirrim_hunter", 1),
    (troop_add_items, ":local0", "itm_rohirrim_noble_small_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_erkenbrand"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_rohirrim_captain_helm", 1),
    (troop_add_items, ":local0", "itm_thengel_guard_warhorse", 1),
    (troop_add_items, ":local0", "itm_thengel_guard_buckler", 1),
    (else_try),
    (eq, ":local0", "trp_lord_freca"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_rohirrim_captain_helm", 1),
    (troop_add_items, ":local0", "itm_rohirrim_hunter", 1),
    (troop_add_items, ":local0", "itm_rohirrim_noble_small_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_eowine"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_rohirrim_captain_helm", 1),
    (troop_add_items, ":local0", "itm_rohirrim_hunter", 1),
    (troop_add_items, ":local0", "itm_rohirrim_plated_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_deorhelm"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_rohirrim_captain_helm", 1),
    (troop_add_items, ":local0", "itm_rohirrim_hunter", 1),
    (troop_add_items, ":local0", "itm_rohirrim_noble_small_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_fastred"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_rohirrim_captain_helm", 1),
    (troop_add_items, ":local0", "itm_rohirrim_hunter", 1),
    (troop_add_items, ":local0", "itm_rohirrim_plated_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_malvogil"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_gondor_infantry_helm", 1),
    (troop_add_items, ":local0", "itm_gondor_hunter", 1),
    (troop_add_items, ":local0", "itm_gondorian_ornate_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_halbarad"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_gondor_infantry_helm", 1),
    (troop_add_items, ":local0", "itm_gondor_hunter", 1),
    (troop_add_items, ":local0", "itm_gondorian_small_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_imrahil"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_swan_knight_helm", 1),
    (troop_add_items, ":local0", "itm_dol_amroth_warhorse", 1),
    (troop_add_items, ":local0", "itm_dol_amroth_kite_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_orthalion"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_tower_guard_helm_", 1),
    (troop_add_items, ":local0", "itm_gondor_hunter", 1),
    (troop_add_items, ":local0", "itm_gondorian_ornate_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_aravir"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_gondor_infantry_helm", 1),
    (troop_add_items, ":local0", "itm_gondor_hunter", 1),
    (troop_add_items, ":local0", "itm_gondorian_ornate_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_hirluin"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_gondorian_light_helm_b", 1),
    (troop_add_items, ":local0", "itm_light_warhorse", 1),
    (troop_add_items, ":local0", "itm_gondorian_small_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_dirhael"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_gondorian_archer_helm", 1),
    (troop_add_items, ":local0", "itm_gondor_hunter", 1),
    (troop_add_items, ":local0", "itm_gondorian_ornate_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_faramir"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_gondorian_archer_helm", 1),
    (troop_add_items, ":local0", "itm_gondor_hunter", 1),
    (troop_add_items, ":local0", "itm_gondorian_small_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_hallas"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_gondor_infantry_helm", 1),
    (troop_add_items, ":local0", "itm_gondor_hunter", 1),
    (troop_add_items, ":local0", "itm_gondorian_ornate_shield", 1),
    (else_try),
    (eq, ":local0", "trp_lord_forlong"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_gondorian_light_helm_b", 1),
    (troop_add_items, ":local0", "itm_light_warhorse", 1),
    (troop_add_items, ":local0", "itm_lossarnach_small_shield", 1),
    (else_try),
    (eq, ":local0", "trp_warden_of_the_vale"),
    (troop_add_items, ":local0", "itm_iron_greaves", 1),
    (troop_add_items, ":local0", "itm_black_numenorian_horned_helm", 0),
    (troop_add_items, ":local0", "itm_mordor_warhorse", 1),
    (troop_add_items, ":local0", "itm_black_numenorian_small_shield", 1),
    (else_try),
    (eq, ":local0", "trp_captain_mortakh"),
    (troop_add_items, ":local0", "itm_black_numenorian_horned_helm", 0),
    (troop_add_items, ":local0", "itm_desert_mare", 1),
    (troop_add_items, ":local0", "itm_round_dragon_shield", 0),
    (else_try),
    (eq, ":local0", "trp_khamul"),
    (troop_add_items, ":local0", "itm_variag_kataphrakt", 1),
    (else_try),
    (eq, ":local0", "trp_varoujan"),
    (troop_add_items, ":local0", "itm_hunter", 1),
    (else_try),
    (eq, ":local0", "trp_ul_ulcari"),
    (troop_add_items, ":local0", "itm_desert_mare", 1),
    (else_try),
    (eq, ":local0", "trp_captain_tulmir"),
    (troop_add_items, ":local0", "itm_desert_mare", 1),
    (else_try),
    (eq, ":local0", "trp_duessa"),
    (troop_add_items, ":local0", "itm_desert_mare", 1),
    (else_try),
    (eq, ":local0", "trp_daeglaf_the_black"),
    (troop_add_items, ":local0", "itm_small_dunlending_shield", 0),
    (troop_add_items, ":local0", "itm_hunter", 1),
(try_end),
]), 

#script_battle_health_management
("battle_health_management",[
(try_for_agents, ":agent"), # berserkers heal
    (agent_is_alive, ":agent"),
    (agent_get_troop_id, ":troop", ":agent"),
    (this_or_next|eq, ":troop", "trp_dunnish_wolf_warrior"),
    (this_or_next|eq, ":troop", "trp_dunnish_berserker"),
    (this_or_next|eq, ":troop", "trp_fighting_uruk_hai_berserker"),
    (this_or_next|eq, ":troop", "trp_variag_pitfighter"),
                 (eq, ":troop", "trp_variag_gladiator"),
    (store_agent_hit_points, ":hp", ":agent", 0),
    (neg|ge, ":hp", 50),
    (val_mul, ":hp", 10),
    (val_div, ":hp", 8),
    (agent_set_hit_points, ":agent", ":hp", 0),
    (assign, reg1, ":hp"),
    (str_store_troop_name, 1, ":troop"),
(try_end),
(try_begin), # player heal when berserker or has torque
    (get_player_agent_no, ":player"),
    (player_has_item|this_or_next, "itm_dunlending_torque"),
    (check_quest_active, "qst_trait_berserker", 1),
    (store_agent_hit_points, ":hp", ":player", 0),
    (neg|ge, ":hp", 50),
    (val_mul, ":hp", 10),
    (val_div, ":hp", 8),
    (agent_set_hit_points, ":player", ":hp", 0),
(try_end),
(try_begin), # heal classes acc to captainship
    (this_or_next|check_quest_active, "qst_trait_archer_captain", 1),
    (this_or_next|check_quest_active, "qst_trait_infantry_captain", 1),
                 (check_quest_active, "qst_trait_cavalry_captain", 1),
    (get_player_agent_no, ":player"),
    (try_for_agents, ":agent"),
        (agent_is_ally, ":agent"),
        (agent_is_alive, ":agent"),
        (neg|eq, ":agent", ":player"),
        (agent_get_class, ":class", ":agent"),
        (assign, ":local6", 0),
        (try_begin),
            (check_quest_active, "qst_trait_infantry_captain", 1),
            (eq, ":class", grc_infantry),
            (assign, ":local6", 1),
         (else_try),
            (check_quest_active, "qst_trait_archer_captain", 1),
            (eq, ":class", grc_archers),
            (assign, ":local6", 1),
		 (else_try),
            (check_quest_active, "qst_trait_cavalry_captain", 1),
            (eq, ":class", grc_cavalry),
            (assign, ":local6", 1),
        (try_end),
        (eq, ":local6", 1),
        (agent_slot_eq, ":agent", 6, 0),
        (store_agent_hit_points, ":hp", ":agent", 0),
        (neg|ge, ":hp", 100),
        (val_mul, ":hp", 10),
        (val_div, ":hp", 8),
        (agent_set_hit_points, ":agent", ":hp", 0),
        (agent_set_slot, ":agent", 6, 1),
    (try_end),
(try_end),
]), 

#script_map_hero_status_in_abstract_battle
("map_hero_status_in_abstract_battle",[
(try_begin),
    (party_get_num_companion_stacks, ":numstacks", "p_temp_casualties"),
    (try_for_range, ":stack", 0, ":numstacks"),
        (party_stack_get_troop_id, ":local3", "p_temp_casualties", ":stack"),
        (is_between, ":local3", "trp_map_heroes_begin", "trp_map_heroes_end"),
        (party_stack_get_num_wounded, ":local4", "p_temp_casualties", ":stack"),
        (eq, ":local4", 0),
        (call_script, "script_hero_leader_killed_abstractly", ":local3", 0),
    (try_end),
(try_end),
]), 

#script_troop_daylight_modifications
("troop_daylight_modifications",[
   (try_begin),
    (eq, "$night_missile_penalty_active", 1),
        (try_for_range, reg1, "trp_warrior_of_pinnath_gelin", "trp_dol_amroth_youth"),
        (troop_raise_proficiency_linear, reg1, 3, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 4, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 5, "$night_missile_penalty"),
    (try_end),
        (try_for_range, reg1, "trp_lothlorien_scout", "trp_gondor_youth"),
        (troop_raise_proficiency_linear, reg1, 3, "$elf_night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 4, "$elf_night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 5, "$elf_night_missile_penalty"),
    (try_end),
        (try_for_range, reg1, "trp_archer_of_gondor", "trp_rohan_youth"),
        (troop_raise_proficiency_linear, reg1, 3, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 4, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 5, "$night_missile_penalty"),
    (try_end),
        (try_for_range, reg1, "trp_harad_archer", "trp_dunnish_youth"),
        (troop_raise_proficiency_linear, reg1, 3, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 4, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 5, "$night_missile_penalty"),
    (try_end),
        (try_for_range, reg1, "trp_easterling_hurler", "trp_pikeman_of_umbar"),
        (troop_raise_proficiency_linear, reg1, 3, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 4, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 5, "$night_missile_penalty"),
    (try_end),
        (try_for_range, reg1, "trp_orc_snaga_of_mordor", "trp_uruk_slayer_of_mordor"),
        (troop_raise_proficiency_linear, reg1, 3, "$elf_night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 4, "$elf_night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 5, "$elf_night_missile_penalty"),
    (try_end),
    (assign, "$night_missile_penalty_active", 0),
(try_end),
    (try_begin),
    (eq, "$orc_daylight_penalty_active", 0),
        (try_for_range, reg1, "trp_orc_snaga_of_isengard", "trp_uruk_snaga_of_mordor"),
        (assign, reg2, -1),
        (val_mul, reg2, "$sunlight_penalty"),
        (troop_raise_proficiency_linear, reg1, 0, reg2),
        (troop_raise_proficiency_linear, reg1, 1, reg2),
        (troop_raise_proficiency_linear, reg1, 2, reg2),
        (troop_raise_proficiency_linear, reg1, 3, reg2),
        (troop_raise_proficiency_linear, reg1, 4, reg2),
        (troop_raise_proficiency_linear, reg1, 5, reg2),
        (troop_raise_attribute, reg1, 1, -2),
        (troop_raise_attribute, reg1, 0, -2),
    (try_end),
        (try_begin),
        (eq, "$character_gender", 2),
        (troop_raise_proficiency_linear, 0, 0, reg2),
        (troop_raise_proficiency_linear, 0, 1, reg2),
        (troop_raise_proficiency_linear, 0, 2, reg2),
        (troop_raise_proficiency_linear, 0, 3, reg2),
        (troop_raise_proficiency_linear, 0, 4, reg2),
        (troop_raise_proficiency_linear, 0, 5, reg2),
        (display_message, "@The_daylight_weakens_you.", 0),
    (try_end),
        (try_for_range, ":local0", "trp_uruk_snaga_of_mordor", "trp_cave_troll"),
        (store_skill_level, ":local1", 13, ":local0"),
        (neg|eq, ":local1", 0),
        (val_mul, ":local1", -1),
        (troop_raise_skill, ":local0", 13, ":local1"),
    (try_end),
        (try_for_range, ":local2", "trp_orc_snaga_of_isengard", "trp_uruk_snaga_of_mordor"),
        (neg|eq, reg1, "trp_wolf_rider_of_isengard"),
        (neg|eq, reg1, "trp_warg_rider_of_isengard"),
        (neg|eq, reg1, "trp_white_hand_rider"),
        (neg|eq, reg1, "trp_warg_rider_of_gorgoroth"),
        (neg|eq, reg1, "trp_great_warg_rider_of_mordor"),
        (neg|eq, reg1, "trp_wolf_rider_of_moria"),
        (neg|eq, reg1, "trp_warg_rider_of_moria"),
        (neg|eq, reg1, "trp_bolg_clan_rider"),
        (store_skill_level, ":local1", 13, ":local2"),
        (neg|eq, ":local1", 0),
        (val_mul, ":local1", -1),
        (troop_raise_skill, ":local2", 13, ":local1"),
    (try_end),
        (try_for_parties, ":local3"),
        (party_get_template_id, ":local4", ":local3"),
        (this_or_next|eq, ":local4", "pt_mordor_scouts"),
        (this_or_next|eq, ":local4", "pt_mordor_patrol"),
        (this_or_next|eq, ":local4", "pt_small_host_of_mordor"),
        (this_or_next|eq, ":local4", "pt_host_of_mordor"),
        (this_or_next|eq, ":local4", "pt_host_of_udun"),
        (this_or_next|eq, ":local4", "pt_host_of_gorgoroth"),
        (this_or_next|eq, ":local4", "pt_host_of_minas_morgul"),
        (this_or_next|eq, ":local4", "pt_host_of_barad_dur"),
        (this_or_next|eq, ":local4", "pt_mordor_prisoner_train"),
        (this_or_next|eq, ":local4", "pt_mordor_caravan"),
        (this_or_next|eq, ":local4", "pt_moria_scouts"),
        (this_or_next|eq, ":local4", "pt_moria_patrol"),
        (this_or_next|eq, ":local4", "pt_small_host_of_moria"),
        (this_or_next|eq, ":local4", "pt_dol_guldur_scouts"),
        (this_or_next|eq, ":local4", "pt_dol_guldur_patrol"),
        (this_or_next|eq, ":local4", "pt_small_host_of_dol_guldur"),
        (this_or_next|eq, ":local4", "pt_host_of_dol_guldur"),
        (this_or_next|eq, ":local4", "pt_isengard_scouts"),
        (this_or_next|eq, ":local4", "pt_isengard_patrol"),
        (this_or_next|eq, ":local4", "pt_small_host_of_isengard"),
        (this_or_next|eq, ":local4", "pt_host_of_isengard"),
        (this_or_next|eq, ":local4", "pt_isengard_prisoner_train"),
        (this_or_next|eq, ":local4", "pt_isengard_caravan"),
        (this_or_next|eq, ":local4", "pt_tribal_orcs"),
        (this_or_next|eq, ":local4", "pt_tribal_orc_stragglers"),
        (this_or_next|eq, ":local4", "pt_goblin_stragglers"),
        (eq, ":local4", "pt_goblin_raiders"),
        (party_set_morale, ":local3", 20),
    (try_end),
    (assign, "$orc_daylight_penalty_active", 1),
(try_end),
]), 

#script_troop_night_modifications
("troop_night_modifications",[
    (try_begin),
    (eq, "$night_missile_penalty_active", 0),
        (try_for_range, reg1, "trp_warrior_of_pinnath_gelin", "trp_dol_amroth_youth"),
        (assign, reg2, -1),
        (val_mul, reg2, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 3, reg2),
        (troop_raise_proficiency_linear, reg1, 4, reg2),
        (troop_raise_proficiency_linear, reg1, 5, reg2),
    (try_end),
        (try_for_range, reg1, "trp_lothlorien_scout", "trp_gondor_youth"),
        (assign, reg2, -1),
        (val_mul, reg2, "$elf_night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 3, reg2),
        (troop_raise_proficiency_linear, reg1, 4, reg2),
        (troop_raise_proficiency_linear, reg1, 5, reg2),
    (try_end),
        (try_for_range, reg1, "trp_archer_of_gondor", "trp_rohan_youth"),
        (assign, reg2, -1),
        (val_mul, reg2, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 3, reg2),
        (troop_raise_proficiency_linear, reg1, 4, reg2),
        (troop_raise_proficiency_linear, reg1, 5, reg2),
    (try_end),
        (try_for_range, reg1, "trp_harad_archer", "trp_dunnish_youth"),
        (assign, reg2, -1),
        (val_mul, reg2, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 3, reg2),
        (troop_raise_proficiency_linear, reg1, 4, reg2),
        (troop_raise_proficiency_linear, reg1, 5, reg2),
    (try_end),
        (try_for_range, reg1, "trp_easterling_hurler", "trp_pikeman_of_umbar"),
        (assign, reg2, -1),
        (val_mul, reg2, "$night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 3, reg2),
        (troop_raise_proficiency_linear, reg1, 4, reg2),
        (troop_raise_proficiency_linear, reg1, 5, reg2),
    (try_end),
        (try_for_range, reg1, "trp_orc_snaga_of_mordor", "trp_uruk_slayer_of_mordor"),
        (assign, reg2, -1),
        (val_mul, reg2, "$elf_night_missile_penalty"),
        (troop_raise_proficiency_linear, reg1, 3, reg2),
        (troop_raise_proficiency_linear, reg1, 4, reg2),
        (troop_raise_proficiency_linear, reg1, 5, reg2),
    (try_end),
    (assign, "$night_missile_penalty_active", 1),
(try_end),
    (try_begin),
    (eq, "$orc_daylight_penalty_active", 1),
        (try_for_range, reg1, "trp_orc_snaga_of_isengard", "trp_uruk_snaga_of_mordor"),
        (troop_raise_proficiency_linear, reg1, 0, "$sunlight_penalty"),
        (troop_raise_proficiency_linear, reg1, 1, "$sunlight_penalty"),
        (troop_raise_proficiency_linear, reg1, 2, "$sunlight_penalty"),
        (troop_raise_proficiency_linear, reg1, 3, "$sunlight_penalty"),
        (troop_raise_proficiency_linear, reg1, 4, "$sunlight_penalty"),
        (troop_raise_proficiency_linear, reg1, 5, "$sunlight_penalty"),
        (troop_raise_attribute, reg1, 1, 2),
        (troop_raise_attribute, reg1, 0, 2),
    (try_end),
        (try_begin),
        (eq, "$character_gender", 2),
        (troop_raise_proficiency_linear, 0, 0, "$sunlight_penalty"),
        (troop_raise_proficiency_linear, 0, 1, "$sunlight_penalty"),
        (troop_raise_proficiency_linear, 0, 2, "$sunlight_penalty"),
        (troop_raise_proficiency_linear, 0, 3, "$sunlight_penalty"),
        (troop_raise_proficiency_linear, 0, 4, "$sunlight_penalty"),
        (troop_raise_proficiency_linear, 0, 5, "$sunlight_penalty"),
        (display_message, "@The_coming_of_night_strengthens_you.", 0),
    (try_end),
        (try_for_range, ":local0", "trp_uruk_snaga_of_mordor", "trp_cave_troll"),
        (troop_raise_skill, ":local0", 13, 3),
    (try_end),
        (try_for_range, ":local0", "trp_orc_snaga_of_isengard", "trp_uruk_snaga_of_mordor"),
        (neg|eq, ":local0", "trp_wolf_rider_of_isengard"),
        (neg|eq, ":local0", "trp_warg_rider_of_isengard"),
        (neg|eq, ":local0", "trp_white_hand_rider"),
        (neg|eq, ":local0", "trp_warg_rider_of_gorgoroth"),
        (neg|eq, ":local0", "trp_great_warg_rider_of_mordor"),
        (neg|eq, ":local0", "trp_wolf_rider_of_moria"),
        (neg|eq, ":local0", "trp_warg_rider_of_moria"),
        (neg|eq, ":local0", "trp_bolg_clan_rider"),
        (troop_raise_skill, ":local0", 13, 3),
    (try_end),
        (try_for_parties, ":local1"),
        (party_get_template_id, ":local2", ":local1"),
        (this_or_next|eq, ":local2", "pt_mordor_scouts"),
        (this_or_next|eq, ":local2", "pt_mordor_patrol"),
        (this_or_next|eq, ":local2", "pt_small_host_of_mordor"),
        (this_or_next|eq, ":local2", "pt_host_of_mordor"),
        (this_or_next|eq, ":local2", "pt_host_of_udun"),
        (this_or_next|eq, ":local2", "pt_host_of_gorgoroth"),
        (this_or_next|eq, ":local2", "pt_host_of_minas_morgul"),
        (this_or_next|eq, ":local2", "pt_host_of_barad_dur"),
        (this_or_next|eq, ":local2", "pt_mordor_prisoner_train"),
        (this_or_next|eq, ":local2", "pt_mordor_caravan"),
        (this_or_next|eq, ":local2", "pt_moria_scouts"),
        (this_or_next|eq, ":local2", "pt_moria_patrol"),
        (this_or_next|eq, ":local2", "pt_small_host_of_moria"),
        (this_or_next|eq, ":local2", "pt_dol_guldur_scouts"),
        (this_or_next|eq, ":local2", "pt_dol_guldur_patrol"),
        (this_or_next|eq, ":local2", "pt_small_host_of_dol_guldur"),
        (this_or_next|eq, ":local2", "pt_host_of_dol_guldur"),
        (this_or_next|eq, ":local2", "pt_isengard_scouts"),
        (this_or_next|eq, ":local2", "pt_isengard_patrol"),
        (this_or_next|eq, ":local2", "pt_small_host_of_isengard"),
        (this_or_next|eq, ":local2", "pt_host_of_isengard"),
        (this_or_next|eq, ":local2", "pt_isengard_prisoner_train"),
        (this_or_next|eq, ":local2", "pt_isengard_caravan"),
        (this_or_next|eq, ":local2", "pt_tribal_orcs"),
        (this_or_next|eq, ":local2", "pt_tribal_orc_stragglers"),
        (this_or_next|eq, ":local2", "pt_goblin_stragglers"),
        (eq, ":local2", "pt_goblin_raiders"),
        (party_set_morale, ":local1", 80),
    (try_end),
    (assign, "$orc_daylight_penalty_active", 0),
(try_end),
]), 

#script_optional_healing_boost
("optional_healing_boost",[
(neg|eq, "$healing_boost_setting", 0),
(try_begin),
    (store_troop_health, ":hp", "trp_player", 0),
        (try_begin),
        (eq, "$healing_boost_setting", 20),
        (val_mul, ":hp", 10),
        (val_div, ":hp", 8),
        (else_try),
        (eq, "$healing_boost_setting", 10),
        (val_mul, ":hp", 10),
        (val_div, ":hp", 9),
    (try_end),
    (troop_set_health, "trp_player", ":hp"),
(try_end),
(try_for_range, ":troop", companions_begin, companions_end),
    (troop_get_slot, ":local3", ":troop", 0),
    (eq, ":local3", 1),
    (store_troop_health, ":hp", ":troop", 0),
    (neg|ge, ":hp", 100),
        (try_begin),
        (eq, "$healing_boost_setting", 20),
        (val_mul, ":hp", 10),
        (val_div, ":hp", 8),
        (else_try),
        (eq, "$healing_boost_setting", 10),
        (val_mul, ":hp", 10),
        (val_div, ":hp", 9),
    (try_end),
    (troop_set_health, ":troop", ":hp"),
    (str_store_troop_name, s1, ":troop"),
    (display_message, "@{s1}_has_had_his_health_boosted", 0),
(try_end),
]), 


#script_check_agent_armor
("check_agent_armor",[
(check_quest_active|neg, "qst_trait_berserker", 1),
(get_player_agent_no, ":local0"),
(assign, ":local1", 0),
    (try_begin),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_nomad_armor"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_leather_jacket"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_leather_armor"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_scale_armor"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_leather_vest"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_nomad_vest"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_padded_cloth"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_gambeson"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_leather_armor"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_blue_gambeson"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_red_gambeson"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_padded_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_leather_jerkin"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_studded_leather_coat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_heraldric_armor"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_cuir_bouilli"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_mail_shirt"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_haubergeon"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_mail_hauberk"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_fountain_guard_mail"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_eorl_guard_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_thengel_guard_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_gondor_citadel_heavy_mail"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_gondor_citadel_heavy_mail"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_dol_amroth_heavy_mail"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_gondor_hauberk_with_leather_vest"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_rohirrim_heavy_hauberk"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_eorl_guard_scale"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_thengel_guard_scale"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_gondor_hauberk_with_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_rohirrim_hauberk_with_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_dol_amroth_hauberk_with_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_gondor_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_rohan_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_rohirrim_heavy_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_gondor_short_hauberk"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_rohan_short_hauberk"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_dark_rohirrim_scale"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_rohirrim_scale_shirt"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_gondorian_heavy_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_rohirrim_jerkin"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_ranger_jerkin"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_ranger_jerkin_with_cloak"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_rohirrim_light_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_squire_gambeson"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_lossarnach_padded_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_lossarnach_scale"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_lamedon_light_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_lamedon_light_mail"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_lamedon_mail_with_cloak"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_lamedon_noble_hauberk"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_elven_jerkin"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_lothlorien_light_scale"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_lothlorien_scale"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_lothlorien_war_scale"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_woodelf_coat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_woodelf_leather_shirt"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_woodelf_travelling_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_woodelf_war_jerkin"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_woodelf_war_scale"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_woodelf_war_mail"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_arnorian_heavy_mail"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_dunedain_mail_with_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_hauberk_with_brown_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_dunedain_mail_shirt"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_dunedain_jerkin"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_dunedain_mail_with_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_green_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_red_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_yellow_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_blue_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_mordor_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_isengard_surcoat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_rawhide"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_isengard_ring_vest"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_padded_coat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_ragged_mail_b"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_ragged_mail_c"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_uruk_padded_coat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_mail_with_collar"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_mail_with_collar_"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_hauberge"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_hauberge_b"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_studded_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_hauberk"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_hauberk_b"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_heavy_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_orc_heavy_mail"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_udun_war_mail"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_harad_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_harad_mail_shirt"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_harad_scale_lamellar"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_harad_heavy_mail"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_harad_light_cavalry_coat"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_corsair_war_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_corsair_raid_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_corsair_war_hauberk"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_corsair_raid_hauberk"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_assassin_leather"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_woodsman_jerkin"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_dunnish_red_wolf_mail"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_dunnish_hauberk"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_variag_lamellar"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_wainrider_lamellar"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_mithril_hauberk_with_gondor_tabard"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_mithril_hauberk_with_rohan_tabard"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_mithril_shirt_with_gondor_tabard"),
    (agent_has_item_equipped|this_or_next, ":local0", "itm_mithril_shirt_with_rohan_tabard"),
    (agent_has_item_equipped, ":local0", "itm_dragon_scale_of_angmar"),
    (assign, ":local1", 1),
(try_end),
    (try_begin),
    (eq, ":local1", 0),
    (neg|ge, "$berserker_armor_tracking", 2),
    (val_add, "$berserker_armor_tracking", 1),
(try_end),
    (try_begin),
    (eq, ":local1", 0),
    (ge, "$berserker_armor_tracking", 2),
    (val_add, "$trait_check_unarmored_berserker", 1),
    (assign, "$berserker_armor_tracking", 0),
(try_end),
]), 

#script_assemble_pardoned_party
("assemble_pardoned_party",[
(store_script_param_1, ":local0"),
(party_get_num_prisoner_stacks, ":local1", ":local0"),
(assign, ":local2", 0),
(assign, ":local3", 0),
(assign, ":local4", 0),
(assign, ":local5", 0),
(assign, ":local6", 0),
(assign, ":local7", 0),
    (try_for_range_backwards, ":local8", 0, ":local1"),
    (party_prisoner_stack_get_troop_id, ":local9", ":local0", ":local8"),
    (party_prisoner_stack_get_size, ":local10", ":local0", ":local8"),
    (neg|troop_is_hero, ":local9"),
    (store_troop_faction, ":local11", ":local9"),
        (try_begin),
        (eq, ":local11", "fac_dunlanders"),
        (val_add, ":local2", ":local10"),
        (else_try),
        (eq, ":local11", "fac_haradrim"),
        (val_add, ":local3", ":local10"),
        (else_try),
        (eq, ":local11", "fac_easterlings"),
        (val_add, ":local4", ":local10"),
        (else_try),
        (eq, ":local11", "fac_corsairs"),
        (val_add, ":local5", ":local10"),
        (else_try),
        (eq, ":local11", "fac_brigands"),
        (val_add, ":local6", ":local10"),
    (try_end),
(try_end),
    (try_begin),
    (assign, ":local7", 0),
    (val_add, ":local7", ":local4"),
    (val_add, ":local7", ":local3"),
    (val_add, ":local7", ":local5"),
    (val_add, ":local7", ":local6"),
    (neg|ge, ":local7", ":local2"),
    (assign, ":local12", "p_dunlander_camp"),
    (else_try),
    (assign, ":local7", 0),
    (val_add, ":local7", ":local4"),
    (val_add, ":local7", ":local2"),
    (val_add, ":local7", ":local5"),
    (val_add, ":local7", ":local6"),
    (neg|ge, ":local7", ":local3"),
    (assign, ":local12", "p_haradrim_camp"),
    (else_try),
    (assign, ":local7", 0),
    (val_add, ":local7", ":local4"),
    (val_add, ":local7", ":local2"),
    (val_add, ":local7", ":local3"),
    (val_add, ":local7", ":local6"),
    (neg|ge, ":local7", ":local5"),
    (assign, ":local12", "p_corsair_camp"),
    (else_try),
    (assign, ":local7", 0),
    (val_add, ":local7", ":local5"),
    (val_add, ":local7", ":local2"),
    (val_add, ":local7", ":local3"),
    (val_add, ":local7", ":local6"),
    (neg|ge, ":local7", ":local4"),
    (assign, ":local12", "p_easterling_south_camp"),
    (else_try),
    (assign, ":local12", "p_zendar"),
(try_end),
(spawn_around_party, ":local0", "pt_pardoned_evil_men"),
(assign, ":local13", reg0),
(party_get_num_prisoner_stacks, ":local14", ":local0"),
    (try_for_range_backwards, ":local8", 0, ":local14"),
    (party_prisoner_stack_get_troop_id, ":local9", ":local0", ":local8"),
    (store_troop_faction, ":local11", ":local9"),
    (neg|eq, ":local11", ":local15"),
    (neg|eq, ":local11", ":local16"),
    (neg|is_between, "trp_map_heroes_begin", "trp_map_heroes_end", 0),
    (neg|troop_is_hero, ":local9"),
    (party_prisoner_stack_get_size, ":local10", ":local0", ":local8"),
    (party_add_members, ":local13", ":local9", ":local10"),
    (party_remove_prisoners, ":local0", ":local9", ":local10"),
(try_end),
(party_set_ai_object, ":local13", ":local12"),
(party_set_ai_behavior, ":local13", 1),
(party_set_slot, ":local13", 3, ":local12"),
(store_random_in_range, ":local17", 2, 5),
    (try_begin),
    (eq, ":local18", "fac_gondor"),
    (party_add_members, ":local0", "trp_infantry_of_gondor", ":local17"),
    (else_try),
    (eq, ":local18", "fac_rohan"),
    (party_add_members, ":local0", "trp_rider_of_rohan", ":local17"),
(try_end),
(assign, reg0, 0),
(val_add, reg0, ":local3"),
(val_add, reg0, ":local4"),
(val_add, reg0, ":local2"),
(val_add, reg0, ":local5"),
(val_add, reg0, ":local6"),
]), 

#script_map_hero_status_test
("map_hero_status_test",[
(assign, ":local0", 0),
(assign, ":local1", 0),
(assign, ":local2", 0),
(assign, ":local3", 0),
(assign, ":local4", 0),
(assign, ":local5", 0),
(assign, ":local6", 0),
(assign, ":local7", 0),
    (try_for_range, ":local8", "trp_map_heroes_begin", "trp_map_heroes_end"),
    (troop_get_slot, ":local9", ":local8", 0),
        (try_begin),
        (ge, ":local9", 1),
        (val_add, ":local0", 1),
    (try_end),
        (try_begin),
        (eq, ":local9", 5),
        (val_add, ":local1", 1),
    (try_end),
        (try_begin),
        (eq, ":local9", 6),
        (val_add, ":local2", 1),
    (try_end),
        (try_begin),
        (eq, ":local9", 7),
        (val_add, ":local3", 1),
    (try_end),
        (try_begin),
        (eq, ":local9", 8),
        (val_add, ":local4", 1),
    (try_end),
        (try_begin),
        (eq, ":local9", 9),
        (val_add, ":local5", 1),
    (try_end),
        (try_begin),
        (eq, ":local9", 10),
        (val_add, ":local6", 1),
    (try_end),
        (try_begin),
        (eq, ":local9", 11),
        (val_add, ":local7", 1),
    (try_end),
(try_end),
(assign, ":local10", 0),
    (try_for_parties, ":local11"),
    (party_get_num_prisoner_stacks, ":local12", ":local11"),
    (gt, ":local12", 0),
        (try_for_range, ":local8", "trp_map_heroes_begin", "trp_map_heroes_end"),
        (store_troop_count_prisoners, ":local13", ":local8", ":local11"),
        (ge, ":local13", 1),
        (val_add, ":local10", 1),
        (gt, ":local10", "$total_chained_prisoners"),
        (val_add, "$total_chained_prisoners", 1),
    (try_end),
(try_end),
(assign, reg1, ":local0"),
(assign, reg2, ":local1"),
(assign, reg3, ":local2"),
(assign, reg4, ":local3"),
(assign, reg5, ":local4"),
(assign, reg6, ":local5"),
(assign, reg7, ":local6"),
(assign, reg8, ":local7"),
(assign, reg9, "$number_of_heroes_leading_hosts"),
(assign, reg10, "$heroes_captured_by_gondor"),
(assign, reg11, "$heroes_captured_by_rohan"),
(assign, reg12, "$heroes_captured_by_mordor"),
(assign, reg13, "$heroes_captured_by_isengard"),
(assign, reg15, "$total_chained_prisoners"),
(assign, reg16, ":local10"),
(display_message, "@Hero_total-_s:{reg1}/_v:{reg9}", 0),
(display_message, "@Heroes_dead:_{reg2}", 0),
(display_message, "@Hero_cap_s:_g:{reg3},_r:{reg4},_m:{reg5},_i:{reg6},_e:{reg7},_n:{reg8}", 0),
(display_message, "@Hero_cap_v:_g:{reg10},_r:{reg11},_m:{reg12},_i:{reg13}", 0),
(display_message, "@Heroes_chained_current/total:_{reg16}_/_{reg15}", 0),
]), 

#script_party_count_fit_missile_troops
("party_count_fit_missile_troops",[
(store_script_param_1, ":party"),
(party_get_num_companion_stacks, ":local1", ":party"),
(assign, reg0, 0),
(try_for_range, ":local2", 0, ":local1"),
    (party_stack_get_troop_id, ":local3", ":party", ":local2"),
    (neg|troop_is_hero, ":local3"),
    (troop_get_slot, ":local4", ":local3", 6),
    (eq, ":local4", 2),
    (party_stack_get_size, ":local5", ":party", ":local2"),
    (party_stack_get_num_wounded, ":local6", ":party", ":local2"),
    (val_sub, ":local5", ":local6"),
    (val_add, reg0, ":local5"),
(try_end),
]), 

#script_party_count_fit_shock_troops
("party_count_fit_shock_troops",[
(store_script_param_1, ":party"),
(party_get_num_companion_stacks, ":local1", ":party"),
(assign, reg0, 0),
(try_for_range, ":local2", 0, ":local1"),
    (party_stack_get_troop_id, ":local3", ":party", ":local2"),
    (neg|troop_is_hero, ":local3"),
    (troop_get_slot, ":local4", ":local3", 6),
    (eq, ":local4", 3),
    (party_stack_get_size, ":local5", ":party", ":local2"),
    (party_stack_get_num_wounded, ":local6", ":party", ":local2"),
    (val_sub, ":local5", ":local6"),
    (val_add, reg0, ":local5"),
(try_end),
]), 

#script_party_count_fit_melee_troops
("party_count_fit_melee_troops",[
(store_script_param_1, ":party"),
(party_get_num_companion_stacks, ":local1", ":party"),
(assign, reg0, 0),
(try_for_range, ":local2", 0, ":local1"),
    (party_stack_get_troop_id, ":local3", ":party", ":local2"),
    (neg|troop_is_hero, ":local3"),
    (troop_get_slot, ":local4", ":local3", 6),
    (neg|eq, ":local4", 3),
    (neg|eq, ":local4", 2),
    (party_stack_get_size, ":local5", ":party", ":local2"),
    (party_stack_get_num_wounded, ":local6", ":party", ":local2"),
    (val_sub, ":local5", ":local6"),
    (val_add, reg0, ":local5"),
(try_end),
]), 

#script_give_player_orders_to_party
("give_player_orders_to_party",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
    (try_begin),
    (eq, ":local1", 1),
    (party_set_ai_behavior, ":local0", 0),
    (party_set_slot, ":local0", 1, 2),
    (party_set_slot, ":local0", 2, 0),
    (party_set_slot, ":local0", 4, 0),
    (else_try),
    (eq, ":local1", 2),
    (party_set_ai_behavior, ":local0", 4),
    (party_set_ai_object, ":local0", 0),
    (party_set_slot, ":local0", 1, 2),
    (party_set_slot, ":local0", 2, 4),
    (party_set_slot, ":local0", 3, 0),
    (party_set_slot, ":local0", 4, 0),
    (else_try),
    (eq, ":local1", 3),
    (party_set_ai_behavior, ":local0", 1),
    (party_set_ai_object, ":local0", "$travel_orders_destination"),
    (party_set_slot, ":local0", 1, 2),
    (party_set_slot, ":local0", 2, 1),
    (party_set_slot, ":local0", 3, "$travel_orders_destination"),
    (party_set_slot, ":local0", 4, 0),
(try_end),
(val_add, "$trait_check_commands_issued", 1),
]), 

#script_cancel_player_orders_to_party
("cancel_player_orders_to_party",[
(store_script_param_1, ":local0"),
(party_set_slot, ":local0", 1, 0),
(party_set_slot, ":local0", 2, 0),
(party_set_slot, ":local0", 3, 0),
(party_set_slot, ":local1", 4, 0),
(party_set_ai_object, ":local0", 0),
(party_set_ai_behavior, ":local0", 2),
]), 

#script_set_gondor_host_destination
("set_gondor_host_destination",[
(store_script_param_1, ":local0"),
    (try_begin),
    (store_party_size_wo_prisoners, ":local1", ":local0"),
    (neg|ge, ":local1", 40),
    (assign|shuffle_range, reg0, 9, 0),
    (val_add, reg0, "$minas_tirith"),
    (else_try),
    (gt, "$mordor_status", 1),
    (assign|shuffle_range, reg0, 4, 0),
    (val_add, reg0, "p_morannon"),
    (else_try),
    (eq, "$mordor_status", 1),
    (assign, reg0, "$minas_tirith"),
(try_end),
]), 

#script_set_rohan_host_destination
("set_rohan_host_destination",[
(store_script_param_1, ":local0"),
    (try_begin),
    (store_party_size_wo_prisoners, ":local1", ":local0"),
    (neg|ge, ":local1", 40),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "$edoras"),
    (else_try),
    (neg|eq, "$isengard_status", 0),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "p_isengard"),
    (else_try),
    (eq, "$isengard_status", 0),
    (neg|eq, "$gondor_status", 0),
    (assign, reg0, "$minas_tirith"),
    (else_try),
    (eq, "$isengard_status", 0),
    (eq, "$gondor_status", 0),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "$edoras"),
(try_end),
]), 

#script_set_lothlorien_host_destination
("set_lothlorien_host_destination",[
(store_script_param_1, ":local0"),
    (try_begin),
    (store_party_size_wo_prisoners, ":local1", ":local0"),
    (neg|ge, ":local1", 40),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "p_caras_galadhon"),
    (else_try),
    (neg|eq, "$dol_guldur_status", 0),
    (gt, "$dol_guldur_status", 2),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "p_caras_galadhon"),
    (else_try),
    (neg|eq, "$dol_guldur_status", 0),
    (neg|gt, "$dol_guldur_status", 2),
    (assign, reg0, "p_dol_guldur"),
    (else_try),
    (eq, "$dol_guldur_status", 0),
    (neg|eq, "$moria_status", 0),
    (assign, reg0, "p_moria"),
    (else_try),
    (eq, "$elven_dol_guldur_war", 2),
    (neg|eq, "$gondor_status", 0),
    (assign, reg0, "$minas_tirith"),
    (else_try),
    (eq, "$elven_dol_guldur_war", 2),
    (eq, "$gondor_status", 0),
    (neg|eq, "$rohan_status", 0),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "$edoras"),
    (else_try),
    (gt, "$mordor_isengard_war", 0),
    (assign|shuffle_range, reg0, 4, 0),
    (val_add, reg0, "p_morannon"),
(try_end),
]), 

#script_set_isengard_host_destination
("set_isengard_host_destination",[
(store_script_param_1, ":local0"),
    (try_begin),
    (store_party_size_wo_prisoners, ":local1", ":local0"),
    (neg|ge, ":local1", 40),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "p_isengard"),
    (else_try),
    (neg|eq, "$rohan_status", 0),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "$edoras"),
    (else_try),
    (eq, "$rohan_status", 0),
    (neg|eq, "$gondor_status", 0),
    (assign|shuffle_range, reg0, 3, 0),
    (val_add, reg0, "$minas_tirith"),
    (else_try),
    (eq, "$mordor_isengard_war", 1),
    (assign|shuffle_range, reg0, 4, 0),
    (val_add, reg0, "p_morannon"),
    (else_try),
    (eq, "$elven_dol_guldur_war", 2),
    (eq, "$isengard_mordor_war", 2),
    (eq, "$lothlorien_status", 0),
    (eq, "$woodelf_status", 0),
    (eq, "$rivendell_status", 0),
    (assign, reg0, "p_isengard"),
(try_end),
]), 

#script_set_mordor_host_destination
("set_mordor_host_destination",[
(store_script_param_1, ":local0"),
    (try_begin),
    (store_party_size_wo_prisoners, ":local1", ":local0"),
    (neg|ge, ":local1", 40),
    (assign|shuffle_range, reg0, 4, 0),
    (val_add, reg0, "p_morannon"),
    (else_try),
    (neg|eq, "$gondor_status", 0),
    (assign|shuffle_range, reg0, 3, 0),
    (val_add, reg0, "$minas_tirith"),
    (else_try),
    (eq, "$gondor_status", 0),
    (neg|eq, "$rohan_status", 0),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "$edoras"),
    (else_try),
    (eq, "$mordor_isengard_war", 1),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "p_isengard"),
    (else_try),
    (neg|eq, "$lothlorien_status", 0),
    (eq, "$mordor_isengard_war", 2),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "p_caras_galadhon"),
    (else_try),
    (eq, "$lothlorien_status", 0),
    (neg|eq, "$rivendell_status", 0),
    (assign, reg0, "p_rivendell_elf_camp"),
    (else_try),
    (eq, "$lothlorien_status", 0),
    (eq, "$rivendell_status", 0),
    (neg|eq, "$woodelf_status", 0),
    (assign, reg0, "p_woodelf_camp"),
    (else_try),
    (eq, "$elven_dol_guldur_war", 2),
    (eq, "$mordor_isengard_war", 2),
    (eq, "$lothlorien_status", 0),
    (eq, "$woodelf_status", 0),
    (eq, "$rivendell_status", 0),
    (assign, reg0, "p_morannon"),
(try_end),
]), 

#script_set_dol_guldur_host_destination
("set_dol_guldur_host_destination",[
(store_script_param_1, ":local0"),
    (try_begin),
    (store_party_size_wo_prisoners, ":local1", ":local0"),
    (neg|ge, ":local1", 40),
    (assign|shuffle_range, reg0, 1, 0),
    (val_add, reg0, "p_dol_guldur"),
    (else_try),
    (neg|eq, "$elven_dol_guldur_war", 2),
    (neg|eq, "$lothlorien_status", 0),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "p_caras_galadhon"),
    (else_try),
    (neg|eq, "$elven_dol_guldur_war", 2),
    (eq, "$lothlorien_status", 0),
    (neg|eq, "$woodelf_status", 0),
    (assign, reg0, "p_woodelf_camp"),
    (else_try),
    (neg|eq, "$elven_dol_guldur_war", 2),
    (eq, "$lothlorien_status", 0),
    (eq, "$woodelf_status", 0),
    (neg|eq, "$rivendell_status", 0),
    (assign, reg0, "p_rivendell_elf_camp"),
    (else_try),
    (eq, "$elven_dol_guldur_war", 2),
    (neg|eq, "$gondor_status", 0),
    (assign|shuffle_range, reg0, 3, 0),
    (val_add, reg0, "$minas_tirith"),
    (else_try),
    (eq, "$elven_dol_guldur_war", 2),
    (eq, "$gondor_status", 0),
    (neg|eq, "$rohan_status", 0),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "$edoras"),
    (else_try),
    (eq, "$elven_dol_guldur_war", 2),
    (eq, "$mordor_isengaard_war", 1),
    (neg|eq, "$isengard_status", 0),
    (assign|shuffle_range, reg0, 2, 0),
    (val_add, reg0, "p_isengard"),
    (else_try),
    (eq, "$elven_dol_guldur_war", 2),
    (gt, "$mordor_isengaard_war", 0),
    (eq, "$isengard_status", 0),
    (neg|eq, "$moria_status", 0),
    (assign, reg0, "p_moria"),
    (else_try),
    (eq, "$elven_dol_guldur_war", 2),
    (eq, "$mordor_isengaard_war", 2),
    (assign, reg0, "p_dol_guldur"),
(try_end),
]), 

#script_scout_control
("scout_control",[
(store_encountered_party, ":local0"),
(store_faction_of_party, ":local1", ":local0"),
(str_clear, 1),
(str_clear, 2),
(str_clear, 3),
(str_clear, 4),
(str_clear, 5),
(assign, "$enemy_parties_found", 0),
    (try_for_parties, ":local2"),
    (assign, ":local3", 0),
    (assign, ":local4", 0),
    (store_faction_of_party, ":local5", ":local2"),
    (neg|is_between, ":local2", "p_morannon", "p_end_pyres"),
    (party_is_in_any_town|neg, ":local2"),
        (try_begin),
        (ge, "$faction_gondor_member_status", 2),
        (this_or_next|eq, ":local5", "fac_mordor"),
        (this_or_next|eq, ":local5", "fac_isengard"),
        (this_or_next|eq, ":local5", "fac_mordor_caravans"),
        (this_or_next|eq, ":local5", "fac_isengard_caravans"),
        (this_or_next|eq, ":local5", "fac_mountain_goblins"),
        (this_or_next|eq, ":local5", "fac_tribal_orcs"),
        (this_or_next|eq, ":local5", "fac_haradrim"),
        (this_or_next|eq, ":local5", "fac_dunlanders"),
        (this_or_next|eq, ":local5", "fac_easterlings"),
        (this_or_next|eq, ":local5", "fac_corsairs"),
        (this_or_next|eq, ":local5", "fac_brigands"),
        (this_or_next|eq, ":local5", "fac_deserters_of_mordor"),
        (eq, ":local5", "fac_deserters_of_isengard"),
        (assign, ":local4", 1),
        (else_try),
        (eq, "$mordor_isengard_war", 0),
        (ge, "$faction_mordor_member_status", 2),
        (this_or_next|eq, ":local5", "fac_gondor"),
        (this_or_next|eq, ":local5", "fac_rohan"),
        (this_or_next|eq, ":local5", "fac_lothlorien"),
        (this_or_next|eq, ":local5", "fac_woodelves"),
        (this_or_next|eq, ":local5", "fac_imladris"),
        (this_or_next|eq, ":local5", "fac_tribal_orcs"),
        (this_or_next|eq, ":local5", "fac_brigands"),
        (this_or_next|eq, ":local5", "fac_deserters_of_mordor"),
        (eq, ":local5", "fac_deserters_of_isengard"),
        (assign, ":local4", 1),
        (else_try),
        (eq, "$mordor_isengard_war", 1),
        (eq, "$faction_mordor_member_status", 3),
        (this_or_next|eq, ":local5", "fac_isengard"),
        (this_or_next|eq, ":local5", "fac_isengard_caravans"),
        (this_or_next|eq, ":local5", "fac_dunlanders"),
        (this_or_next|eq, ":local5", "fac_gondor"),
        (this_or_next|eq, ":local5", "fac_rohan"),
        (this_or_next|eq, ":local5", "fac_lothlorien"),
        (this_or_next|eq, ":local5", "fac_woodelves"),
        (this_or_next|eq, ":local5", "fac_imladris"),
        (this_or_next|eq, ":local5", "fac_tribal_orcs"),
        (this_or_next|eq, ":local5", "fac_brigands"),
        (this_or_next|eq, ":local5", "fac_deserters_of_mordor"),
        (eq, ":local5", "fac_deserters_of_isengard"),
        (assign, ":local4", 1),
        (else_try),
        (eq, "$mordor_isengard_war", 1),
        (eq, "$faction_isengard_member_status", 3),
        (this_or_next|eq, ":local5", "fac_mordor"),
        (this_or_next|eq, ":local5", "fac_mordor_caravans"),
        (this_or_next|eq, ":local5", "fac_haradrim"),
        (this_or_next|eq, ":local5", "fac_easterlings"),
        (this_or_next|eq, ":local5", "fac_corsairs"),
        (this_or_next|eq, ":local5", "fac_gondor"),
        (this_or_next|eq, ":local5", "fac_rohan"),
        (this_or_next|eq, ":local5", "fac_lothlorien"),
        (this_or_next|eq, ":local5", "fac_woodelves"),
        (this_or_next|eq, ":local5", "fac_imladris"),
        (this_or_next|eq, ":local5", "fac_tribal_orcs"),
        (this_or_next|eq, ":local5", "fac_brigands"),
        (this_or_next|eq, ":local5", "fac_deserters_of_mordor"),
        (eq, ":local5", "fac_deserters_of_isengard"),
        (assign, ":local4", 1),
    (try_end),
    (eq, ":local4", 1),
    (store_distance_to_party_from_party, ":local6", ":local2", ":local0"),
    (party_get_template_id, ":local7", ":local0"),
        (try_begin),
        (this_or_next|eq, ":local7", "pt_ithilien_rangers"),
        (this_or_next|eq, ":local1", "fac_lothlorien"),
        (this_or_next|eq, ":local1", "fac_woodelves"),
        (eq, ":local1", "fac_imladris"),
        (assign, ":local8", 50),
        (assign, ":local9", 18),
        (else_try),
        (this_or_next|eq, ":local7", "pt_mordor_scouts"),
        (this_or_next|eq, ":local7", "pt_rohan_scouts"),
        (this_or_next|eq, ":local7", "pt_gondor_scouts"),
        (this_or_next|eq, ":local7", "pt_isengard_scouts"),
        (this_or_next|eq, ":local7", "pt_dol_guldur_scouts"),
        (eq, ":local7", "pt_moria_scouts"),
        (assign, ":local8", 35),
        (assign, ":local9", 12),
        (else_try),
        (assign, ":local8", 18),
        (assign, ":local9", 8),
    (try_end),
        (try_begin),
        (neg|gt, ":local6", 3),
        (assign, ":local3", 1),
        (else_try),
        (gt, ":local6", 3),
        (neg|gt, ":local6", ":local9"),
        (assign|shuffle_range, ":local10", 100, 0),
        (neg|ge, ":local10", ":local8"),
        (assign, ":local3", 1),
    (try_end),
    (eq, ":local3", 1),
        (try_begin),
        (neg|ge, "$enemy_parties_found", 1),
        (str_store_party_name, 1, ":local2"),
        (call_script, "script_ping_distance", ":local2", ":local0"),
        (str_store_string, 11, reg0),
        (else_try),
        (neg|ge, "$enemy_parties_found", 2),
        (str_store_party_name, 2, ":local2"),
        (call_script, "script_ping_distance", ":local2", ":local0"),
        (str_store_string, 12, reg0),
        (else_try),
        (neg|ge, "$enemy_parties_found", 3),
        (str_store_party_name, 3, ":local2"),
        (call_script, "script_ping_distance", ":local2", ":local0"),
        (str_store_string, 13, reg0),
        (else_try),
        (neg|ge, "$enemy_parties_found", 4),
        (str_store_party_name, 4, ":local2"),
        (call_script, "script_ping_distance", ":local2", ":local0"),
        (str_store_string, 14, reg0),
        (else_try),
        (neg|ge, "$enemy_parties_found", 5),
        (str_store_party_name, 5, ":local2"),
        (call_script, "script_ping_distance", ":local2", ":local0"),
        (str_store_string, 15, reg0),
    (try_end),
    (val_add, "$enemy_parties_found", 1),
(try_end),
]), 

#script_ping_distance
("ping_distance",[
(store_script_param_1, ":local0"),
(store_script_param_2, ":local1"),
(store_distance_to_party_from_party, ":local2", ":local1", "p_west_point"),
(store_distance_to_party_from_party, ":local3", ":local1", "p_north_point"),
(store_distance_to_party_from_party, ":local4", ":local0", "p_west_point"),
(store_distance_to_party_from_party, ":local5", ":local0", "p_north_point"),
(try_begin),
    (neg|ge, ":local5", ":local3"),
    (val_sub, ":local3", ":local5"),
    (assign, ":local6", ":local3"),
    (assign, ":local7", 0),
  (else_try),
    (gt, ":local5", ":local3"),
    (val_sub, ":local5", ":local3"),
    (assign, ":local6", ":local5"),
    (assign, ":local7", 1),
(try_end),
(try_begin),
    (neg|ge, ":local4", ":local2"),
    (val_sub, ":local2", ":local4"),
    (assign, ":local8", ":local2"),
    (assign, ":local9", 2),
  (else_try),
    (gt, ":local4", ":local2"),
    (val_sub, ":local4", ":local2"),
    (assign, ":local8", ":local4"),
    (assign, ":local9", 3),
(try_end),
(try_begin),
    (gt, ":local8", ":local6"),
    (gt, ":local8", 2),
    (assign, reg0, ":local9"),
  (else_try),
    (ge, ":local6", ":local8"),
    (gt, ":local6", 2),
    (assign, reg0, ":local7"),
  (else_try),
    (assign, reg0, 4),
(try_end),
(val_add, reg0, "@to_the_north"),
]), 

#script_generate_news
("generate_news",[
(store_script_param_1, ":local0"),
(store_encountered_party, ":local1"),
(store_faction_of_party, ":local2", ":local1"),
(assign, reg0, 1),
    (try_begin),
    (eq, ":local0", 0),
    (store_faction_of_party, ":local2", ":local1"),
    (assign|shuffle_range, ":local3", 13, 0),
        (try_begin),
        (eq, ":local3", 0),
        (store_add, "$gondor_current_status", "@crushed", "$gondor_status"),
        (str_store_faction_name, 1, "fac_gondor"),
        (str_store_string, 2, "$gondor_current_status"),
        (assign, ":local4", "fac_gondor"),
        (else_try),
        (eq, ":local3", 1),
        (store_add, "$rohan_current_status", "@crushed", "$rohan_status"),
        (str_store_faction_name, 1, "fac_rohan"),
        (str_store_string, 2, "$rohan_current_status"),
        (assign, ":local4", "fac_rohan"),
        (else_try),
        (eq, ":local3", 2),
        (store_add, "$mordor_current_status", "@crushed", "$mordor_status"),
        (str_store_faction_name, 1, "fac_mordor"),
        (str_store_string, 2, "$mordor_current_status"),
        (assign, ":local4", "fac_mordor"),
        (else_try),
        (eq, ":local3", 3),
        (store_add, "$isengard_current_status", "@crushed", "$isengard_status"),
        (str_store_faction_name, 1, "fac_isengard"),
        (str_store_string, 2, "$isengard_current_status"),
        (assign, ":local4", "fac_isengard"),
        (else_try),
        (eq, ":local3", 4),
        (store_add, "$dunlander_current_status", "@crushed", "$dunlander_status"),
        (str_store_faction_name, 1, "fac_dunlanders"),
        (str_store_string, 2, "$dunlander_current_status"),
        (assign, ":local4", "fac_dunlanders"),
        (else_try),
        (eq, ":local3", 5),
        (store_add, "$haradrim_current_status", "@crushed", "$haradrim_status"),
        (str_store_faction_name, 1, "fac_haradrim"),
        (str_store_string, 2, "$haradrim_current_status"),
        (assign, ":local4", "fac_haradrim"),
        (else_try),
        (eq, ":local3", 6),
        (store_add, "$easterling_current_status", "@crushed", "$easterling_status"),
        (str_store_faction_name, 1, "fac_easterlings"),
        (str_store_string, 2, "$easterling_current_status"),
        (assign, ":local4", "fac_easterlings"),
        (else_try),
        (eq, ":local3", 7),
        (store_add, "$corsairs_current_status", "@crushed", "$corsair_status"),
        (str_store_faction_name, 1, "fac_corsairs"),
        (str_store_string, 2, "$corsairs_current_status"),
        (assign, ":local4", "fac_corsairs"),
        (else_try),
        (eq, ":local3", 8),
        (store_add, "$lothlorien_current_status", "@crushed", "$lothlorien_status"),
        (str_store_faction_name, 1, "fac_lothlorien"),
        (str_store_string, 2, "$lothlorien_current_status"),
        (assign, ":local4", "fac_lothlorien"),
        (else_try),
        (eq, ":local3", 9),
        (store_add, "$rivendell_current_status", "@crushed", "$rivendell_status"),
        (str_store_faction_name, 1, "fac_imladris"),
        (str_store_string, 2, "$rivendell_current_status"),
        (assign, ":local4", "fac_imladris"),
        (else_try),
        (eq, ":local3", 10),
        (store_add, "$woodelves_current_status", "@crushed", "$woodelves_status"),
        (str_store_faction_name, 1, "fac_woodelves"),
        (str_store_string, 2, "$woodelves_current_status"),
        (assign, ":local4", "fac_woodelves"),
        (else_try),
        (eq, ":local3", 11),
        (store_add, "$moria_current_status", "@crushed", "$moria_status"),
        (str_store_faction_name, 1, "fac_moria"),
        (str_store_string, 2, "$moria_current_status"),
        (assign, ":local4", "fac_moria"),
        (else_try),
        (eq, ":local3", 12),
        (store_add, "$dol_guldur_current_status", "@crushed", "$dol_guldur_status"),
        (str_store_faction_name, 1, "fac_dol_guldur"),
        (str_store_string, 2, "$dol_guldur_current_status"),
        (assign, ":local4", "fac_dol_guldur"),
    (try_end),
        (try_begin),
        (eq, ":local4", ":local2"),
        (assign, reg0, 0),
    (try_end),
    (else_try),
    (eq, ":local0", 1),
    (assign, reg0, 0),
    (assign|shuffle_range, ":local3", 6, 0),
        (try_begin),
        (eq, ":local3", 0),
        (assign, ":local5", "pt_host_of_gondor"),
        (else_try),
        (eq, ":local3", 1),
        (assign, ":local5", "pt_host_of_rohan"),
        (else_try),
        (eq, ":local3", 2),
        (assign, ":local5", "pt_host_of_mordor"),
        (else_try),
        (eq, ":local3", 3),
        (assign, ":local5", "pt_host_of_isengard"),
        (else_try),
        (eq, ":local3", 4),
        (assign, ":local5", "pt_host_of_dol_guldur"),
        (else_try),
        (eq, ":local3", 5),
        (assign, ":local5", "pt_host_of_lothlorien"),
    (try_end),
        (try_for_parties, ":local6"),
        (party_get_template_id, ":local7", ":local6"),
        (eq, ":local7", ":local5"),
        (party_get_slot, ":local8", ":local6", 1),
        (eq, ":local8", 1),
        (party_get_slot, ":local9", ":local6", 3),
        (str_store_party_name, 1, ":local6"),
        (str_store_party_name, 2, ":local9"),
        (assign, reg0, 1),
    (try_end),
    (else_try),
    (eq, ":local0", 2),
    (assign, reg0, 0),
    (assign, ":local10", 0),
        (try_for_range, reg12, 0, 20),
        (troop_set_slot, "trp_temp_array_a", reg12, 0),
    (try_end),
        (try_for_range, ":local11", "trp_map_heroes_begin", "trp_map_heroes_end"),
        (neg|ge, ":local10", 20),
        (troop_get_slot, ":local12", ":local11", 0),
        (eq, ":local12", 5),
        (troop_set_slot, "trp_temp_array_a", ":local10", ":local11"),
        (val_add, ":local10", 1),
    (try_end),
    (assign, "$pin_troop", "trp_temp_array_a"),
    (call_script, "script_shuffle_troop_slots", 0, ":local10"),
    (troop_get_slot, ":local13", "trp_temp_array_a", 0),
    (neg|eq, ":local13", 0),
    (assign, reg0, 1),
    (store_troop_faction, ":local14", ":local13"),
    (str_store_troop_name, 1, ":local13"),
    (str_store_faction_name, 2, ":local14"),
    (else_try),
    (eq, ":local0", 3),
    (assign, reg0, 0),
    (assign, ":local10", 0),
        (try_for_range, reg12, 0, 20),
        (troop_set_slot, "trp_temp_array_a", reg12, 0),
    (try_end),
        (try_for_range, ":local11", "trp_map_heroes_begin", "trp_map_heroes_end"),
        (neg|ge, ":local10", 20),
        (troop_get_slot, ":local12", ":local11", 0),
        (ge, ":local12", 6),
        (troop_set_slot, "trp_temp_array_a", ":local10", ":local11"),
        (val_add, ":local10", 1),
    (try_end),
    (assign, "$pin_troop", "trp_temp_array_a"),
    (call_script, "script_shuffle_troop_slots", 0, ":local10"),
    (troop_get_slot, ":local13", "trp_temp_array_a", 0),
    (neg|eq, ":local13", 0),
    (assign, reg0, 1),
    (store_troop_faction, ":local14", ":local13"),
    (troop_get_slot, ":local12", ":local13", 0),
        (try_begin),
        (eq, ":local12", 6),
        (assign, ":local15", "fac_gondor"),
        (else_try),
        (eq, ":local12", 7),
        (assign, ":local15", "fac_rohan"),
        (else_try),
        (eq, ":local12", 8),
        (assign, ":local15", "fac_mordor"),
        (else_try),
        (eq, ":local12", 9),
        (assign, ":local15", "fac_isengard"),
        (else_try),
        (eq, ":local12", 10),
        (assign, ":local15", "fac_lothlorien"),
        (else_try),
        (eq, ":local12", 11),
        (assign, ":local15", "fac_outlaws"),
    (try_end),
    (str_store_troop_name, 1, ":local13"),
    (str_store_faction_name, 2, ":local14"),
    (str_store_faction_name, 3, ":local15"),
    (assign, reg0, 1),
    (else_try),
    (eq, ":local0", 4),
    (assign, reg0, 0),
    (assign, ":local10", 0),
        (try_for_range, reg12, 0, 20),
        (troop_set_slot, "trp_temp_array_a", reg12, 0),
    (try_end),
        (try_for_range, ":local11", "trp_map_heroes_begin", "trp_map_heroes_end"),
        (neg|ge, ":local10", 20),
        (troop_get_slot, ":local12", ":local11", 0),
        (eq, ":local12", 2),
        (troop_set_slot, "trp_temp_array_a", ":local10", ":local11"),
        (val_add, ":local10", 1),
    (try_end),
    (assign, "$pin_troop", "trp_temp_array_a"),
    (call_script, "script_shuffle_troop_slots", 0, ":local10"),
    (troop_get_slot, ":local13", "trp_temp_array_a", 0),
    (neg|eq, ":local13", 0),
    (assign, reg0, 1),
    (store_troop_faction, ":local14", ":local13"),
    (str_store_troop_name, 1, ":local13"),
    (str_store_faction_name, 2, ":local14"),
(try_end),
]),

]